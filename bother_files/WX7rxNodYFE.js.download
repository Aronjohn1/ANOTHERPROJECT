;/*FB_PKG_DELIM*/

__d("WAParsableWapNode",["WABinary","WAJids","WALogger","WALongInt","WAParsableXmlNode","WASignalKeys","WATimeUtils","WAWap","WAWapJid","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["ParsableWapNode: attrFromJid() is called with ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["ParsableWapNode: attrFromJid() is called with ",""]);i=function(){return a};return a}var j=function(b){babelHelpers.inheritsLoose(a,b);function a(a,c){var d;d=b.call(this,"XmppParsingFailure: "+a+": "+c)||this;d.name="XmppParsingFailure";d.parser=a;d.reason=c;return d}var c=a.prototype;c.toString=function(){return"XmppParsingFailure: "+this.parser+": "+this.reason};return a}(babelHelpers.wrapNativeSuper(Error));a=function(a){babelHelpers.inheritsLoose(b,a);function b(b,c){return a.call(this,b,c)||this}var e=b.prototype;e.assertFromServer=function(){var a=this.attrString("from");a!==d("WAJids").WA_SERVER_JID_SUFFIX&&this["throw"]('to have "from"="s.whatsapp.net", but instead has "'+a+'"')};e.attrUserJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);return c.userJid==null?this["throw"]('to have "'+a+'"={UserJid}, but instead has "'+b+'"'):c.userJid};e.attrPhoneUserJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);return c.jidType==="phoneUser"?c.userJid:this["throw"]('to have "'+a+'"={PhoneUserJid}, but instead has "'+b+'"')};e.attrLidUserJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);return c.jidType==="lidUser"?c.userJid:this["throw"]('to have "'+a+'"={LidUserJid}, but instead has "'+b+'"')};e.maybeAttrUserJid=function(a){return this.hasAttr(a)?this.attrUserJid(a):null};e.maybeAttrPhoneUserJid=function(a){return this.hasAttr(a)?this.attrPhoneUserJid(a):null};e.maybeAttrLidUserJid=function(a){return this.hasAttr(a)?this.attrLidUserJid(a):null};e.attrGroupJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);return c.groupJid==null?this["throw"]('to have "'+a+'"={GroupJid}, but instead has "'+b+'"'):c.groupJid};e.maybeAttrGroupJid=function(a){return this.hasAttr(a)?this.attrGroupJid(a):null};e.attrChatJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);if(c.userJid!=null)return c.userJid;return c.groupJid!=null?c.groupJid:this["throw"]('to have "'+a+'"={ChatJid}, but instead has "'+b+'"')};e.attrPhoneChatJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);if(c.jidType==="phoneUser")return c.userJid;else if(c.jidType==="group")return c.groupJid;else return this["throw"]('to have "'+a+'"={ChatJid}, but instead has "'+b+'"')};e.attrDeviceJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);if(c.deviceJid!=null)return c.deviceJid;if(c.userJid!=null)return d("WAJids").defaultDeviceJidForUser(c.userJid);if(c.hostedDeviceJid!=null)return c.hostedDeviceJid;return c.hostedLidDeviceJid!=null?c.hostedLidDeviceJid:this["throw"]('to have "'+a+'"={DeviceJid}, but instead has "'+b+'"')};e.attrPhoneDeviceJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);if(c.jidType==="phoneDevice")return c.deviceJid;return c.jidType==="phoneUser"?d("WAJids").defaultPhoneDeviceJidForUser(c.userJid):this["throw"]('to have "'+a+'"={PhoneDeviceJid}, but instead has "'+b+'"')};e.attrLidDeviceJid=function(a){var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);if(c.jidType==="lidDevice")return c.deviceJid;return c.jidType==="lidUser"?d("WAJids").defaultLidDeviceJidForLidUserJid(c.userJid):this["throw"]('to have "'+a+'"={LidDeviceJid}, but instead has "'+b+'"')};e.attrDeviceId=function(a){a=this.attrInt(a);return d("WAJids").interpretAsDeviceId(a)};e.attrFromJidChat=function(){var a=this.attrJidWithType();switch(a.jidType){case"msgrUser":var b=a.userJid,e=d("WAJids").defaultDeviceJidForUser(b);return{type:"device",chat:b,deviceJid:e,author:e};case"interopUser":b=a.userJid;e=d("WAJids").defaultDeviceJidForUser(b);return{type:"device",chat:b,deviceJid:e,author:e};case"phoneUser":b=a.userJid;e=d("WAJids").defaultDeviceJidForUser(b);return{type:"device",chat:b,deviceJid:e,author:e};case"lidUser":b=a.userJid;e=d("WAJids").defaultLidDeviceJidForLidUserJid(b);return{type:"device",chat:b,deviceJid:e,author:e};case"phoneDevice":b=a.deviceJid;return{type:"device",chat:d("WAJids").extractUserJid(b),deviceJid:b,author:b};case"msgrDevice":e=a.deviceJid;return{type:"device",chat:d("WAJids").extractUserJid(e),deviceJid:e,author:e};case"interopDevice":b=a.deviceJid;return{type:"device",chat:d("WAJids").extractUserJid(b),deviceJid:b,author:b};case"lidDevice":e=a.deviceJid;return{type:"device",chat:d("WAJids").extractUserJid(e),deviceJid:e,author:e};case"group":b=this.hasAttr("participant")?this.attrDeviceJid("participant"):null;return b==null?this["throw"]("expected to have participant JID for group"):{type:"group",chat:a.groupJid,groupJid:a.groupJid,author:b};case"broadcast":e=this.hasAttr("participant")?this.attrDeviceJid("participant"):null;return e==null?this["throw"]("expected to have participant JID for group"):{type:"broadcast",broadcastJid:a.broadcastJid,chat:d("WAJids").extractUserJid(e),author:e};case"hosted":b=a.hostedDeviceJid;return{type:"device",chat:d("WAJids").extractUserJid(b),deviceJid:b,author:b};case"hostedLid":e=a.hostedLidDeviceJid;return{type:"device",chat:d("WAJids").extractUserJid(e),deviceJid:e,author:e};case"call":d("WALogger").ERROR(i(),a.callJid);throw c("err")("ParsableWapNode: attrFromJid() does not support CallJid");default:a.jidType;return this["throw"]("attrFromJidChat should not be used with jid of type "+a.jidType)}};e.attrFromJidPhoneChat=function(){var a=this.attrJidWithType();switch(a.jidType){case"phoneUser":var b=a.userJid,e=d("WAJids").defaultPhoneDeviceJidForUser(b);return{type:"device",chat:b,deviceJid:e,author:e};case"phoneDevice":b=a.deviceJid;return{type:"device",chat:d("WAJids").extractPhoneUserJid(b),deviceJid:b,author:b};case"group":e=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return e==null?this["throw"]("expected to have participant JID for group"):{type:"group",chat:a.groupJid,groupJid:a.groupJid,author:e};case"broadcast":b=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return b==null?this["throw"]("expected to have participant JID for group"):{type:"broadcast",broadcastJid:a.broadcastJid,chat:d("WAJids").extractPhoneUserJid(b),author:b};case"call":d("WALogger").ERROR(h(),a.callJid);throw c("err")("ParsableWapNode: attrFromJid() does not support CallJid");default:a.jidType;return this["throw"]("attrFromJidChat should not be used with jid of type "+a.jidType)}};e.attrFromPhoneJid=function(){var a=this.attrJidWithType();if(a.jidType==="status"){a=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return a==null?this["throw"]("to have participant for status msg"):{type:"status",author:a}}else return this.attrFromJidPhoneChat()};e.attrFromJid=function(){var a=this.attrJidWithType();if(a.jidType==="status"){var b=this.hasAttr("participant")?this.attrPhoneDeviceJid("participant"):null;return b==null?this["throw"]("to have participant for status msg"):{type:"status",author:b}}if(a.jidType==="newsletter")return{type:"newsletter",newsletterJid:a.newsletterJid};if(a.jidType==="hosted")return{type:"hosted",hostedDeviceJid:a.hostedDeviceJid};return a.jidType==="hostedLid"?{type:"hostedLid",hostedLidDeviceJid:a.hostedLidDeviceJid}:this.attrFromJidChat()};e.attrJidWithType=function(a){a===void 0&&(a="from");var b=this.attrString(a),c=d("WAJids").interpretAndValidateJid(b);return c.jidType==="unknown"?this["throw"]('to have "'+a+'"={Jid}, but instead has "'+b+'"'):c};e.attrWapJid=function(a){a===void 0&&(a="from");a=this.attrString(a);var b=d("WAJids").interpretAndValidateJid(a);return b.jidType==="unknown"?d("WAWapJid").WapJid.create(null,a):d("WAWap").JID(d("WAJids").extractFromJid(b))};e.attrLongInt=function(a){a=this.attrString(a);return d("WALongInt").decimalStringToLongInt(a)};e.attrTime=function(a){return d("WATimeUtils").castToUnixTime(this.attrInt(a))};e.attrFutureTime=function(a){a=this.attrInt(a);return d("WATimeUtils").futureUnixTime(a)};e.contentString=function(){if(this.hasChildren())return this["throw"]("to have string content, but has children instead");else if(this.hasContent()){var a=new(d("WABinary").Binary)(this.contentBytes());return a.readString(a.size())}else return this["throw"]("to have content")};e.decodeAsString=function(a){return d("WAWap").decodeAsString(a)};e.contentSerializedPubKey=function(){if(this.hasContent())return d("WASignalKeys").serializeIdentity(this.contentBytes());else return this["throw"]("to have content")};e.createParseError=function(a){return new j(this.name(),"expected <"+this.tag()+"> "+a)};e["throw"]=function(a){throw this.createParseError(a)};return b}(d("WAParsableXmlNode").ParsableXmlNode);g.XmppParsingFailure=j;g.ParsableWapNode=a}),98);
__d("WADeprecatedWapParser",["WAParsableWapNode","err"],(function(a,b,c,d,e,f,g){"use strict";a=function(){function a(a,b){this.$1=a,this.$2=b}var b=a.prototype;b.parse=function(a){a=new(d("WAParsableWapNode").ParsableWapNode)(this.$1,a);try{return{success:this.$2(a)}}catch(a){if(a instanceof d("WAParsableWapNode").XmppParsingFailure)return{error:a};else throw a}};b.parseOrThrow=function(a){a=this.parse(a);if(a.error)throw c("err")(String(a.error));return a.success};return a}();g["default"]=a}),98);
__d("WAAckParser",["WADeprecatedWapParser","WAJids"],(function(a,b,c,d,e,f,g){"use strict";b=new(c("WADeprecatedWapParser"))("ack",function(a){a.assertTag("ack");return{id:a.attrString("id"),ts:a.maybeAttrString("t"),"class":a.attrString("class"),type:a.maybeAttrString("type"),from:a.attrJidWithType(),participant:a.hasAttr("participant")?a.attrDeviceJid("participant"):null,recipient:a.hasAttr("recipient")?a.attrUserJid("recipient"):null}});function a(a,b){return a.id===b.id&&(b["class"]===void 0||a["class"]===b["class"])&&(b.type===void 0||a.type===b.type)&&(b.from===void 0||h(a.from,b.from))&&(b.participant===void 0||a.participant===b.participant)&&(b.recipient===void 0||a.recipient===b.recipient)&&(b.ts===void 0||a.ts===b.ts)}function h(a,b){if(d("WAJids").extractFromJid(a)===b)return!0;if(a.userJid!=null)return d("WAJids").defaultDeviceJidForUser(a.userJid)===b;if(a.deviceJid!=null){a=a.deviceJid;return d("WAJids").extractDeviceId(a)===0&&d("WAJids").extractUserJid(a)===b}return!1}g.AckParser=b;g.ackMatchesTemplate=a;g.fromJidsAreEqual=h}),98);
__d("WAAlignChunkLengthsToMultipleOfAesBlockSize",[],(function(a,b,c,d,e,f){"use strict";function g(a){return parseInt((a+15)/16,10)*16}function a(a,b){var c=[],d=0,e=0,f=0;for(var h=0;h<a.length;++h){d+=a[h];if(h===a.length-1&&b!=null&&b>0){d>e?c.push(b-e):(c.pop(),c.push(b-f));break}else if(d>e){var i=g(d-e);f=e;c.push(i);e+=i}}return c}f.alignChunkSizeToMultipleAesBlockSize=g;f.alignChunkLengthsToMultipleOfAesBlockSize=a}),66);
__d("WAConcurrentIterate",["Promise","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f){"use strict";var g;function a(a,c,d){var e=[],f=[],h=0,i=function(){var d=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){while(h<a){var b=h;h++;f[b]=(yield c(b))}});return function(){return d.apply(this,arguments)}}();d=Math.min(a,d);for(var j=0;j<d;j++)e.push(i());return(g||(g=b("Promise"))).all(e).then(function(){return f})}f.concurrentIterate=a}),66);
__d("WADecimalStringMod",["WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(['"','" is over 64 bits']);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(['"','" is not a valid decimal string']);i=function(){return a};return a}function a(a,b){if(!/^\d+$/.test(a)){d("WALogger").ERROR(i(),a);throw c("err")("decimalStringMod is given an invalid decimal string")}var e=a.length;if(e<16||e===16&&a<="9007199254740991")return Number(a)%b;if(e>20||e===20&&a>"18446744073709551615"){d("WALogger").ERROR(h(),a);throw c("err")("decimalStringMod is given value over 64 bits")}e=0;for(var f=0;f<a.length;f++){var g=Number(a[f]);e=(e*10+g)%b}return e}g.decimalStringMod=a}),98);
__d("WACreateGetVcaEnabledBucket",["WAArrayBufferUtils","WADecimalStringMod","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["mediaRouteSelection: can't get fbId from mediaDirectPath"]);h=function(){return a};return a}function a(a,b){return function(){return b==null?null:d("WAArrayBufferUtils").arrayBufferMod(a,b)+100}}function b(a,b){return function(){if(b==null)return null;var c=a.split("/");c=c[c.length-1];c=c.split("_")[1];if(!/^\d+$/.test(c))return null;if(c==null){d("WALogger").ERROR(h());return null}else return d("WADecimalStringMod").decimalStringMod(c,b)+100}}g.createGetVcaEnabledBucket=a;g.msgrCreateGetVcaEnabledBucket=b}),98);
__d("WATypedArraysConcat",[],(function(a,b,c,d,e,f){"use strict";function a(a,b,c){c===void 0&&(c=0);c=b.reduce(function(a,b){return a+b.length},c);var d=new a(c),e=0;b.forEach(function(a){d.set(a,e),e+=a.length});return d}f.concatTypedArrays=a}),66);
__d("WACryptoAesCbc",["Promise","WABinary","WACryptoDependencies","WATypedArraysCast","WATypedArraysConcat","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i=16,j=1024,k=16,l=1024*1024,m=i*l;l=function(){function a(a,b,c,e){this.$4=null;this.$6=!1;this.$1=a;this.$2=b;this.$3=c;var f={name:"AES-CBC",iv:e};this.$5=d("WACryptoDependencies").getCrypto().subtle.importKey("raw",c,"AES-CBC",!1,[b]).then(function(a){return{algo:f,key:a}})}var b=a.prototype;b.append=function(a){var b=this;this.$7("append");var c=this.$4;if(c){c.writeByteArray(a);if(c.size()>j){var e=c.size()%i;e=c.readByteArray(c.size()-e);c.size()||(this.$4=null)}else e=null}else if(a.length>j){c=a.length%i;!c?e=a:(this.$4=new(d("WABinary").Binary)(a),e=this.$4.readByteArray(a.length-c))}else this.$4=new(d("WABinary").Binary)(a),e=null;var f=e;f&&(this.$5=this.$5.then(function(a){var c=a.key;a=a.algo;if(b.$2==="encrypt")return d("WACryptoDependencies").getCrypto().subtle.encrypt(a,c,f).then(function(a){b.$1.writeByteArray(new Uint8Array(a,0,a.byteLength-i));return new Uint8Array(a,a.byteLength-2*i,i)});else{var e=f.slice(-i);return d("WACryptoDependencies").getCrypto().subtle.decrypt(a,c,f).then(function(a){b.$1.writeBuffer(a);return e})}}).then(function(a){var c={name:"AES-CBC",iv:a};return d("WACryptoDependencies").getCrypto().subtle.importKey("raw",b.$3,"AES-CBC",!1,[b.$2]).then(function(a){return{algo:c,key:a}})}));return this.$5.then(function(){})};b.finalize=function(a){var b=this;this.$7("finalize");var c;if(this.$4){var e=this.$4;a&&e.writeByteArray(a);c=e.readByteArray();this.$4=null}else a&&(c=a);if(c){var f=c;return this.$5.then(function(a){var c=a.algo;a=a.key;if(b.$2==="encrypt")return d("WACryptoDependencies").getCrypto().subtle.encrypt(c,a,f);else return d("WACryptoDependencies").getCrypto().subtle.decrypt(c,a,f)}).then(function(a){b.$1.writeBuffer(a)})}else return this.$5.then(function(){})};b.$7=function(a){if(this.$6)throw c("err")("AesCbcStream."+a+" called after finalize")};return a}();function n(a){return{name:"AES-CBC",iv:d("WATypedArraysCast").castTypedArrays(Uint8Array,a)}}function o(a){return d("WACryptoDependencies").getCrypto().subtle.importKey("raw",d("WATypedArraysCast").castTypedArrays(Uint8Array,a),"AES-CBC",!1,["encrypt"])}function p(a){if(a)return d("WATypedArraysCast").castTypedArrays(Uint8Array,a);a=new Uint8Array(k);d("WACryptoDependencies").getCrypto().getRandomValues(a);return a}function q(a){a=a.byteLength;var b=i-a%i;return Number.isNaN(b)?a:a+b}function r(a,c,e){var f=n(c);return(h||(h=b("Promise"))).resolve(d("WACryptoDependencies").getCrypto().subtle.importKey("raw",d("WATypedArraysCast").castTypedArrays(Uint8Array,a),"AES-CBC",!1,["decrypt"])).then(function(a){return d("WACryptoDependencies").getCrypto().subtle.decrypt(f,a,e)})}function a(a,c){return(h||(h=b("Promise"))).resolve().then(function(){var b=c.slice(0,k),d=c.slice(k);return r(a,b,d)})}function e(a,c,e){return(h||(h=b("Promise"))).resolve().then(function(){var f=p(e),g=n(f);return(h||(h=b("Promise"))).resolve(o(a)).then(function(a){return d("WACryptoDependencies").getCrypto().subtle.encrypt(g,a,c)}).then(function(a){return d("WATypedArraysConcat").concatTypedArrays(Uint8Array,[f,new Uint8Array(a)]).buffer})})}function f(a,b,c,d){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,d,e){e===void 0&&(e=m);if(e%i!==0)throw c("err")("chunkSize must be a multiple of "+i+", "+e+" received");a=(yield o(a));b=new Uint8Array(b);var f=Math.ceil(b.byteLength/e);d=p(d);var g=new Uint8Array(q(b)+d.byteLength);g.set(d);for(var h=0,j=d,k;h<f;h++){var l=h===f-1,k=h*e;k=b.subarray(k,k+e);l=(yield t(l,k,j,a));k=l.encryptedChunk;l=l.nextIv;g.set(k,d.byteLength+h*e);j=l}return g.buffer});return s.apply(this,arguments)}function t(a,b,c,d){return u.apply(this,arguments)}function u(){u=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){c=(yield d("WACryptoDependencies").getCrypto().subtle.encrypt(n(c),e,b).then(function(b){return a?new Uint8Array(b):new Uint8Array(b).subarray(0,-i)}));e=c.slice(-i);return{encryptedChunk:c,nextIv:e}});return u.apply(this,arguments)}g.AES_CBC_BLOCK_SIZE=i;g.AesCbcStream=l;g.importRawKey=o;g.getIv=p;g.aesCbcDecrypt=r;g.aesCbcDecryptSplit=a;g.aesCbcEncrypt=e;g.aesCbcEncryptWithChunking=f;g.aesCbcEncryptChunk=t}),98);
__d("WAMediaCryptoSidecar",["WAConcurrentIterate","WACryptoHmac","WAMediaUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return a==="video"}var h=16,i=10,j=64*1024;function b(a,b,c){c===void 0&&(c=1);var e=b.buffer.byteLength;e=Math.ceil((e-h)/j);var f=new Uint8Array(i*e);return d("WAConcurrentIterate").concurrentIterate(e,function(c){var e=c*j,g=e+h+j;e=b.subarray(e,g);return d("WACryptoHmac").sign(a,e).then(function(a){a=new Uint8Array(a,0,i);f.set(a,c*i)})},c).then(function(){return d("WAMediaUtils").castToStreamingSidecar(f.buffer)})}g.shouldHaveStreamingSidecar=a;g.calculateStreamingSidecar=b}),98);
__d("WAMediaHkdfInfo",["err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){switch(a){case"document":return"WhatsApp Document Keys";case"image":case"sticker":case"xma-image":return"WhatsApp Image Keys";case"video":case"gif":return"WhatsApp Video Keys";case"audio":case"ptt":return"WhatsApp Audio Keys";case"md-app-state":return"WhatsApp App State Keys";case"md-msg-hist":return"WhatsApp History Keys";default:throw c("err")("getMediaHkdfInfo: unexpected media type "+a)}}function b(){return"Messenger Preview Keys"}g.getMediaHkdfInfo=a;g.getPreviewMediaHkdfInfo=b}),98);
__d("WAMediaCrypto",["Promise","WABinary","WABlobToArrayBuffer","WACryptoAesCbc","WACryptoDependencies","WACryptoHkdf","WACryptoHmac","WACryptoSha256","WACryptoUtils","WACustomError","WAHashUtils","WALogger","WAMediaCryptoSidecar","WAMediaHkdfInfo","WATagsLogger","WATypedArraysConcat","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing scan ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unable to decrypt partial due to invalid target scan"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["decryptPartialChunks targetScan greater length of scanLength array"]);k=function(){return a};return a}var l=d("WATagsLogger").TAGS(["WAMediaCrypto"]),m=d("WACustomError").customError("HmacValidationError",!1),n=new Uint8Array([2,2]);function o(a,b){return d("WACryptoHkdf").extractAndExpand(new Uint8Array(a),b,112).then(function(a){return{iv:new Uint8Array(a,0,16),cipherKey:new Uint8Array(a,16,32),hmacKey:new Uint8Array(a,48,32),refKey:new Uint8Array(a,80,32)}})}function p(a,b){b=d("WAMediaHkdfInfo").getMediaHkdfInfo(b);return o(a,b)}function q(a){var b=d("WAMediaHkdfInfo").getPreviewMediaHkdfInfo();return o(a,b)}function a(a){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=new Map(),d=(yield q(a));c.set("preview",d);d=["document","image","video","audio","md-app-state","md-msg-hist"];yield (h||(h=b("Promise"))).all(d.map(function(b){return p(a,b).then(function(a){c.set(b,a)})}));return c});return r.apply(this,arguments)}function e(a){switch(a){case"image":case"video":return a;default:return null}}var s=16,t=16,u=10,v=64*1024;function f(a,b,c,d,e){return w.apply(this,arguments)}function w(){w=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e,f,g){var i=new(d("WABinary").Binary)();i.ensureCapacity(t+f.size+s+u);i.writeByteArray(c);a=new(d("WACryptoAesCbc").AesCbcStream)(i,"encrypt",a,c);c=0;var j=c+v;while(j<f.size){var k=f.slice(c,j);k=(yield d("WABlobToArrayBuffer").blobToArrayBuffer(k));yield a.append(new Uint8Array(k));c=j;j+=v}k=(yield d("WABlobToArrayBuffer").blobToArrayBuffer(f.slice(c)));yield a.finalize(new Uint8Array(k));j=i.peek(function(a){return a.readByteArray()});f=(yield d("WACryptoHmac").encodeKeySha256(e));c=(yield d("WACryptoHmac").sign(f,j));i.writeByteArray(new Uint8Array(c,0,u));a=i.readByteArray();k=a.subarray(t);e=(yield (h||(h=b("Promise"))).all([d("WACryptoDependencies").getCrypto().subtle.digest("SHA-256",k),d("WAMediaCryptoSidecar").shouldHaveStreamingSidecar(g)?d("WAMediaCryptoSidecar").calculateStreamingSidecar(f,a):void 0]));c=e[0];i=e[1];return{ciphertext:k,ciphertextHash:c,sidecar:i,ivCiphertext:j,ivCiphertextHmac:a}});return w.apply(this,arguments)}function x(a,b,c){return y.apply(this,arguments)}function y(){y=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){a=(yield d("WACryptoHmac").encodeKeySha256(a));b=d("WABinary").Binary.build(b,c).readByteArray();return d("WACryptoHmac").sign(a,b)});return y.apply(this,arguments)}function z(a,b,c,d,e){return A.apply(this,arguments)}function A(){A=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f){if(!(10<=f.length&&f.length<=32))throw new m("Bad hmac size "+f.length);var g=d("WABinary").Binary.build(b,c).readByteArray();e=(yield d("WACryptoHmac").hmacSha256(e,g).then(function(a){return new Uint8Array(a)}));g=e.slice(0,f.length);if(!F(g,f))throw new m("hmacAndDecrypt hmac mismatch");e=(yield d("WACryptoAesCbc").aesCbcDecrypt(a,b,c));g=(yield d("WACryptoDependencies").getCrypto().subtle.digest("SHA-256",e));return{plaintextHash:d("WAHashUtils").toPlaintextHash(g),plaintext:e}});return A.apply(this,arguments)}function B(a,b,c,e,f){if(!(10<=f.length&&f.length<=32))throw new m("Bad hmac size "+f.length);var g=d("WATypedArraysConcat").concatTypedArrays(Uint8Array,[b,c]);return d("WACryptoHmac").hmacSha256(e,g,f.length).then(function(a){return new Uint8Array(a)}).then(function(a){if(!d("WACryptoUtils").uint8ArraysEqual(a,f))throw new m("hmacAndDecrypt hmac mismatch")}).then(function(){var a=c.byteLength%s===u;if(a===!0)return c.subarray(0,-10);else return c}).then(function(c){return C(a,b,c)})}function C(a,b,c){var e=c.subarray(-s);return d("WACryptoAesCbc").aesCbcEncrypt(a,n,e).then(function(a){return a.slice(t)}).then(function(a){return d("WABinary").Binary.build(c,a).readByteArray()}).then(function(c){return d("WACryptoAesCbc").aesCbcDecrypt(a,b,c)}).then(function(a){return new Uint8Array(a,0,a.byteLength-n.byteLength)}).then(function(a){return{plaintext:a,nextIv:e}})}function D(a,b,c,d,e,f){return E.apply(this,arguments)}function E(){E=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h){g>h.scanLengths.length&&l.ERROR(k());g=Math.min(g,h.scanLengths.length);if(g<1){l.ERROR(j());throw c("err")("Unable to decrypt partial due to invalid target scan")}var m=new(d("WABinary").Binary)(),n=[];for(var o=0;o<g;o++)n.push(new Uint8Array(h.sidecar,o*10,10));o=0;b=b;var p=0;for(var q=0;q<g;q++){d("WALogger").DEV(i(),q);var r=h.alignedScanLengths[q],s=o+r;s=e.subarray(o,s);s=(yield B(a,b,s,f,n[q]));var t=s.plaintext;s=s.nextIv;m.write(t);o+=r;b=s;p+=h.scanLengths[q]}t=m.readBuffer(p);r=(yield d("WACryptoSha256").sha256(t));return{plaintextHash:d("WAHashUtils").toPlaintextHash(r),plaintext:t}});return E.apply(this,arguments)}function F(a,b){if(a.length!==b.length)return!1;var c=1,d=a.length;for(var e=0;e<d;e++)c&=a[e]===b[e]?1:0;return c!==0}g.HmacValidationError=m;g.DEFAULT_PADDING=n;g.computeMediaKeys=p;g.computeMediaKeysForPreview=q;g.deprecated_getAllCommonComputedMediaKeys=a;g.convertServerMediaTypeToPreviewMediaType=e;g.CBC_BLOCK_SIZE=s;g.IV_LENGTH=t;g.HMAC_LENGTH=u;g.encryptAndHmac=f;g.hmacCiphertext=x;g.hmacAndDecrypt=z;g.hmacAndDecryptPartial=B;g.decryptPartialChunks=D}),98);
__d("WACreateMediaDecrypterStream",["WABinary","WAMediaCrypto","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Invalid PKCS padding length"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Plaintext size is less than CBC_BLOCK_SIZE"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpected ciphertext in buffer following flush"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unable to decrypt chunk. isLastChunk: "," error: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing scan "," of size ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["expectedHmacs and ciphertextLengths must have the same length"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["expectedHmacs must have at least one element"]);n=function(){return a};return a}var o=d("WATagsLogger").TAGS(["WADecryptStream"]);function a(a,c,e,f,g){if(f.byteLength===0){o.ERROR(n());return d("WAResultOrError").makeError("missing-expected-hmacs")}if(f.byteLength!==g.length*d("WAMediaCrypto").HMAC_LENGTH){o.ERROR(m());return d("WAResultOrError").makeError("hmac-chiphertext-array-mismatch")}var h=p(f),i=c,r=new(d("WABinary").Binary)(),s=0,t=function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b,c){r.writeByteArray(b);for(;s<h.length&&r.size()>=g[s];s++){b=r.readByteArray(g[s]);o.DEV(l(),s,b.length);var f=s===g.length-1;try{b=(yield d("WAMediaCrypto").hmacAndDecryptPartial(a,i,b,e,h[s]));var j=b.plaintext;b=b.nextIv;f?void c.enqueue(q(j)):void c.enqueue(j);i=b}catch(a){o.ERROR(k(),f,a),a instanceof d("WAMediaCrypto").HmacValidationError?c.error("enc-hash-mismatch"):c.error("decryption-error")}}});return function(a,b){return c.apply(this,arguments)}}();f=new TransformStream({transform:function(a,b){a=a;return t(a,b)},flush:function(a){r.size()>0&&o.ERROR(j())}});return d("WAResultOrError").makeResult(f)}function p(a){var b=[];if(a.byteLength%d("WAMediaCrypto").HMAC_LENGTH!==0)throw c("err")("Sidecar length is not a multiple of hmac length");for(var e=0;e<a.byteLength;e+=d("WAMediaCrypto").HMAC_LENGTH){var f=new Uint8Array(a,e,d("WAMediaCrypto").HMAC_LENGTH);b.push(f)}return b}function q(a){if(a.length<d("WAMediaCrypto").CBC_BLOCK_SIZE){o.ERROR(i());return a}var b=a[a.length-1];if(b===0||b>d("WAMediaCrypto").CBC_BLOCK_SIZE){o.ERROR(h());return a}return a.subarray(0,-b)}g.createDefaultDecryptStream=a}),98);
__d("WAExtractNcHotTimestamp",["WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(a==null)return null;a=h(a);if(a.has("_nc_hot")){a=parseInt(a.get("_nc_hot"),10);return Number.isInteger(a)?d("WATimeUtils").castToUnixTime(a):null}else return null}function h(a){a=a.split("?");return new URLSearchParams(a.length===2?a[1]:"")}g.extractNcHotTimestamp=a}),98);
__d("WAParseIqResponse",["WAWap"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){var e=a.content;if(e&&Array.isArray(e)&&e[0]){e=e[0];if(e.tag==="error"){var f=e.attrs||{},g;c&&(typeof c==="function"?g=c(a):g=c.parseOrThrow(e));c=g;return{success:!1,errorCode:parseInt(f.code,10),errorText:d("WAWap").decodeAsString(f.text)||"",errorType:d("WAWap").decodeAsString(f.type)||"",errorBackoff:parseInt(f.backoff,10),toString:h,customError:c}}}if(typeof b==="function")return{success:!0,result:b(a)};else return{success:!0,result:b.parseOrThrow(a)}}function h(){return"IqError "+this.errorCode+": "+this.errorText}g.parseIqResponse=a}),98);
__d("WADeprecatedSendIq",["Promise","WAAckParser","WAArrayUtils","WAComms","WALogger","WAParseIqResponse"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Comms has no open socket, will send stanza when socket opens"]);i=function(){return a};return a}function a(a,b){return d("WAComms")._sendIq(a,!1).then(function(a){return d("WAParseIqResponse").parseIqResponse(a,b)})}function c(a,b,c){return d("WAComms")._sendIq(a,!1).then(function(a){return d("WAParseIqResponse").parseIqResponse(a,b,c)})}function e(a,b,c){return d("WAComms")._sendIq(a,!1,c).then(function(a){return d("WAParseIqResponse").parseIqResponse(a,b)})}function f(a,b){return d("WAComms")._sendIq(a,!0).then(function(a){return d("WAParseIqResponse").parseIqResponse(a,b)})}function j(a,b){return k(a,b).then(function(){})}function k(a,c){return new(h||(h=b("Promise")))(function(e){var f=d("WAComms").singletonOrThrowIfUninitialized("deprecatedSendStanzaAndReturnAck"),g=function(a){var b=d("WAAckParser").AckParser.parse(a);return!b.error&&d("WAAckParser").ackMatchesTemplate(b.success,c)?a:null},j={type:"ack",parseAndTest:g,resolve:e,stanza:a,attachedToSocketId:d("WAComms").DEFAULT_SOCKET_ID,orderedId:d("WAComms").getAndIncrementNextOrderedId()};f.ackHandlers.push(j);if(!f.socket){d("WALogger").LOG(i());return}f.callStanza(a)["catch"](function(a){var c=f.ackHandlers.indexOf(j);if(c===-1)return;d("WAArrayUtils").removeIndexWithoutPreservingOrder(f.ackHandlers,c);j.resolve((h||(h=b("Promise"))).reject(a))})})}function l(a,b){d("WAComms").castSmaxStanza(a,b)}g.deprecatedSendIq=a;g.deprecatedSendIqErrorParser=c;g.deprecatedSendIqIfConnectedWithin=e;g.deprecatedSendIqWithoutRetry=f;g.deprecatedSendStanzaAndWaitForAck=j;g.deprecatedSendStanzaAndReturnAck=k;g.deprecatedCastStanza=l}),98);
__d("WAMediaConnParser",["WADeprecatedWapParser","WAServerMediaType"],(function(a,b,c,d,e,f,g){"use strict";a=new(c("WADeprecatedWapParser"))("mediaConnParser",function(a){a=a.child("media_conn");var b=j(a);return{hosts:b,authToken:a.attrString("auth"),authTokenExpiryTs:a.attrFutureTime("auth_ttl"),routesExpiryTs:a.attrFutureTime("ttl"),maxBuckets:a.attrInt("max_buckets"),maxManualRetry:(b=a.maybeAttrInt("max_manual_retry",0,4))!=null?b:3,maxAutoDownloadRetry:(b=a.maybeAttrInt("max_auto_download_retry",0,4))!=null?b:3}});function h(a){var b;return!a.hasAttr("fallback_hostname")?void 0:{domain:a.attrString("fallback_hostname"),"class":a.maybeAttrString("fallback_class"),ip4:(b=a.maybeAttrString("fallback_ip4"))!=null?b:void 0,ip6:(b=a.maybeAttrString("fallback_ip6"))!=null?b:void 0}}function i(a){var b;return{domain:a.attrString("hostname"),fallback:h(a),uploadable:k(a,"upload"),downloadable:k(a,"download"),isFallback:a.maybeAttrString("type")==="fallback",downloadBuckets:(b=(b=a.maybeChild("download_buckets"))==null?void 0:b.mapChildren(function(a){return parseInt(a.tag(),10)}))!=null?b:[],"class":a.maybeAttrString("class"),ip4:(b=a.maybeAttrString("ip4"))!=null?b:void 0,ip6:(b=a.maybeAttrString("ip6"))!=null?b:void 0}}function j(a){return a.mapChildrenWithTag("host",i)}function k(a,b){if(a.hasChild(b))return a.child(b).mapChildren(function(a){a=a.tag();return d("WAServerMediaType").castToServerMediaType(a)}).filter(Boolean);else return d("WAServerMediaType").SERVER_MEDIA}g.mediaConnParser=a}),98);
__d("WAGatherMediaInfo",["WADeprecatedSendIq","WAErrors","WALogger","WAMediaConnParser","WAPromiseManagement","WAPromiseRetryLoop","WAResultOrError","WAWap"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo error ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got "," hosts"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got client error: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got "," seconds backoff"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo failure ",""]);l=function(){return a};return a}var m=507;b=d("WAPromiseManagement").cacheWhilePending(function(){return"gatherMediaInfo"},a);function a(){var a=new(d("WAPromiseRetryLoop").PromiseRetryLoop)({name:"gatherMediaInfo",timer:{jitter:.25,max:987e3,algo:{type:"fibonacci",first:6e3,second:12e3},relativeDelay:!0},code:o});a.start();return a.promise()}var n=60;function o(a){var b;b=(b=d("WAWap")).wap("iq",{id:b.generateId(),to:b.S_WHATSAPP_NET,type:"set",xmlns:"w:m"},b.wap("media_conn",null));return d("WADeprecatedSendIq").deprecatedSendIqIfConnectedWithin(b,d("WAMediaConnParser").mediaConnParser,n).then(function(b){if(!b.success){d("WALogger").LOG(l(),b);if(b.errorCode===m){var c=b.errorBackoff;d("WALogger").LOG(k(),c);a(d("WAResultOrError").makeError({type:"backoff",backoffMs:c*1e3}))}else b.errorCode<500&&(d("WALogger").LOG(j(),b.errorCode),a(d("WAResultOrError").makeError({type:"client-error",code:b.errorCode,text:b.errorText})))}else d("WALogger").LOG(i(),b.result.hosts.length),a(d("WAResultOrError").makeResult(b.result))})["catch"](function(b){b instanceof d("WAErrors").Disconnected?a(d("WAResultOrError").makeError("disconnected")):d("WALogger").ERROR(h(),b)})}g.gatherMediaInfo=b}),98);
__d("WAMediaRouteSelection",["WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=null,c=null,e=null,f=a.hosts,g=a.operation,h=a.mediaType;if(a.operation==="download"){var i=a.catHotTimespan,j=a.ncHot;a=a.getVcaEnabledBucket;var k=new Map();f.forEach(function(a){a.downloadBuckets.forEach(function(b){k.set(b,a)})});var l=k.get(0);i>0&&j!=null&&d("WATimeUtils").happenedWithin(d("WATimeUtils").castToUnixTime(j),i)?b=1:a&&(b=a());j=null;b!=null&&(j=k.get(b));((i=j)==null?void 0:i.downloadable.includes(h))?c=j:(l==null?void 0:l.downloadable.includes(h))&&(c=l)}for(a=0;a<f.length;a++){i=f[a];g==="upload"&&i.uploadable.includes(h)?c==null?c=i:i.isFallback&&e==null&&(e=i):g==="download"&&i.downloadable.includes(h)&&(c==null?c=i:i.isFallback&&e==null&&(e=i));if(c!=null&&e!=null)break}return{selectedHost:c,fallbackHost:e,bucket:b}}g.mediaRouteSelection=a}),98);
__d("WAGetMediaRoute",["$InternalEnum","Promise","WACreateGetVcaEnabledBucket","WAExtractNcHotTimestamp","WAGatherMediaInfo","WAMediaRouteSelection","WAPromiseManagement","WAResultOrError","WATagsLogger","WATimeUtils","WAWaitForComms","WAWorkerGlobalScope","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error: no media host"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to get mediaAccess: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error occurred on gather after backoff expiry: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Can not get mediaAccess: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["mediaAccess has gone, gather a new one"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["mediaAccess has gone, but we are still locked by backoff"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error occurred during authTTL automatic refresh: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["AuthTTL approaching expiry, refreshing MediaAccess routes"]);p=function(){return a};return a}var q=d("WATagsLogger").TAGS(["GetMediaRoute"]),r=!0,s=86400,t=b("$InternalEnum")({Fresh:"fresh",Cached:"cached",Stale:"stale"}),u=null,v=!1,w=null;function a(a,b){return x.apply(this,arguments)}function x(){x=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){b==null?void 0:b.addPoint("get_cached_or_fresh_media_access_start");var c=(yield B());b==null?void 0:b.addPoint("get_cached_or_fresh_media_access_end");if(!c.success){q.ERROR(j(),c.error);b==null?void 0:b.addPoint("get_media_access_failed",{string:{mediaAccessStatus:c.error}});return c}b==null?void 0:b.addAnnotations({string:{mediaAccessStatus:c.value.state}});b=c.value.mediaAccess;c=b.authToken;var e=b.hosts;b=b.maxBuckets;e=a.operation==="upload"?d("WAMediaRouteSelection").mediaRouteSelection({operation:"upload",mediaType:a.serverMediaType,hosts:e}):d("WAMediaRouteSelection").mediaRouteSelection({operation:"download",mediaType:a.serverMediaType,hosts:e,catHotTimespan:s,ncHot:d("WAExtractNcHotTimestamp").extractNcHotTimestamp(a.directPath),getVcaEnabledBucket:r?d("WACreateGetVcaEnabledBucket").msgrCreateGetVcaEnabledBucket(a.directPath,b):void 0});a=e.selectedHost;b=e.fallbackHost;e=e.bucket;if(a==null){q.ERROR(i());return d("WAResultOrError").makeError("no-host")}return d("WAResultOrError").makeResult({authToken:c,selectedHost:a,fallbackHost:b,bucket:e})});return x.apply(this,arguments)}function y(){var a=w;a!=null&&(d("WAWorkerGlobalScope").workerGlobalScope.clearTimeout(a),w=null)}function z(a){y();var b=Math.max(a.authTokenExpiryTs-d("WATimeUtils").unixTime(),0);if(b<=5*60)return;var c=d("WATimeUtils").pastUnixTime(5*60,a.authTokenExpiryTs);b=d("WATimeUtils").pastUnixTime(Math.floor(b*.2),a.authTokenExpiryTs);a=c<b?c:b;c=d("WATimeUtils").cappedMillisecondsUntil(a);b=Math.floor(Math.random()*d("WATimeUtils").MINUTE_MILLISECONDS);a=d("WAWorkerGlobalScope").workerGlobalScope.setTimeout(function(){q.LOG(p()),A()["catch"](function(a){q.ERROR(o(),a)})},c+b);w=a}var A=d("WAPromiseManagement").cacheWhilePending(function(){return"all"},b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(v){q.LOG(n());return d("WAResultOrError").makeError("backoff")}yield d("WAWaitForComms").waitForComms();q.LOG(m());y();var a=(yield d("WAGatherMediaInfo").gatherMediaInfo());if(a.success){u=a.value;z(a.value);return d("WAResultOrError").makeResult({mediaAccess:a.value,state:t.Fresh})}else{a=a.error;var b=a==="disconnected"?"disconnected":a.type;q.WARN(l(),b);if(a==="disconnected"||a.type==="client-error")return d("WAResultOrError").makeError("disconnected");else{a.type;v=!0;d("WAWorkerGlobalScope").workerGlobalScope.setTimeout(function(){v=!1,A()["catch"](function(a){q.ERROR(k(),a)})},a.backoffMs);return d("WAResultOrError").makeError("backoff")}}})),B=function(){var a=u;if(a==null)return A();if(d("WATimeUtils").isInFuture(a.routesExpiryTs))return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult({mediaAccess:a,state:t.Cached}));var c=A();return d("WATimeUtils").isInFuture(a.authTokenExpiryTs)?(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult({mediaAccess:a,state:t.Stale})):c};function c(){u=null,v=!1,y()}g.getMediaRoute=a;g.getCachedOrFreshMediaAccess=B;g.clearCachedMediaAccessForTest=c}),98);
__d("WAMediaOperationsRetrier",["WALogger","WAPromiseBackoffs","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaOperationsRetrier:"," wait for internet, attempt = ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Running retrier"]);i=function(){return a};return a}var j=4,k={algo:{type:"constant",delay:1e3},jitter:0};a=function(){function a(a,b,c){this.$1=a,this.routesInfo=b,this.$2=d("WAPromiseBackoffs").createPromiseTimer(k),this.$3=0,this.$4=!1,this.$5=c}var c=a.prototype;c.run=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){while(this.$3<j){d("WALogger").DEV(i());yield this.$2();var c=void 0;this.$3>0?(c=this.$3>=j-2&&!this.$4,d("WALogger").LOG(h(),this.$1,this.$3),yield this.$5==null?void 0:this.$5()):c=!1;var e=this.routesInfo;if(!e)return null;var f=e.host;c&&e.fallbackHost&&(f=e.fallbackHost);c=(yield a(f,e.authToken,this.$3,b));if(c.success)return c.value;else++this.$3,this.$4=c.error.progressMade}return null});function c(b,c){return a.apply(this,arguments)}return c}();return a}();g.MAX_ATTEMPTS=j;g.BACKOFF_OPTIONS=k;g.MediaOperationsRetrier=a}),98);
__d("WACreateMediaDownloadRetrier",["WAComms","WAGetMediaRoute","WAMediaOperationsRetrier","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.directPath,c=a.eventFlow,e=a.fileEncSha256;a=a.mediaTypeDetails;a=a.type==="regular"?a.mediaType:"preview";c==null?void 0:c.addPoint("get_media_route_start");a=(yield d("WAGetMediaRoute").getMediaRoute({operation:"download",serverMediaType:a,fileEncSha256:e,directPath:b},c));if(!a.success){c==null?void 0:c.addPoint("get_media_route_fail");return a}c==null?void 0:c.addPoint("get_media_route_end");e=a.value;b=e.selectedHost;c=e.fallbackHost;e=e.authToken;b=new(d("WAMediaOperationsRetrier").MediaOperationsRetrier)("download",{host:{domain:b.domain,"class":b["class"]},fallbackHost:c&&{domain:c.domain,"class":c["class"]},authToken:e,timeElapsed:null},d("WAComms").waitForConnection);return d("WAResultOrError").makeResult({retrier:b,mediaRouteDetails:a.value})});return h.apply(this,arguments)}g.createMediaDownloadRetrier=a}),98);
__d("WADecryptMedia",["WAGlobals","WAMediaCrypto","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Success"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Error ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Using default plaintext verifier"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose([""," is not a working hmac salt."]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Found a working hmac salt using ","."]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Trying "," as an alternative hmac salt."]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Encountered enc-hash-mismatch - looking for a potential working hmac salt"]);n=function(){return a};return a}var o=d("WATagsLogger").TAGS(["WADecryptMedia"]);function p(a,b,c,d){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){o.WARN(n());c=c.type==="preview"?"preview":c.mediaType;e=(yield d("WAMediaCrypto").deprecated_getAllCommonComputedMediaKeys(e));for(e of e){var f=e[0],g=e[1];try{if(f===c)continue;o.LOG(m(),f);g=d("WAResultOrError").makeResult(yield d("WAMediaCrypto").hmacAndDecrypt(g.cipherKey,g.iv,a,g.hmacKey,b));g={hmacAndDecryptResult:g,alternativeHmacSaltUsed:f};o.LOG(l(),f);return g}catch(a){o.LOG(k(),f);continue}}return{hmacAndDecryptResult:d("WAResultOrError").makeError("enc-hash-mismatch")}});return q.apply(this,arguments)}function a(a){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.ciphertextHmac,c=a.mediaKey,e=a.mediaTypeDetails;a=a.plaintextHash;o.LOG(j());var f=b.byteLength-d("WAMediaCrypto").HMAC_LENGTH,g=new Uint8Array(b,f),k=new Uint8Array(b,0,f);e.type==="preview"?b=d("WAMediaCrypto").computeMediaKeysForPreview(c):b=d("WAMediaCrypto").computeMediaKeys(c,e.mediaType);f=null;b=(yield b.then(function(a){var b=a.iv,c=a.cipherKey;a=a.hmacKey;return d("WAMediaCrypto").hmacAndDecrypt(c,b,k,a,g)}).then(d("WAResultOrError").makeResult)["catch"](function(a){o.ERROR(i(),a);if(a instanceof d("WAMediaCrypto").HmacValidationError)return d("WAResultOrError").makeError("enc-hash-mismatch");else return d("WAResultOrError").makeError("decryption-error")}));if(d("WAGlobals").getConfig().isMediaFallbackToAlternativeHmacSaltsEnabled()===!0&&b.success===!1&&b.error==="enc-hash-mismatch"){e=(yield p(k,g,e,c));b=e.hmacAndDecryptResult;f=e.alternativeHmacSaltUsed}if(!b.success)return b;c=b.value;e=c.plaintext;b=c.plaintextHash;if(a!==b)return d("WAResultOrError").makeError("hash-mismatch");o.LOG(h());return d("WAResultOrError").makeResult({plaintext:e,alternativeHmacSaltUsed:f})});return r.apply(this,arguments)}g.decryptMedia=a}),98);
__d("WASmaxInMmsdIQErrorResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["id"]);if(!c.success)return c;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"id",c.value);if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["to"]);if(!c.success)return c;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"from",c.value);if(!b.success)return b;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"type","error");return!c.success?c:d("WAResultOrError").makeResult({type:c.value})}g.parseIQErrorResponseMixin=a}),98);
__d("WASmaxInMmsdEnums",[],(function(a,b,c,d,e,f){a={0:"0",1:"1"};b={400:"400",401:"401",404:"404",408:"408",409:"409",415:"415",426:"426",429:"429"};c={500:"500",501:"501",502:"502",503:"503",507:"507"};d={fallback:"fallback",primary:"primary"};e={"false":"false","true":"true"};var g={fna:"fna",pop:"pop"};f.ENUM_0_1=a;f.ENUM_400_401_404_408_409_415_426_429=b;f.ENUM_500_501_502_503_507=c;f.ENUM_FALLBACK_PRIMARY=d;f.ENUM_FALSE_TRUE=e;f.ENUM_FNA_POP=g}),66);
__d("WASmaxInMmsdRequestErrorMixin",["WAResultOrError","WASmaxInMmsdEnums","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxParseUtils").attrString(a,"text");if(!b.success)return b;var c=d("WASmaxParseUtils").attrStringEnum(a,"code",d("WASmaxInMmsdEnums").ENUM_400_401_404_408_409_415_426_429);if(!c.success)return c;a=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrIntRange,a,"backoff",0,10800);return!a.success?a:d("WAResultOrError").makeResult({text:b.value,code:c.value,backoff:a.value})}g.parseRequestErrorMixin=a}),98);
__d("WASmaxInMmsdResignCdnUrlResponseClientError",["WAResultOrError","WASmaxInMmsdIQErrorResponseMixin","WASmaxInMmsdRequestErrorMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;c=d("WASmaxInMmsdRequestErrorMixin").parseRequestErrorMixin(c.value);if(!c.success)return c;a=d("WASmaxInMmsdIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({errorRequestErrorMixin:c.value},a.value))}g.parseResignCdnUrlResponseClientError=a}),98);
__d("WASmaxInMmsdServerErrorMixin",["WAResultOrError","WASmaxInMmsdEnums","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxParseUtils").attrString(a,"text");if(!b.success)return b;var c=d("WASmaxParseUtils").attrStringEnum(a,"code",d("WASmaxInMmsdEnums").ENUM_500_501_502_503_507);if(!c.success)return c;a=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrIntRange,a,"backoff",0,10800);return!a.success?a:d("WAResultOrError").makeResult({text:b.value,code:c.value,backoff:a.value})}g.parseServerErrorMixin=a}),98);
__d("WASmaxInMmsdResignCdnUrlResponseServerError",["WAResultOrError","WASmaxInMmsdIQErrorResponseMixin","WASmaxInMmsdServerErrorMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;c=d("WASmaxInMmsdServerErrorMixin").parseServerErrorMixin(c.value);if(!c.success)return c;a=d("WASmaxInMmsdIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({errorServerErrorMixin:c.value},a.value))}g.parseResignCdnUrlResponseServerError=a}),98);
__d("WASmaxInMmsdIQResultResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["id"]);if(!c.success)return c;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"id",c.value);if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["to"]);if(!c.success)return c;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"from",c.value);if(!b.success)return b;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"type","result");return!c.success?c:d("WAResultOrError").makeResult({type:c.value})}g.parseIQResultResponseMixin=a}),98);
__d("WASmaxInMmsdResignCdnUrlResponseSuccess",["WAResultOrError","WASmaxInMmsdIQResultResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"cdn_url_resign");if(!c.success)return c;c=d("WASmaxParseUtils").attrString(c.value,"direct_path");if(!c.success)return c;a=d("WASmaxInMmsdIQResultResponseMixin").parseIQResultResponseMixin(a,b);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({cdnUrlResignDirectPath:c.value},a.value))}g.parseResignCdnUrlResponseSuccess=a}),98);
__d("WASmaxOutMmsdBaseIQGetRequestMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(a,b,c,d,e,f,g){function h(){var a=d("WASmaxJsx").smax("iq",{id:d("WAWap").generateId(),type:"get"});return a}function a(a){var b=h();return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeBaseIQGetRequestMixin=a}),98);
__d("WASmaxOutMmsdIQRequestCommonMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(a,b,c,d,e,f,g){function h(){var a=d("WASmaxJsx").smax("iq",{xmlns:"w:m",to:d("WAWap").S_WHATSAPP_NET});return a}function a(a){var b=h();return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeIQRequestCommonMixin=a}),98);
__d("WASmaxMixinGroupExhaustiveError",[],(function(a,b,c,d,e,f){"use strict";a=function(a){babelHelpers.inheritsLoose(b,a);function b(){var b,c;for(var d=arguments.length,e=new Array(d),f=0;f<d;f++)e[f]=arguments[f];return(b=c=a.call.apply(a,[this].concat(e))||this,c.name="SmaxMixinGroupExhaustiveError",b)||babelHelpers.assertThisInitialized(c)}return b}(babelHelpers.wrapNativeSuper(Error));f.SmaxMixinGroupExhaustiveError=a}),66);
__d("WASmaxOutMmsdResignCdnUrlResignWithHandleParamsMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(a,b,c,d,e,f,g){function h(a){a=a.cdnUrlResignHandle;a=d("WASmaxJsx").smax("cdn_url_resign",{handle:d("WAWap").CUSTOM_STRING(a),use_case_hint:"wa_stickers"});return a}function a(a,b){b=h(b);return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeResignCdnUrlResignWithHandleParamsMixin=a}),98);
__d("WASmaxOutMmsdResignCdnUrlResignWithObjectIdAndFBIdParamsMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(a,b,c,d,e,f,g){function h(a){var b=a.cdnUrlResignFbid;a=a.cdnUrlResignObjectId;b=d("WASmaxJsx").smax("cdn_url_resign",{fbid:d("WAWap").CUSTOM_STRING(b),object_id:d("WAWap").CUSTOM_STRING(a),use_case_hint:"fb_encrypted_backup"});return b}function a(a,b){b=h(b);return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeResignCdnUrlResignWithObjectIdAndFBIdParamsMixin=a}),98);
__d("WASmaxOutMmsdResignWithResignCdnUrlObjectIdAndFBIdOrResignCdnUrlHandleParamsMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMmsdResignCdnUrlResignWithHandleParamsMixin","WASmaxOutMmsdResignCdnUrlResignWithObjectIdAndFBIdParamsMixin"],(function(a,b,c,d,e,f,g){function a(a,b){if(b.resignCdnUrlResignWithObjectIdAndFBIdParams)return d("WASmaxOutMmsdResignCdnUrlResignWithObjectIdAndFBIdParamsMixin").mergeResignCdnUrlResignWithObjectIdAndFBIdParamsMixin(a,b.resignCdnUrlResignWithObjectIdAndFBIdParams);if(b.resignCdnUrlResignWithHandleParams)return d("WASmaxOutMmsdResignCdnUrlResignWithHandleParamsMixin").mergeResignCdnUrlResignWithHandleParamsMixin(a,b.resignCdnUrlResignWithHandleParams);throw new(d("WASmaxMixinGroupExhaustiveError").SmaxMixinGroupExhaustiveError)()}g.mergeResignWithResignCdnUrlObjectIdAndFBIdOrResignCdnUrlHandleParamsMixinGroup=a}),98);
__d("WASmaxOutMmsdResignCdnUrlResignParamsMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMmsdResignWithResignCdnUrlObjectIdAndFBIdOrResignCdnUrlHandleParamsMixinGroup"],(function(a,b,c,d,e,f,g){function h(a){a=a.resignWithResignCdnUrlObjectIdAndFBIdOrResignCdnUrlHandleParamsMixinGroupArgs;a=d("WASmaxOutMmsdResignWithResignCdnUrlObjectIdAndFBIdOrResignCdnUrlHandleParamsMixinGroup").mergeResignWithResignCdnUrlObjectIdAndFBIdOrResignCdnUrlHandleParamsMixinGroup(d("WASmaxJsx").smax("cdn_url_resign",null),a);return a}function a(a,b){b=h(b);return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeResignCdnUrlResignParamsMixin=a}),98);
__d("WASmaxOutMmsdResignCdnUrlRequest",["WASmaxJsx","WASmaxOutMmsdBaseIQGetRequestMixin","WASmaxOutMmsdIQRequestCommonMixin","WASmaxOutMmsdResignCdnUrlResignParamsMixin","WAWap"],(function(a,b,c,d,e,f,g){function a(a){var b=a.cdnUrlResignSignDuration;a=a.resignCdnUrlResignParamsMixinArgs;b=d("WASmaxOutMmsdIQRequestCommonMixin").mergeIQRequestCommonMixin(d("WASmaxOutMmsdBaseIQGetRequestMixin").mergeBaseIQGetRequestMixin(d("WASmaxJsx").smax("iq",null,d("WASmaxOutMmsdResignCdnUrlResignParamsMixin").mergeResignCdnUrlResignParamsMixin(d("WASmaxJsx").smax("cdn_url_resign",{sign_duration:d("WAWap").INT(b)}),a))));return b}g.makeResignCdnUrlRequest=a}),98);
__d("WASmaxMmsdResignCdnUrlRPC",["WAComms","WASmaxInMmsdResignCdnUrlResponseClientError","WASmaxInMmsdResignCdnUrlResponseServerError","WASmaxInMmsdResignCdnUrlResponseSuccess","WASmaxOutMmsdResignCdnUrlRequest","WASmaxParsingFailure","WASmaxRpcUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){function a(a,b){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=d("WASmaxOutMmsdResignCdnUrlRequest").makeResignCdnUrlRequest(a);b=(yield d("WAComms").sendSmaxStanza(a,b));var c=d("WASmaxInMmsdResignCdnUrlResponseSuccess").parseResignCdnUrlResponseSuccess(b,a);if(c.success)return{name:"ResignCdnUrlResponseSuccess",value:c.value};var e=d("WASmaxInMmsdResignCdnUrlResponseClientError").parseResignCdnUrlResponseClientError(b,a);if(e.success)return{name:"ResignCdnUrlResponseClientError",value:e.value};b=d("WASmaxInMmsdResignCdnUrlResponseServerError").parseResignCdnUrlResponseServerError(b,a);if(b.success)return{name:"ResignCdnUrlResponseServerError",value:b.value};throw new(d("WASmaxParsingFailure").SmaxParsingFailure)(d("WASmaxRpcUtils").errorMessageRpcParsing("ResignCdnUrl",{Success:c,ClientError:e,ServerError:b}))});return h.apply(this,arguments)}g.sendResignCdnUrlRPC=a}),98);
__d("WAGetResignedCdnUrl",["WAAssertUnreachable","WADirectPath","WAErrorMessage","WALogger","WAPromiseRetryLoop","WAResultOrError","WASmaxMmsdResignCdnUrlRPC","WASmaxParsingFailure"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["requestCdnResignedUrl - Unknown Error ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["requestCdnResignedUrl - Error thrown whilst parsing SMAX response - ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Direct path signature expired. objectId: ",", fbid: ","."]);j=function(){return a};return a}var k="507",l=259200;function a(a){var b=a.objectId;a=a.fbid;b=new(d("WAPromiseRetryLoop").PromiseRetryLoop)({name:"requestCdnResignedUrl",timer:{jitter:.25,max:987e3,algo:{type:"fibonacci",first:6e3,second:12e3},relativeDelay:!0},code:m({objectId:b,fbid:a})});b.start();return b.promise()}function m(a){var b=a.objectId,e=a.fbid;return function(a){d("WALogger").LOG(j(),b,e);return d("WASmaxMmsdResignCdnUrlRPC").sendResignCdnUrlRPC({cdnUrlResignSignDuration:l,resignCdnUrlResignParamsMixinArgs:{resignWithResignCdnUrlObjectIdAndFBIdOrResignCdnUrlHandleParamsMixinGroupArgs:{resignCdnUrlResignWithObjectIdAndFBIdParams:{cdnUrlResignFbid:e,cdnUrlResignObjectId:b}}}}).then(function(b){switch(b.name){case"ResignCdnUrlResponseSuccess":return a(d("WAResultOrError").makeResult(d("WADirectPath").unsafeCastToDirectPath(b.value.cdnUrlResignDirectPath)));case"ResignCdnUrlResponseClientError":return a(d("WAResultOrError").makeError({type:"client-error",text:b.value.errorRequestErrorMixin.text}));case"ResignCdnUrlResponseServerError":if(b.value.errorServerErrorMixin.code!==k)return;return a(d("WAResultOrError").makeError({type:"server-error",text:b.value.errorServerErrorMixin.text,backoff:b.value.errorServerErrorMixin.backoff}));default:throw c("WAAssertUnreachable")(b.name)}})["catch"](function(b){var c=d("WAErrorMessage").maybeGetMessageFromError(b);if(b instanceof d("WASmaxParsingFailure").SmaxParsingFailure){d("WALogger").ERROR(i(),c);return a(d("WAResultOrError").makeError({type:"smax-parsing-error"}))}else{d("WALogger").ERROR(h(),c);return}})}}g.getCdnResignedUrl=a}),98);
__d("WAHttpDownloadMedia",["WAErrorMessage","WAGlobals","WALogger","WAMediaQplHelper","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Download Media Error: can not resume from offset"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to parse request body: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Fetch Media HTTP status ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to initiate fetch: ",", message: ",""]);k=function(){return a};return a}var l="URL signature expired";function a(a,b){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){b=(b=b)!=null?b:{};var c=b.mediaMetrics;b=b.abortSignal;c==null?void 0:c.addPoint("http_fetch_start");a=(yield self.fetch(a,{method:"GET",mode:"cors",cache:d("WAGlobals").getConfig().isHttpFetchCacheEnabled()?"force-cache":"no-store",signal:b}).then(function(a){c==null?void 0:c.addPoint("http_fetch_end");return d("WAResultOrError").makeResult(a)})["catch"](function(a){var b=d("WAErrorMessage").maybeGetMessageFromError(a);c==null?void 0:c.addPoint("http_fetch_fail",{string:{httpFetchError:b}});d("WALogger").WARN(k(),a,b);return d("WAResultOrError").makeError("http-fetch-exception")}));if(a.success===!1)return a;b=a.value;a=b.headers.get("content-length");var e=b.status;d("WALogger").LOG(j(),e);c==null?void 0:c.addAnnotations({string:{ciphertextMediaSizeBucket:a!=null?d("WAMediaQplHelper").convertIntegerSizeToStringBucket(Number(a)):null},"int":{httpStatus:e}});switch(e){case 200:case 206:return d("WAResultOrError").makeResult(b);case 401:return d("WAResultOrError").makeError("access-expired");case 403:return b.text().then(function(a){return a===l?d("WAResultOrError").makeError("signature-expired"):d("WAResultOrError").makeError("access-expired")})["catch"](function(a){d("WALogger").ERROR(i(),a);return d("WAResultOrError").makeError("access-expired")});case 404:case 410:return d("WAResultOrError").makeError("media-not-found");case 408:return d("WAResultOrError").makeError("server-timeout");case 416:d("WALogger").ERROR(h());return d("WAResultOrError").makeError("request-error");case 429:case 507:return d("WAResultOrError").makeError("download-throttled");default:return e>=400&&e<500?d("WAResultOrError").makeError("request-error"):d("WAResultOrError").makeError("unspecified-http-error")}});return m.apply(this,arguments)}g.httpDownloadMedia=a}),98);
__d("WAHttpUtils",["err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,d){if(!/^https:\/\/[-\w.]+\.\w+$/.test(a))throw c("err")('buildUrl given invalid host "'+a+'"');if(!b.startsWith("/"))throw c("err")('buildUrl given invalid path "'+b+'"');var e=d;d=""+a+b;if(!e)return d;a=Object.keys(e).map(function(a){var b=e[a];b instanceof ArrayBuffer&&(b=new Uint8Array(b));b=b instanceof Uint8Array?Array.prototype.slice.call(b).map(function(a){return"%"+a.toString(16)}).join(""):encodeURIComponent(b.toString());return encodeURIComponent(a)+"="+b});if(a.length>0){b=a.join("&");return d.includes("?")?d+"&"+b:d+"?"+b}else return d}g.buildUrl=a}),98);
__d("WAMediaUrl",["WABase64","WAGlobals","WAHttpUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=1;function a(a,b,c,e,f,g,i){var j=d("WAGlobals").getDependencies().mediaUploadRoot();c=d("WABase64").encodeB64UrlSafe(c);b=d("WABase64").encodeB64UrlSafe(b);f={auth:f,token:b};g&&(f.resume=h);i!=null&&i>0&&(f.bytestart=i);return d("WAHttpUtils").buildUrl("https://"+e,j+"/"+a+"/"+c,f)}function b(a,b,c,e,f,g,h){b=d("WABase64").encodeB64UrlSafe(b);b={hash:b,mode:e};f!=null&&(b._nc_cat=f);g!=null&&g>=0&&(b.bytestart=g);h!=null&&h>0&&(b.byteend=h);return d("WAHttpUtils").buildUrl("https://"+c,a,b)}g.RESUME_PARAM=h;g.buildUploadUrl=a;g.buildDownloadUrl=b}),98);
__d("WADownloadCiphertext",["WAAssertUnreachable","WABase64","WACreateMediaDownloadRetrier","WACryptoSha256","WACryptoUtils","WAGetResignedCdnUrl","WAHashUtils","WAHttpDownloadMedia","WALogger","WAMediaUrl","WAPromiseDelays","WAPromiseManagement","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext failed: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["downloadMedia given up"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["downloadCiphertext http download exception: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["result to generate a new cdn url was throttled (507)"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot generate a new cdn url: missing objectId or fbid"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Download Media Error: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to parse request body ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Downloading ciphertext for hash : "," from ",". Attempt: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Start download ciphertext for hash: ",""]);p=function(){return a};return a}function a(a){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.abortSignal,f=a.mediaTypeDetails,g=a.fileEncSha256,q=a.directPath,s=a.plaintextHash,t=a.objectId,u=a.fbid,v=a.pathRedirected,w=a.eventFlow,x=a.fromBytes,y=a.toBytes;d("WALogger").LOG(p(),d("WAHashUtils").sanitisePlaintextHash(s));a=(yield d("WACreateMediaDownloadRetrier").createMediaDownloadRetrier({mediaTypeDetails:f,directPath:q,eventFlow:w,fileEncSha256:g}));if(!a.success)return a;f=a.value;a=f.retrier;var z=f.mediaRouteDetails;f=(yield a.run(function(a,c,f){c=a.domain;a=d("WAMediaUrl").buildDownloadUrl(q,g,c,"manual",z.bucket,x,y);d("WALogger").DEV_XMPP(o(),d("WAHashUtils").sanitisePlaintextHash(s),a,f);w==null?void 0:w.addPoint("http_download_media_start");return d("WAHttpDownloadMedia").httpDownloadMedia(a,{mediaMetrics:w,abortSignal:e,cachePolicy:f>0?"no-store":"force-cache"}).then(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a.success)return a.value.arrayBuffer().then(function(a){w==null?void 0:w.addPoint("http_download_media_end");return d("WAResultOrError").makeResult(d("WAResultOrError").makeResult(a))})["catch"](function(a){w==null?void 0:w.addPoint("response_array_buffer_error");d("WALogger").ERROR(n(),a);return d("WAResultOrError").makeResult(d("WAResultOrError").makeError("body-network-error"))});else{w==null?void 0:w.addPoint("http_download_media_fail");a=a.error;d("WALogger").LOG(m(),a);switch(a){case"signature-expired":if(t==null||u==null){d("WALogger").LOG(l());return d("WAResultOrError").makeResult(d("WAResultOrError").makeError("signature-expired"))}var b=(yield d("WAGetResignedCdnUrl").getCdnResignedUrl({objectId:t,fbid:u}));if(!b.success){w==null?void 0:w.addPoint("resign_cdn_url_fail",{string:{resignCdnErrorType:b.error.type,resignCdnError:b.error.text}});var c=d("WAResultOrError").makeResult(d("WAResultOrError").makeError("signature-expired"));switch(b.error.type){case"client-error":return c;case"server-error":if(b.error.backoff!=null){var e=b.error.backoff;w==null?void 0:w.addPoint("resign_cdn_url_backoff");d("WALogger").LOG(k());return d("WAPromiseDelays").delayMs(e).then(function(){return d("WAResultOrError").makeResult(d("WAResultOrError").makeError("signature-expired"))})}return c;default:b.error.type;return c}}b.success;w==null?void 0:w.addPoint("resign_cdn_url_success");v!=null&&(yield v(b.value));return d("WAResultOrError").makeResult(d("WAResultOrError").makeError("signature-expired"));case"http-fetch-exception":case"server-timeout":case"unspecified-http-error":return d("WAResultOrError").makeError({progressMade:!0});default:return d("WAResultOrError").makeResult(d("WAResultOrError").makeError(a))}}});return function(b){return a.apply(this,arguments)}}())["catch"](function(a){d("WALogger").WARN(j(),a);return d("WAResultOrError").makeError({progressMade:!1})})}));if(f==null){d("WALogger").WARN(i());return d("WAResultOrError").makeError("max-attempts-exceeded")}if(f.success===!1){a=f.error;d("WALogger").WARN(h(),a);switch(a){case"signature-expired":case"media-not-found":case"download-throttled":case"body-network-error":case"request-error":return d("WAResultOrError").makeError(a);case"access-expired":return d("WAResultOrError").makeError("disconnected");default:a;throw c("WAAssertUnreachable")(a)}}else{a=f.value;if(!r(x,y)&&!d("WACryptoUtils").arrayBuffersEqual(yield d("WACryptoSha256").sha256(a),g))return d("WAResultOrError").makeError("ciphertext-hash-mismatch");w==null?void 0:w.addPoint("download_finish",{"int":{byteLength:a.byteLength},bool:{isPartialDownload:r(x,y)}});return d("WAResultOrError").makeResult(a)}});return q.apply(this,arguments)}e=d("WAPromiseManagement").cacheWhilePending(function(a){var b=a.fileEncSha256,c=a.fromBytes;a=a.toBytes;return d("WABase64").encodeB64UrlSafe(b)+"-"+((b=c)!=null?b:"X")+"-"+((c=a)!=null?c:"X")},a);function r(a,b){return a!=null&&a>0?!0:b!=null}g.cachedDownloadCiphertext=e}),98);
__d("WADownloadAndDecryptMedia",["WADecryptMedia","WADownloadCiphertext","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.abortSignal,c=a.mediaTypeDetails,e=a.fileEncSha256,f=a.directPath,g=a.mediaKey,h=a.plaintextHash,i=a.objectId,j=a.fbid,k=a.pathRedirected;a=a.eventFlow;b=(yield d("WADownloadCiphertext").cachedDownloadCiphertext({abortSignal:b,mediaTypeDetails:c,fileEncSha256:e,directPath:f,objectId:i,fbid:j,pathRedirected:k,eventFlow:a,plaintextHash:h}));if(b.success!==!0)return b;e=(yield d("WADecryptMedia").decryptMedia({mediaKey:g,mediaTypeDetails:c,plaintextHash:h,ciphertextHmac:b.value}));if(e.success!==!0)return e;e.value.alternativeHmacSaltUsed!=null&&a.addAnnotations({string:{alternativeHmacSaltUsed:e.value.alternativeHmacSaltUsed}});return d("WAResultOrError").makeResult(e.value.plaintext)});return h.apply(this,arguments)}g.downloadAndDecryptMedia=a}),98);
__d("WAProgressiveJpegAlignScanLengths",["WAAlignChunkLengthsToMultipleOfAesBlockSize"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.scanLengths;a=a.totalEncryptedBytes;return d("WAAlignChunkLengthsToMultipleOfAesBlockSize").alignChunkLengthsToMultipleOfAesBlockSize(b.map(function(a){return a}),a).map(function(a){return a})}function b(a){return a}g.progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize=a;g.toProgressiveJpegAlignedScanLength=b}),98);
__d("WAProgressiveJpegGetPJpegDetails",["WAMediaCrypto","WAProgressiveJpegAlignScanLengths","WAProgressiveJpegGetScanLengths","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg has too few scans"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar size mismatch"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar is missing"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar has an invalid length"]);k=function(){return a};return a}var l=d("WATagsLogger").TAGS(["WAProgressiveJpegDetails"]);function a(a){var b=a.progressiveJpegDetails;a=a.ciphertextLength;return babelHelpers["extends"]({},b,{alignedScanLengths:d("WAProgressiveJpegAlignScanLengths").progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize({scanLengths:b.scanLengths,totalEncryptedBytes:a})})}function c(a,b,c){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e=b.byteLength-d("WAMediaCrypto").IV_LENGTH;a=d("WAProgressiveJpegGetScanLengths").getProgressiveJpegScanLengths(a);e=d("WAProgressiveJpegAlignScanLengths").progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize({scanLengths:a,totalEncryptedBytes:e});e=(yield n(e,b,c));return{scanLengths:a,sidecar:e}});return m.apply(this,arguments)}function n(a,b,c){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e=new Uint8Array(a.length*10),f=0,g=0,h=b.slice(0,16);b=b.slice(16);for(var i=0;i<a.length;i++){var j=a[i];g=f+j;j=b.subarray(f,g);var k=(yield d("WAMediaCrypto").hmacCiphertext(c,h,j)).slice(0,10);e.set(new Uint8Array(k),i*10);h=j.slice(j.length-16,j.length);f=g}return e.buffer});return o.apply(this,arguments)}function p(a){if(a.sidecar.byteLength%d("WAMediaCrypto").HMAC_LENGTH!==0){l.ERROR(k());return d("WAResultOrError").makeError("pjpeg-check-sidecar-invalid-length")}if(a.scanLengths.length>0&&a.sidecar.byteLength===0){l.ERROR(j());return d("WAResultOrError").makeError("pjpeg-check-no-sidecar")}if(a.scanLengths.length===0)return d("WAResultOrError").makeResult(!1);if(a.scanLengths.length*d("WAMediaCrypto").HMAC_LENGTH!==a.sidecar.byteLength){l.ERROR(i());return d("WAResultOrError").makeError("pjpeg-check-scan-length-mismatch")}if(a.scanLengths.length<3){l.WARN(h());return d("WAResultOrError").makeError("pjpeg-too-few-scans")}return d("WAResultOrError").makeResult(!0)}function e(a,b){var c=0;if(b===0)return 0;for(var d=0;d<b;d++){var e=a[d];e!=null&&(c+=e)}return c}function f(a){a=a.progressiveJpegDetails;if(a==null)return d("WAResultOrError").makeResult(null);var b=p(a);if(b.success===!1)return b;return b.value===!0?d("WAResultOrError").makeResult({scanLengths:a.scanLengths,sidecar:a.sidecar}):d("WAResultOrError").makeResult(null)}g.getExtendedProgressiveJpegDetails=a;g.getProgressiveJpegDetails=c;g.isValidProgressiveJpegDetails=p;g.getTotalByteSizeForScan=e;g.maybeGetProgressiveJpegDetailsUsingMediaEntry=f}),98);
__d("WADownloadDownloadablePreview",["WADownloadMedia","WAGlobals","WAMediaCrypto","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WAStartMediaDownloadQplFlow","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["finished downloading"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["failed to download media. Reason: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - unsupported preview media type ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - mediaEntryData "," is incomplete for media preview"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["DownloadableThumbnail exists. Attempting to download."]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["No downloadableThumbnail. Skipping..."]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["thumbnail_available: ",""]);n=function(){return a};return a}var o=d("WADownloadMedia").mediaDownloadLogger.TAGS(["DownloadDownloadablePreview"]);function a(a,b,c,d,e,f,g){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g,p){var q=g.handleMediaPreviewBeforeDownload,r=g.handleMediaPreviewDownloadFailed;g=g.updateMediaEntryForMsg;var s=e.downloadableThumbnail,t=s==null?void 0:s.directPath,u=t!=null,v=d("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(e);o.LOG(n(),u);if(s==null||t==null){o.LOG(m());return d("WAResultOrError").makeError("preview-not-supported")}o.LOG(l());u=s.fileEncSha256;var w=s.fileSha256,x=s.mediaKey;s=s.objectId;f=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({protocolMsgId:a,downloadEntry:f,msgType:null,triggerUIView:p,isPreview:!0});f.addAnnotations({bool:{duplicateDirectPath:t===e.directPath,isMediaFallbackToAlternativeHmacSaltsEnabled:d("WAGlobals").getConfig().isMediaFallbackToAlternativeHmacSaltsEnabled(),isProgressiveJpeg:v.success===!0,hasObjectId:s!=null},string:{mediaType:"preview",fullSizeMediaType:e.serverMediaType}});f.addPoint("wa_protocol_media_download_start");if(t==null||u==null||w==null||x==null){o.ERROR(k(),e);f.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"preview-incomplete-media-entry"}});return d("WAResultOrError").makeError("media-entry-invalid")}p=d("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(c);if(p==null){o.ERROR(j(),c);f.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"preview-unsupported-type"}});return d("WAResultOrError").makeError("request-error")}yield q(b);v=(yield d("WADownloadMedia").downloadMediaImpl({protocolMsgId:a,downloadFlow:f,mediaTypeDetails:{messageType:p,type:"preview"},directPath:t,fileEncSha256:u,fileSha256:w,mediaKey:x,objectId:s,fbid:null,mediaEntry:e,dbCallbacks:{updateMediaEntryForMsg:g}}));if(v.success===!1){o.WARN(i(),v.error);void r(b,v.error);f.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:v.error}});return v}else{o.LOG(h());f.addPoint("wa_protocol_media_download_end");f.endSuccess();return d("WAResultOrError").makeResult(v.value)}});return p.apply(this,arguments)}g.maybeDownloadDownloadablePreview=a}),98);
__d("WAMediaProgressiveJpegTransformStream",["WABinary"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.scanLengths,c=[];a=0;for(var e=b,f=Array.isArray(e),g=0,e=f?e:e[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var h;if(f){if(g>=e.length)break;h=e[g++]}else{g=e.next();if(g.done)break;h=g.value}h=h;a+=h;c.push(a)}var i=new(d("WABinary").Binary)(),j=0,k=0;h=new TransformStream({transform:function(a,d){a=a;k+=a.byteLength;i.writeByteArray(a);for(;j<b.length&&c[j]<k;j++){a=i.readByteArray(b[j]);void d.enqueue(a)}},flush:function(a){void a.enqueue(i.readByteArray())}});return h}g.makeProgressiveJpegHandlerTransformStream=a}),98);
__d("WADownloadProgressiveJpegPlaintextStreamerWithoutRetry",["WACreateMediaDecrypterStream","WAHttpDownloadMedia","WAMediaCrypto","WAMediaProgressiveJpegTransformStream","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Content-Length header is not a number"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Content-Length header is missing"]);i=function(){return a};return a}var j=d("WATagsLogger").TAGS(["WADownloadProgressiveJpegPlaintextStreamer"]);function a(a){return a}function c(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.abortSignal,c=a.serverMediaType,e=a.downloadUrl,f=a.eventFlow,g=a.progressiveJpegDetails,k=a.mediaKey;a=a.cachePolicy;e=(yield d("WAHttpDownloadMedia").httpDownloadMedia(e,{mediaMetrics:f,abortSignal:b,cachePolicy:a}));if(e.success!==!0)return e;f=e.value.body;if(f==null)return d("WAResultOrError").makeError("body-network-error");b=e.value.headers.get("Content-Length");if(b==null){j.ERROR(i());return d("WAResultOrError").makeError("missing-content-length-header")}a=Number(b);if(Number.isNaN(a)){j.ERROR(h());return d("WAResultOrError").makeError("invalid-content-length-header")}e=d("WAProgressiveJpegGetPJpegDetails").getExtendedProgressiveJpegDetails({progressiveJpegDetails:g,ciphertextLength:a});b=(yield d("WAMediaCrypto").computeMediaKeys(k,c));g=d("WACreateMediaDecrypterStream").createDefaultDecryptStream(b.cipherKey,b.iv,b.hmacKey,e.sidecar,e.alignedScanLengths);if(g.success!==!0)return g;a=g.value;k=d("WAMediaProgressiveJpegTransformStream").makeProgressiveJpegHandlerTransformStream(e);c=f.pipeThrough(a).pipeThrough(k);return d("WAResultOrError").makeResult(c)});return k.apply(this,arguments)}g.unsafeCastToDownloadAndDecryptPJpegStream=a;g.downloadProgressiveJpegPlaintextUsingStreamsWithoutRetry=c}),98);
__d("WADownloadProgressiveJpegPlaintextStreamer",["WAAssertUnreachable","WACreateMediaDownloadRetrier","WADownloadProgressiveJpegPlaintextStreamerWithoutRetry","WAMediaUrl","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Download with stream given up"]);h=function(){return a};return a}var i=d("WATagsLogger").TAGS(["WADownloadProgressiveJpegPlaintextStreamer"]);function a(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.abortSignal,f=a.serverMediaType,g=a.fileEncSha256,j=a.directPath,k=a.eventFlow,l=a.progressiveJpegDetails,m=a.mediaKey;a=(yield d("WACreateMediaDownloadRetrier").createMediaDownloadRetrier({directPath:j,eventFlow:k,fileEncSha256:g,mediaTypeDetails:{type:"regular",mediaType:f}}));if(!a.success)return a;a=a.value;var n=a.retrier;a=a.mediaRouteDetails;var o=a.bucket;a=(yield n.run(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,h){b=a.domain;a=d("WAMediaUrl").buildDownloadUrl(j,g,b,"manual",o);b=(yield d("WADownloadProgressiveJpegPlaintextStreamerWithoutRetry").downloadProgressiveJpegPlaintextUsingStreamsWithoutRetry({abortSignal:e,downloadUrl:a,eventFlow:k,mediaKey:m,progressiveJpegDetails:l,serverMediaType:f,cachePolicy:h>0?"no-store":"force-cache"}));if(b.success===!0)return d("WAResultOrError").makeResult(b);a=b.error;switch(a){case"http-fetch-exception":case"server-timeout":case"unspecified-http-error":case"invalid-content-length-header":case"missing-content-length-header":return d("WAResultOrError").makeError({progressMade:!0});case"access-expired":return d("WAResultOrError").makeResult(d("WAResultOrError").makeError("disconnected"));case"body-network-error":return d("WAResultOrError").makeResult(d("WAResultOrError").makeError("request-error"));case"media-not-found":case"request-error":case"download-throttled":case"signature-expired":return d("WAResultOrError").makeResult(d("WAResultOrError").makeError(a));case"missing-expected-hmacs":case"hmac-chiphertext-array-mismatch":return d("WAResultOrError").makeResult(d("WAResultOrError").makeError(a));default:a;throw c("WAAssertUnreachable")(a)}});return function(b,c,d){return a.apply(this,arguments)}}()));if(a==null){i.WARN(h());return d("WAResultOrError").makeError("max-attempts-exceeded")}return a});return j.apply(this,arguments)}g.downloadProgressiveJpegPlaintextUsingStreams=a}),98);
__d("WAPrepareMediaDownload",["Promise","WAErrorMessage","WAGetAgeBucketForMediaKeyTimestamp","WAHashUtils","WAMediaQplHelper","WAProgressiveJpegGetPJpegDetails","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media due to runtime-error: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["start download ",". mediaKeyTimestampAgeBucket: ",", size: ",", serverMediaType: ",""]);j=function(){return a};return a}var k=typeof ((c=navigator.storage)==null?void 0:c.getDirectory)==="function",l=typeof self.caches==="object",m=0;function a(a){var c=a.mediaDownloadFlow,e=a.mediaEntry,f=a.logger;a=a.hash;var g=e.mediaKeyTimestamp,n=e.size,o=e.serverMediaType,p=e.downloadableThumbnail,q=e.directPath;g=d("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(g);f.LOG(j(),d("WAHashUtils").sanitisePlaintextHash(a),g,n,o);e=(n=d("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(e).value)!=null?n:null;c.addPoint("wa_protocol_media_download_start",{string:{mediaType:o,mediaKeyTimestampAgeBucket:g,sanitisedMediaHash:d("WAHashUtils").sanitisePlaintextHash(a)},bool:{isOPFSSupported:k,isWebCacheSupported:l,duplicateDirectPath:(p==null?void 0:p.directPath)===q,hasDownloadableThumbnail:(p==null?void 0:p.directPath)!=null,isProgressiveJpeg:e!=null}});return{logDownloadResult:function(a){m++;c.addAnnotations({"int":{concurrentDownloadCount:m}});return a.then(function(a){if(a.success){var b=a.value.plaintext.byteLength;c.addPoint("wa_protocol_media_download_end",{string:{media_size:d("WAMediaQplHelper").convertIntegerSizeToStringBucket(b)}})}else c.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:a.error}});return a})["catch"](function(a){c.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:"runtime-error"}});a=d("WAErrorMessage").maybeGetMessageFromError(a);f.ERROR(i(),a);return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeError("runtime-error"))})["finally"](function(){m--})}}}g.prepareMediaDownload=a}),98);
__d("WAProgressiveJpegAddJPEGTrailingTag",["WATypedArraysConcat"],(function(a,b,c,d,e,f,g){"use strict";var h=new Uint8Array([255,217]);function a(a){return d("WATypedArraysConcat").concatTypedArrays(Uint8Array,[new Uint8Array(a),h]).buffer}g.JPEG_TRAILING_TAG=h;g.addJPEGTrailingTag=a}),98);
__d("WAStreamAsyncIterator",[],(function(a,b,c,d,e,f){"use strict";function a(a){return g.apply(this,arguments)}function g(){g=babelHelpers.wrapAsyncGenerator(function*(a){a=a.getReader();try{while(!0){var b=(yield babelHelpers.awaitAsyncGenerator(a.read())),c=b.done;b=b.value;if(c)return;yield b}}finally{a.releaseLock()}});return g.apply(this,arguments)}f.streamAsyncIterator=a}),66);
__d("WADownloadMedia",["Promise","WAByteArray","WACryptoSha256","WACryptoUtils","WADownloadAndDecryptMedia","WADownloadDownloadablePreview","WADownloadProgressiveJpegPlaintextStreamer","WADownloadProgressiveJpegPreview","WAErrorMessage","WAHashUtils","WAMediaCrypto","WAMediaUtils","WAPrepareMediaDownload","WAProgressiveJpegAddJPEGTrailingTag","WAProgressiveJpegGetPJpegDetails","WAPromiseManagement","WAResultOrError","WAStreamAsyncIterator","WATagsLogger","WATypedArraysConcat","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Exception occurred during Media Streaming: Reason: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media streaming for ProgressiveJpeg download successful. PlaintextHash: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media streaming for ProgressiveJpeg download failed due to plaintext hash mismatch. PlaintextHash: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["pjpeg stream ended before reaching previewTargetScanIndex for plaintextHash ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handling preview from scan "," for plaintextHash ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing scan "," for plaintextHash ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Targeting scanIndex "," for preview. PlaintextHash: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Using Media Streaming to download ProgressiveJpeg. PlaintextHash: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["downloadMedia: enc-hash-mismatch"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["Skipping fallback for ",". PlaintextHash: ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media Streaming failed to download progressive jpeg. Reason: ",". PlaintextHash: ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - unsupported preview media type ",""]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to get ProgressiveJpeg details: ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["mediaEntry is incomplete. ",""]);v=function(){return a};return a}var w=d("WATagsLogger").TAGS(["MediaDownload"]);function a(a){var b=a.downloadMediaMetric,c=a.hash,e=a.mediaEntry,f=a.protocolMsgId,g=a.handleMediaPreviewDownload,h=a.handleMediaPreviewBeforeDownload,i=a.handleMediaPreviewDownloadFailed;a=a.updateMediaEntryForMsg;var j=d("WAPrepareMediaDownload").prepareMediaDownload({mediaDownloadFlow:b,mediaEntry:e,hash:c,logger:w});j=j.logDownloadResult;return j(x({downloadMediaMetric:b,hash:c,mediaEntry:e,protocolMsgId:f,handleMediaPreviewDownload:g,handleMediaPreviewBeforeDownload:h,handleMediaPreviewDownloadFailed:i,updateMediaEntryForMsg:a}))}c=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=a.downloadMediaMetric,e=a.hash,f=a.mediaEntry,g=a.protocolMsgId,i=a.handleMediaPreviewDownload,j=a.handleMediaPreviewBeforeDownload,k=a.handleMediaPreviewDownloadFailed;a=a.updateMediaEntryForMsg;var l=d("WAMediaUtils").validateDecodedMediaEntryForDownload(f);if(!l.success){w.ERROR(v(),l.error);return l}var m=l.value,n=m.directPath,o=m.fileEncSha256,p=m.fileSha256,q=m.mediaKey,x=m.serverMediaType;m=d("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(f);m.success===!1&&(w.WARN(u(),m.error),c.addPoint(m.error));m=m.success===!0?m.value:null;var z=function(a){if(a==null)return(h||(h=b("Promise"))).resolve();var c=d("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(x);if(c==null){w.ERROR(t(),x);return(h||(h=b("Promise"))).resolve()}return i(e,a,c,g).then(function(){})};if(m!=null&&d("WAMediaUtils").isTransformStreamSupported()&&x==="image"){n=(yield C({directPath:n,downloadFlow:c,fileEncSha256:o,handleMediaPreviewBlob:z,hash:e,mediaKey:q,progressiveJpegDetails:m,serverMediaType:x,fileSha256:p,handleMediaPreviewBeforeDownload:j,handleMediaPreviewDownloadFailed:k}));if(n.success)return d("WAResultOrError").makeResult({mimeType:d("WAMediaUtils").getMimeTypeFromServerMediaType(x),plaintext:n.value,serverMediaType:x});else{o=n.error;w.WARN(s(),o,d("WAHashUtils").sanitisePlaintextHash(e));switch(o){case"signature-expired":case"request-error":w.LOG(r(),o,d("WAHashUtils").sanitisePlaintextHash(e));return d("WAResultOrError").makeError(o)}}}c==null?void 0:c.addPoint("fallback_to_non_streaming_download");q=B({hash:e,mediaEntry:f,progressiveJpegDetails:m,protocolMsgId:g,serverMediaType:x,handleMediaPreviewBeforeDownload:j,handleMediaPreviewDownloadFailed:k,updateMediaEntryForMsg:a,downloadEntry:c.downloadEntry,triggerUIView:c.triggerUIView});void q.then(function(a){if(a.success===!1)return z(null);else return z(a.value)});return y({downloadMediaMetric:c,mediaEntry:l.value,protocolMsgId:g,updateMediaEntryForMsg:a})});return function(b){return a.apply(this,arguments)}}();var x=d("WAPromiseManagement").cacheWhilePending(function(a){a=a.hash;return a},c),y=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.abortSignal,c=a.downloadMediaMetric,e=a.mediaEntry,f=a.protocolMsgId;a=a.updateMediaEntryForMsg;var g=e.directPath,h=e.fbid,i=e.fileEncSha256,j=e.fileSha256,k=e.mediaKey,l=e.objectId,m=e.serverMediaType;b=(yield z({abortSignal:b,protocolMsgId:f,downloadFlow:c,mediaTypeDetails:{mediaType:m,type:"regular"},directPath:g,fileEncSha256:i,fileSha256:j,mediaKey:k,objectId:l,fbid:h,mediaEntry:e,dbCallbacks:{updateMediaEntryForMsg:a}}));return b.success?d("WAResultOrError").makeResult({mimeType:d("WAMediaUtils").getMimeTypeFromServerMediaType(m),plaintext:b.value,serverMediaType:m}):b});return function(b){return a.apply(this,arguments)}}();e=d("WAPromiseManagement").cacheWhilePending(function(a){a=a.hash;return a},function(a){var b=a.hash;a=babelHelpers.objectWithoutPropertiesLoose(a,["hash"]);b=d("WAPrepareMediaDownload").prepareMediaDownload({hash:b,mediaDownloadFlow:a.downloadMediaMetric,mediaEntry:a.mediaEntry,logger:w});b=b.logDownloadResult;return b(y(a))});function z(a){return A.apply(this,arguments)}function A(){A=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=a.abortSignal,e=a.protocolMsgId,f=a.downloadFlow,g=a.mediaTypeDetails,h=a.directPath,i=a.fileEncSha256,j=a.fileSha256,k=a.mediaKey,l=a.objectId,m=a.fbid,n=a.mediaEntry,o=a.dbCallbacks.updateMediaEntryForMsg,p=d("WAHashUtils").toPlaintextHash(j);a=(yield d("WADownloadAndDecryptMedia").downloadAndDecryptMedia({abortSignal:c,directPath:h,eventFlow:f,fbid:m,fileEncSha256:i,mediaKey:k,mediaTypeDetails:g,objectId:l,pathRedirected:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(e==null)return;var b=function(){return d("WAMediaUtils").encodeMediaEntryWithUpdatedPath(n,a)};yield o(p,e,b,l,n.serverMediaType)});function c(b){return a.apply(this,arguments)}return c}(),plaintextHash:p}));if(a.success===!1){j=a.error;switch(j){case"signature-expired":case"media-not-found":return d("WAResultOrError").makeError(j);case"enc-hash-mismatch":w.ERROR(q());return d("WAResultOrError").makeError(j);default:j;return d("WAResultOrError").makeError(j)}}else{c=a.value;return d("WAResultOrError").makeResult(c)}});return A.apply(this,arguments)}function B(a){var b=a.hash,c=a.mediaEntry,e=a.progressiveJpegDetails,f=a.protocolMsgId,g=a.serverMediaType,h=a.handleMediaPreviewBeforeDownload,i=a.handleMediaPreviewDownloadFailed,j=a.updateMediaEntryForMsg,k=a.downloadEntry,l=a.triggerUIView;return e==null?d("WADownloadDownloadablePreview").maybeDownloadDownloadablePreview(f,b,g,c,k,{handleMediaPreviewBeforeDownload:h,handleMediaPreviewDownloadFailed:i,updateMediaEntryForMsg:j},l):d("WADownloadProgressiveJpegPreview").maybeDownloadProgressiveJpegPreview({protocolMsgId:f,hash:b,serverMediaType:g,mediaEntry:c,progressiveJpegDetails:e,handleMediaPreviewBeforeDownload:h,handleMediaPreviewDownloadFailed:i,downloadEntry:k,triggerUIView:l}).then(function(a){return a.success!==!0?d("WADownloadDownloadablePreview").maybeDownloadDownloadablePreview(f,b,g,c,k,{handleMediaPreviewBeforeDownload:h,handleMediaPreviewDownloadFailed:i,updateMediaEntryForMsg:j},l):a})}function C(a){return D.apply(this,arguments)}function D(){D=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.directPath,c=a.downloadFlow,e=a.fileEncSha256,f=a.fileSha256,g=a.handleMediaPreviewBlob,h=a.hash,q=a.mediaKey,r=a.progressiveJpegDetails,s=a.serverMediaType,t=a.handleMediaPreviewBeforeDownload;a=a.handleMediaPreviewDownloadFailed;var u=w.TAGS(["MediaStreaming"]);u.LOG(p(),d("WAHashUtils").sanitisePlaintextHash(h));c.addPoint("media_streaming_start");var v=d("WADownloadProgressiveJpegPreview").getPreviewTargetScan(r.scanLengths)-1;u.LOG(o(),v,d("WAHashUtils").sanitisePlaintextHash(h));c.addAnnotations({"int":{scans:r.scanLengths.length}});void t(h);t=(yield d("WADownloadProgressiveJpegPlaintextStreamer").downloadProgressiveJpegPlaintextUsingStreams({directPath:b,eventFlow:c,fileEncSha256:e,mediaKey:q,progressiveJpegDetails:r,serverMediaType:s}));if(t.success===!1){c.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:t.error}});void a(h,t.error);return t}c.addPoint("download_pjpeg_preview_start");b=[];e=0;try{q=!0;r=!1;var x;try{for(var y=babelHelpers.asyncIterator(d("WAStreamAsyncIterator").streamAsyncIterator(t.value)),s,t;s=(yield y.next()),q=s.done,t=(yield s.value),!q;q=!0){s=t;if(s==null)continue;u.LOG(n(),e,d("WAHashUtils").sanitisePlaintextHash(h));b.push(s);if(e===v){c.addPoint("media_streaming_preview_processed");u.LOG(m(),e,d("WAHashUtils").sanitisePlaintextHash(h));t=d("WAByteArray").uint8ArrayToBuffer(d("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(b,[d("WAProgressiveJpegAddJPEGTrailingTag").JPEG_TRAILING_TAG])));void g(t);c.addPoint("download_pjpeg_preview_end")}e++}}catch(a){r=!0,x=a}finally{try{!q&&y["return"]!=null&&(yield y["return"]())}finally{if(r)throw x}}e<v&&(u.ERROR(l(),d("WAHashUtils").sanitisePlaintextHash(h)),c.addPoint("download_pjpeg_preview_fail"));s=d("WAByteArray").uint8ArrayToBuffer(d("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(b)));t=(yield d("WACryptoSha256").sha256(s));if(!d("WACryptoUtils").arrayBuffersEqual(f,t)){u.WARN(k(),d("WAHashUtils").sanitisePlaintextHash(h));c.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:"hash-mismatch"}});return d("WAResultOrError").makeError("hash-mismatch")}u.LOG(j(),d("WAHashUtils").sanitisePlaintextHash(h));c.addPoint("media_streaming_end");return d("WAResultOrError").makeResult(s)}catch(b){u.ERROR(i(),b);e<v&&(c.addPoint("download_pjpeg_preview_fail"),void a(h,d("WAErrorMessage").maybeGetMessageFromError(b)));c==null?void 0:c.addPoint("media_streaming_fail",{string:{wa_media_download_streaming_fail_reason:d("WAErrorMessage").maybeGetMessageFromError(b)}});return d("WAResultOrError").makeError("stream-error")}});return D.apply(this,arguments)}g.mediaDownloadLogger=w;g.downloadMedia=a;g.downloadFullMediaOnly=y;g.cachedDownloadFullMediaOnly=e;g.downloadMediaImpl=z}),98);
__d("WADownloadProgressiveJpegPlaintext",["WADownloadCiphertext","WAMediaCrypto","WAProgressiveJpegAddJPEGTrailingTag","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["ProgressiveJpeg download and decrypt successful. Partial: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Error ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Using progressiveJpeg decryptAndVerify"]);j=function(){return a};return a}var k=d("WATagsLogger").TAGS(["DownloadProgressiveJpeg"]);function a(a){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.abortSignal,c=a.mediaTypeDetails,e=a.fileEncSha256,f=a.directPath,g=a.mediaKey,h=a.eventFlow,i=a.pathRedirected,j=a.progressiveJpegDetails,k=a.targetScan,l=a.plaintextHash;a=a.size;j=d("WAProgressiveJpegGetPJpegDetails").getExtendedProgressiveJpegDetails({progressiveJpegDetails:j,ciphertextLength:o(a)});a=d("WAProgressiveJpegGetPJpegDetails").getTotalByteSizeForScan(j.alignedScanLengths,k);b=(yield d("WADownloadCiphertext").cachedDownloadCiphertext({abortSignal:b,mediaTypeDetails:c,fileEncSha256:e,directPath:f,pathRedirected:i,fromBytes:0,toBytes:a-1,eventFlow:h,plaintextHash:l}));return b.success!==!0?b:m(g,c,k,j,b.value)});return l.apply(this,arguments)}function m(a,b,c,d,e){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f){k.LOG(j());var g=new Uint8Array(f);b.type==="preview"?f=d("WAMediaCrypto").computeMediaKeysForPreview(a):f=d("WAMediaCrypto").computeMediaKeys(a,b.mediaType);a=(yield f.then(function(a){var b=a.iv,f=a.cipherKey;a=a.hmacKey;return d("WAMediaCrypto").decryptPartialChunks(f,b,g,a,c,e)}).then(d("WAResultOrError").makeResult)["catch"](function(a){k.ERROR(i(),a);if(a instanceof d("WAMediaCrypto").HmacValidationError)return d("WAResultOrError").makeError("enc-hash-mismatch");else return d("WAResultOrError").makeError("decryption-error")}));if(!a.success)return a;k.LOG(h(),c<e.scanLengths.length);b=d("WAProgressiveJpegAddJPEGTrailingTag").addJPEGTrailingTag(a.value.plaintext);return d("WAResultOrError").makeResult(b)});return n.apply(this,arguments)}function o(a){if(a==null)return null;var b=d("WAMediaCrypto").CBC_BLOCK_SIZE-a%d("WAMediaCrypto").CBC_BLOCK_SIZE;return a+b+d("WAMediaCrypto").HMAC_LENGTH}g.downloadProgressiveJpegPlaintext=a}),98);
__d("WAProgressiveJpegGetTargetScanLengthForBytes",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=0,d=0;for(var e=0;e<a.length;e++){d=e+1;c+=a[e];if(c>=b)break}return d}f.getTargetScanBasedOnByteSize=a}),66);
__d("WADownloadProgressiveJpegPreview",["WADownloadMedia","WADownloadProgressiveJpegPlaintext","WAGlobals","WALoggerTag","WAProgressiveJpegGetTargetScanLengthForBytes","WAResultOrError","WAStartMediaDownloadQplFlow","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Finished progressiveJpeg preview download"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Starting progressiveJpeg preview download"]);i=function(){return a};return a}var j=d("WADownloadMedia").mediaDownloadLogger.TAGS([c("WALoggerTag").MediaPreview]),k=3;function a(a){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.protocolMsgId,c=a.hash,e=a.serverMediaType,f=a.mediaEntry,g=a.progressiveJpegDetails,k=a.handleMediaPreviewBeforeDownload,l=a.handleMediaPreviewDownloadFailed,n=a.downloadEntry;a=a.triggerUIView;var o=f.directPath,p=f.fileEncSha256,q=f.mediaKey,r=f.size;if(o==null||p==null||q==null)return d("WAResultOrError").makeError("pjpeg-failed");b=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({protocolMsgId:b,downloadEntry:n,isPreview:!0,msgType:null,triggerUIView:a});b.addAnnotations({bool:{isMediaFallbackToAlternativeHmacSaltsEnabled:d("WAGlobals").getConfig().isMediaFallbackToAlternativeHmacSaltsEnabled(),isProgressiveJpeg:!0},string:{mediaType:"preview",fullSizeMediaType:f.serverMediaType},"int":{mediaEntrySize:f.size}});j.LOG(i());b.addPoint("wa_protocol_media_download_start");n=d("WAGlobals").getConfig().pjpegPreviewAvoidLastScan()===!0?g.scanLengths.length-1:g.scanLengths.length;a=Math.min(m(g.scanLengths,r),n);yield k(c);f=(yield d("WADownloadProgressiveJpegPlaintext").downloadProgressiveJpegPlaintext({directPath:o,eventFlow:b,fileEncSha256:p,mediaKey:q,mediaTypeDetails:{mediaType:e,type:"regular"},progressiveJpegDetails:g,plaintextHash:c,targetScan:a,size:r}));if(!f.success){void l(c,f.error);b.endFail("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:f.error}});return d("WAResultOrError").makeError("pjpeg-failed")}n=f.value;j.LOG(h());b.addPoint("wa_protocol_media_download_end");b.endSuccess();return d("WAResultOrError").makeResult(n)});return l.apply(this,arguments)}function m(a,b){var c=d("WAGlobals").getConfig().jpegThumbnailTargetByteSizeKB()*1024;c=d("WAProgressiveJpegGetTargetScanLengthForBytes").getTargetScanBasedOnByteSize(a,c);(b==null||b===0)&&(c=Math.min(c,a.length-1));c=Math.max(c,k);return c}function e(a){var b=a.abortSignal,c=a.hash,e=a.serverMediaType,f=a.mediaEntry;a=a.progressiveJpegDetails;var g=f.directPath,h=f.fileEncSha256,i=f.mediaKey;f=f.size;var j=d("WAGlobals").getConfig().pjpegPreviewAvoidLastScan()===!0?a.scanLengths.length-1:a.scanLengths.length;j=Math.min(m(a.scanLengths,f),j);return d("WADownloadProgressiveJpegPlaintext").downloadProgressiveJpegPlaintext({abortSignal:b,directPath:g,fileEncSha256:h,mediaKey:i,mediaTypeDetails:{mediaType:e,type:"regular"},progressiveJpegDetails:a,plaintextHash:c,targetScan:j,size:f})}g.maybeDownloadProgressiveJpegPreview=a;g.getPreviewTargetScan=m;g.maybeDownloadProgressiveJpegPreviewV2=e}),98);