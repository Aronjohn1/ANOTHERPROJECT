;/*FB_PKG_DELIM*/

__d("ArmadilloReceiveWriteDbSuccessFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5721");b=d("FalcoLoggerInternal").create("armadillo_receive_write_db_success",a);e=b;g["default"]=e}),98);
__d("EBgenerateMPSMessageQuery",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){return{__typename:"MPSMessageQuery",ctx:{__typename:"MPSQueryContext",caller:"HISTORY_RESTORE"},query:{__typename:"MPSMessagePointQuery",include_deleted:!1,otids:b,thread_id:a}}}f.generateMPSMessageQuery=a}),66);
__d("EBMessageBulkPointQuery",["Base64Utils","EBAPIQPLPoints","EBAPISharedUtils","EBAPIWorkerCheck","EBIsEbEnabled","EBMessagePointQueryWithPersistence","EBgenerateMPSMessageQuery","I64","LSMEBTaskCreationSource","LSVec","MAWCurrentUser","QPLUserFlow","WAHashStringToNumber","WALogger","WAPushSafeTypes","WAResultOrError","WorkerRelay","asyncToGeneratorRuntime","cr:9437","handleRestoreMessagesGraphQLResponse","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] graphQL bulk point restore error ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mandatory params of client state are null"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No client state found - unable to restore"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Calling EBLS without EBLS being available for message bulk point query"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] GQL bulk point query called from non-worker context"]);m=function(){return a};return a}function a(a){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(!d("EBAPIWorkerCheck").runningInWorker()){d("WALogger").ERROR(m());return d("WAResultOrError").makeError("called-from-main-thread")}d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.bulkpoint.search.gql");a=d("WAPushSafeTypes").unsafeNotNullable(a);var e=a.chatJid,f=a.messageIds,g=a.sortOrderMsList,n=a.source,o=a.threadId;a=a.traceId;var p=a!=null?d("WAHashStringToNumber").hashStringToNumber(a):void 0,q=c("qpl")._(521482281,"2703");try{var r;c("QPLUserFlow").start(q,{annotations:{bool:{bulkPointQuery:!0,mainThreadRestore:!1,workerThreadRestore:!0},"int":{source:(r=n)!=null?r:c("LSMEBTaskCreationSource").UNKNOWN}},instanceKey:p});if(b("cr:9437")==null){d("WALogger").ERROR(l());c("QPLUserFlow").endFailure(q,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.EBLS_NOT_INITIALIZED,{instanceKey:p});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.bulkpoint.search.gql.error");return d("WAResultOrError").makeError("ebls-not-intialized")}yield b("cr:9437").init();r=(yield b("cr:9437").getLSStorage());if(!(yield d("EBIsEbEnabled").isEbEnabledLS(r.tables))){c("QPLUserFlow").addPoint(q,"eb_not_enabled",{instanceKey:p});c("QPLUserFlow").endSuccess(q,{instanceKey:p});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.bulkpoint.search.gql.error");return d("WAResultOrError").makeError("eb-not-enabled")}var s=(yield d("handleRestoreMessagesGraphQLResponse").getClientState(r));if(s==null){d("WALogger").ERROR(k());c("QPLUserFlow").endFailure(q,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{instanceKey:p});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.bulkpoint.search.gql.error");return d("WAResultOrError").makeError("no-client-state")}var t=s.backupId,u=s.device_id,v=s.locally_available_epochs,w=s.mailboxRootKey;s=s.ocmfClientStateBlob;if(t==null||u==null||w==null||s==null){d("WALogger").ERROR(j());c("QPLUserFlow").endFailure(q,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{instanceKey:p});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.bulkpoint.search.gql.error");return d("WAResultOrError").makeError("invalid-client-state")}var x=d("MAWCurrentUser").getAppID();v={restore_context:{act_thread_id:o,site:"www",tam_thread_subtype:0},success:{device_context:{device_id:(h||(h=d("I64"))).to_string(u),locally_available_epochs:v,raw_tokens:{mailbox_root_key:d("Base64Utils").fromArrayBuffer(w),ocmf_client_state_blob:d("Base64Utils").fromArrayBuffer(s)}},mps_message_query:JSON.stringify(d("EBgenerateMPSMessageQuery").generateMPSMessageQuery(o,f))}};if(g!=null){w=c("LSVec").ofArray(g.map(function(a){return(h||(h=d("I64"))).of_string(""+a)}));v=babelHelpers["extends"]({},v,{sort_order_ms_list:w})}c("QPLUserFlow").addPoint(q,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START,{instanceKey:p});f=(yield d("WorkerRelay").createWorkerQuery(d("EBMessagePointQueryWithPersistence").pointRestoreQuery,{app_id:String((s=x)!=null?s:"0"),restore_payload_string:JSON.stringify(v),restore_type:"MESSAGE_QUERY_RESTORE"}));g=(yield d("EBAPISharedUtils").constructEBRestoreResponse(f,!0,q,r,p,u,o,e,n,a,void 0,t));if(g.success){d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.bulkpoint.search.gql.success");return d("WAResultOrError").makeResult(g.response)}else{d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.bulkpoint.search.gql.error");return d("WAResultOrError").makeError(g.response)}}catch(a){d("WALogger").ERROR(i(),a);c("QPLUserFlow").endFailure(q,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{error:a,instanceKey:p});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.bulkpoint.search.gql.error");return d("WAResultOrError").makeError("runtime-error",a)}});return n.apply(this,arguments)}g.messageBulkPointQuery=a}),98);
__d("EBMessageRangeQueryForIndexingImpl",["EBAPIQPLPoints","EBAPISharedUtils","EBIsEbEnabled","EBMessageRangeQueryWithPersistence","I64","LSEncryptedBackupsBackupTenancy","LSEncryptedBackupsMessagesRangeQueryDirection","LSIntEnum","LSMEBTaskCreationSource","MAWCurrentUser","MAWEncryptedBackupUtils","MAWJobDefinitions","QPLUserFlow","WABase64","WAHashStringToNumber","WAJids","WAPushSafeTypes","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","gkx","handleRestoreMessagesGraphQLResponse","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["mandatory params of client state are null"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["No client state found - unable to restore"]);k=function(){return a};return a}var l=d("WATagsLogger").TAGS(["labyrinth_web","EBMessageRangeQueryForIndexing"]);function a(a,b,c){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){var f;d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.range.search.gql");var g=d("WAPushSafeTypes").unsafeNotNullable(e),m=g.chatJid,n=g.direction,o=g.sortOrderMs,p=g.source;g=g.traceId;var q=g!=null?d("WAHashStringToNumber").hashStringToNumber(g):void 0,r=c("qpl")._(521476367,"2704"),s;if(c("gkx")("3713"))s=!(yield d("EBIsEbEnabled").isEbEnabledLS(b.tables));else{var t=(yield d("MAWEncryptedBackupUtils").getBackupTenancy(b.tables));s=t==null||!(h||(h=d("I64"))).equal(t,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsBackupTenancy").PRODUCTION))}if(s){c("QPLUserFlow").addPoint(r,"eb_not_enabled",{instanceKey:q});c("QPLUserFlow").endSuccess(r,{instanceKey:q});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.range.search.gql.error");return d("WAResultOrError").makeError("eb-not-enabled")}t=(yield d("handleRestoreMessagesGraphQLResponse").getClientState(b));c("QPLUserFlow").addPoint(r,"client_state_retrieved",{data:{string:{device_id:(h||(h=d("I64"))).to_string((s=t==null?void 0:t.device_id)!=null?s:(h||(h=d("I64"))).zero)}},instanceKey:q});if(t==null){l.ERROR(k());c("QPLUserFlow").endFailure(r,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{instanceKey:q});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.range.search.gql.error");return d("WAResultOrError").makeError("no-client-state")}s=t.backupId;var u=t.device_id,v=t.locally_available_epochs,w=t.mailboxRootKey;t=t.ocmfClientStateBlob;if(s==null||u==null||w==null||t==null){l.ERROR(j());c("QPLUserFlow").endFailure(r,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{instanceKey:q});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.range.search.gql.error");return d("WAResultOrError").makeError("invalid-client-state")}var x=d("MAWCurrentUser").getAppID(),y=d("WAJids").threadIdForChatJid(m);n=n==="before"?c("LSEncryptedBackupsMessagesRangeQueryDirection").BEFORE:c("LSEncryptedBackupsMessagesRangeQueryDirection").AFTER;f={restore_context:{act_thread_id:d("MAWJobDefinitions").toThreadJidPrimaryId(y),site:"www",source:(f=p)!=null?f:c("LSMEBTaskCreationSource").UNKNOWN,tam_thread_subtype:0},success:{device_context:{device_id:h.to_string(u),locally_available_epochs:v,raw_tokens:{mailbox_root_key:d("WABase64").encodeB64(w),ocmf_client_state_blob:d("WABase64").encodeB64(t)}},direction:n,include_offset:c("gkx")("5340"),query_num_messages:e.numMessages,server_thread_key:y}};if(o!=null){v=f.success;f.success=babelHelpers["extends"]({},v,{reference_timestamp:o});f=babelHelpers["extends"]({},f,{success:f.success})}if(p!=null){w=f.success;f.success=babelHelpers["extends"]({},w,{source:p});f=babelHelpers["extends"]({},f,{success:f.success})}c("QPLUserFlow").addPoint(r,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START,{instanceKey:q});n=(yield a(d("EBMessageRangeQueryWithPersistence").query,{app_id:String((t=x)!=null?t:"0"),restore_payload_string:JSON.stringify(f),restore_type:"RANGE_QUERY_RESTORE"}));e=(yield d("EBAPISharedUtils").constructEBRestoreResponse(n,!0,r,b,q,u,y,m,p,g,o,s));if(e.success){d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.range.search.gql.success");return d("WAResultOrError").makeResult(e.response)}else{d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.range.search.gql.error");return d("WAResultOrError").makeError(e.response)}});return m.apply(this,arguments)}g.messageRangeQueryForIndexingImpl=a}),98);
__d("createMainThreadQuery",["FBLogger","IGDWebUtils","MAWRotateDTSG","WARetryableError","asyncToGeneratorRuntime","err","executeGraphQLQuery","relay-runtime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a=a.getNetwork();a={execute:a.execute};return a}function e(a,b,c){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){var f=d("relay-runtime").getRequest(a);if(f.params.operationKind!=="query")throw c("err")("createWorkerQuery: Expected query operation");var g=d("IGDWebUtils").isOnInstagramWeb();f=(yield d("executeGraphQLQuery").executeGraphQLQuery(e,a,b).then(function(a){return a.toPromise()}).then(function(a){return Array.isArray(a)?a[0].data:(a=a.data)!=null?a:null})["catch"](function(a){if(("code"in a&&a.code===1357004||"message"in a&&a.message.indexOf("1357004")!==-1||typeof a==="string"&&a.indexOf("1357004")!==-1)&&!g){c("FBLogger")("messenger_e2ee_web").info("Failed with expired DTSG, attempting to rotate.");return d("MAWRotateDTSG").tryRotateDTSG().then(function(b){if(b)throw new(c("WARetryableError"))(a);throw a})}throw a}));return f});return h.apply(this,arguments)}g.getWorkerLikeRelayEnvironment=a;g.createMainThreadQuery=e}),98);
__d("EBMessageRangeQueryForIndexing",["EBAPIQPLPoints","EBAPISharedUtils","EBAPIWorkerCheck","EBMessageRangeQueryForIndexingImpl","LSDatabaseSingleton","LSMEBTaskCreationSource","Promise","QPLUserFlow","WAHashStringToNumber","WAResultOrError","WATagsLogger","WorkerRelay","asyncToGeneratorRuntime","createMainThreadQuery","ifRequireable","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["graphQL range restore error ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Calling EBLS without EBLS being available for message range query"]);k=function(){return a};return a}var l=c("requireDeferred")("CometRelayEnvironment").__setRef("EBMessageRangeQueryForIndexing"),m=d("WATagsLogger").TAGS(["labyrinth_web","EBMessageRangeQueryForIndexing"]);function a(a){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e,f=a.traceId!=null?d("WAHashStringToNumber").hashStringToNumber(a.traceId):void 0,g=c("qpl")._(521476367,"2704");c("QPLUserFlow").start(g,{annotations:{bool:{mainThreadRestore:!1,rangeQueryForIndexing:!0,workerThreadRestore:!0},"int":{source:(e=a.source)!=null?e:c("LSMEBTaskCreationSource").UNKNOWN}},instanceKey:f});try{if(d("EBAPIWorkerCheck").runningInWorker()){e=new(i||(i=b("Promise")))(function(a,b){return c("ifRequireable")("EBLS",function(b){b=b.getLSStorage;return a(b())},function(){return a(null)})});e=(yield e);if(e==null){m.ERROR(k());c("QPLUserFlow").endFailure(g,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.EBLS_NOT_INITIALIZED,{instanceKey:f});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.range.search.gql.error");return d("WAResultOrError").makeError("ebls-not-intialized")}else{e=(yield d("EBMessageRangeQueryForIndexingImpl").messageRangeQueryForIndexingImpl(d("WorkerRelay").createWorkerQuery,e,a));return e}}else{var n=(yield (h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton);return l.load().then(function(b){var c=function(a,c){var e=d("createMainThreadQuery").getWorkerLikeRelayEnvironment(b);return d("createMainThreadQuery").createMainThreadQuery(a,c,e)};return d("EBMessageRangeQueryForIndexingImpl").messageRangeQueryForIndexingImpl(c,n,a)})}}catch(a){m.ERROR(j(),a);c("QPLUserFlow").endFailure(g,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{error:a,instanceKey:f});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.range.search.gql.error");return d("WAResultOrError").makeError("runtime-error",a)}});return n.apply(this,arguments)}g.messageRangeQueryForIndexing=a}),98);
__d("EBUploadDeletedMessage",["EncryptedBackupsUploadQueue","I64","MAWUserJidWrapper","WAAsMessageApplication","WAJids","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.instanceKey,c=a.msgId,e=a.sender,f=a.serverTs;a=a.sortOrderMs;try{yield d("EncryptedBackupsUploadQueue").putMsgsToEbUpload([{backupDirective:{actionType:3,originalMsgProtocolId:c},instanceKey:b,messageApplication:d("WAAsMessageApplication").castToMessageApplicationBytes(new Uint8Array(0)),msgId:c,originalMsgProtocolId:c,reportingMeta:null,senderId:(h||(h=d("I64"))).of_string(d("WAJids").authorToUserId(e,d("WAJids").extractUserId(d("MAWUserJidWrapper").getMyUserJid()))),serverTs:f,sortOrderMs:a,triggerSource:"upload-deleted-message"}])}catch(a){return d("WAResultOrError").makeError("runtime-error",a)}return d("WAResultOrError").makeResult()});return i.apply(this,arguments)}g.uploadDeletedMessage=a}),98);
__d("EncryptedBackupsConvertToLegacyAttachmentContext",["MAWCastToMsgrServerMediaType","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["invalid "," media type for legacy attachment upload"]);h=function(){return a};return a}function a(a){var b=[];for(var c=0;c<a.length;c++){var e=a[c],f=d("MAWCastToMsgrServerMediaType").castMediaAttachmentTypeToServerMediaType(e.mediaType);f==null?d("WALogger").ERROR(h(),e.mediaType):b.push({mediaObjectId:e.mediaObjectId,mediaType:f})}return b}g["default"]=a}),98);
__d("EncryptedBackupsCastToAttachmentContextMediaType",["EncryptedBackupsUploadEntity","MAWDbMedia","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid AttachmentContextMediaType: ",""]);h=function(){return a};return a}function a(a){switch(a){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:return d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE;case d("MAWDbMedia").MEDIA_TYPE.VIDEO:return d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO;case d("MAWDbMedia").MEDIA_TYPE.PTT:return d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT;case d("MAWDbMedia").MEDIA_TYPE.GIF:return d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF;case d("MAWDbMedia").MEDIA_TYPE.STICKER:return d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.STICKER;case d("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT;default:a;d("WALogger").ERROR(h(),a);return d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.INVALID}}g["default"]=a}),98);
__d("EncryptedBackupsGetAttachmentContextForReceivedMsg",["EncryptedBackupsCastToAttachmentContextMediaType","EncryptedBackupsUploadEntity","WAMediaUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,e=new Map();if(((b=a.decodedMsg)==null?void 0:b.unstoredDbMedia)!=null){b=(b=a.decodedMsg)==null?void 0:b.unstoredDbMedia;var f=b.mediaType;b=d("WAMediaUtils").decodeMediaEntryData(b.mediaEntry);var g=b.downloadableThumbnail;b=b.objectId;g=g==null?void 0:g.objectId;f=c("EncryptedBackupsCastToAttachmentContextMediaType")(f);b!=null&&f!=null&&e.set(d("WAMediaUtils").stringToDeliveryObjectId(b),f);g!=null&&g!==b&&e.set(d("WAMediaUtils").stringToDeliveryObjectId(g),d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW)}if(((f=a.decodedMsg)==null?void 0:f.unstoredXMA)!=null){g=(b=a.decodedMsg)==null?void 0:b.unstoredXMA;if(g.unstoredFavicon!=null){f=d("WAMediaUtils").decodeMediaEntryData(g.unstoredFavicon.mediaEntry);a=f.objectId;a!=null&&e.set(d("WAMediaUtils").stringToDeliveryObjectId(a),d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)}if(g.unstoredHeaderMedia!=null){b=d("WAMediaUtils").decodeMediaEntryData(g.unstoredHeaderMedia.mediaEntry);f=b.objectId;f!=null&&e.set(d("WAMediaUtils").stringToDeliveryObjectId(f),d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)}if(g.unstoredAssociatedMedia!=null){a=d("WAMediaUtils").decodeMediaEntryData(g.unstoredAssociatedMedia.mediaEntry);b=a.objectId;b!=null&&e.set(d("WAMediaUtils").stringToDeliveryObjectId(b),d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)}g.unstoredPreviews!=null&&g.unstoredPreviews.length>0&&g.unstoredPreviews.forEach(function(a){a=a.mediaEntry;a=d("WAMediaUtils").decodeMediaEntryData(a);a=a.objectId;a!=null&&e.set(d("WAMediaUtils").stringToDeliveryObjectId(a),d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)})}return Array.from(e.entries()).map(function(a){var b=a[0];a=a[1];return{mediaObjectId:b,mediaType:a}})}g["default"]=a}),98);
__d("MessageBackupDirectiveGenerator",["FBLogger","I64","MAWJids","MAWMsgType","MessageBackupSupplementalKeyGenerator","WAGlobals","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){a=d("MessageBackupSupplementalKeyGenerator").createReactionSupplementalKey(a);if(a!=null)return a;throw c("FBLogger")("labyrinth_web").mustfixThrow("Failed to create reaction supplemental key")}function j(a,b){a=d("MessageBackupSupplementalKeyGenerator").createEditSupplementalKey(a,b);if(a!=null)return a;throw c("FBLogger")("labyrinth_web").mustfixThrow("Failed to create edit supplemental key")}function k(a,b){b=d("MAWJids").toUserJid((h||(h=d("I64"))).to_string(b).toString());return{actionType:2,originalMsgProtocolId:a,supplementalKey:i(b)}}function l(a,b,c){b=d("MAWJids").toUserJid((h||(h=d("I64"))).to_string(b).toString());return{actionType:2,originalMsgProtocolId:a,supplementalKey:j(b,c)}}function m(a){if(d("WAJids").isAuthorSystem(a.author))return null;if(a.reactToExternalId!=null)return{author:a.reactToAuthor===d("WAGlobals").getMyUserJid()?"@me":a.reactToAuthor,chat:a.threadJid,externalId:a.reactToExternalId};else if(a.originalMsgExternalId!=null)return{author:a.author,chat:a.threadJid,externalId:a.originalMsgExternalId};else if(a.revokedExternalId!=null)return{author:a.author,chat:a.threadJid,externalId:a.revokedExternalId};return a.externalId==null?null:{author:a.author,chat:a.threadJid,externalId:a.externalId}}function a(a){var b=(h||(h=d("I64"))).of_string(d("WAJids").authorToUserId(a.author,d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()))),e=m(a);if(e==null)return null;if(a.originalMsgExternalId!=null){if(a.editTs==null){c("FBLogger")("labyrinth_web").mustfix("editTs is null for edit message during createMessageBackupDirectiveFromDbMsg");return null}return l(e,b,d("WATimeUtils").castUnixTimeToMillisTime(a.editTs))}return a.reactToExternalId!=null?k(e,b):n(e,b,a.type,null)}function n(a,b,e,f){switch(e){case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.XMA:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:case d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:return{actionType:1,originalMsgProtocolId:a};case d("MAWMsgType").MSG_TYPE.REACTION:return k(a,b);case d("MAWMsgType").MSG_TYPE.EDIT_ACTION:if(f==null)throw c("FBLogger")("labyrinth_web").mustfixThrow("editTs is null for edit message during createMessageBackupDirective");return l(a,b,f);case d("MAWMsgType").MSG_TYPE.REVOKED:return{actionType:4,originalMsgProtocolId:a};case d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:return{actionType:3,originalMsgProtocolId:a};default:c("FBLogger")("labyrinth_web").mustfix("Unsupported message type %s",e);return{actionType:0,originalMsgProtocolId:a}}}g.createMessageBackupDirectiveFromDbMsg=a;g.createMessageBackupDirective=n}),98);
__d("MessageBackupDirectiveTypes",[],(function(a,b,c,d,e,f){"use strict";function a(a){var b=a.actionType,c=a.messageId;a=a.supplementalKey;return{actionType:b,originalMsgProtocolId:{externalId:c},supplementalKey:(b=a)!=null?b:void 0}}f.getMessageBackupDirectiveFromMessageTransportBackupDirective=a}),66);
__d("EncryptedBackupsCreateUploadMessage",["EBAPIQPLPoints","EBGenerateMessageTags","EncryptedBackupsConvertToLegacyAttachmentContext","EncryptedBackupsGetAttachmentContextForReceivedMsg","I64","LSRequestId","MAWEBSwitch","MAWMessageSortOrderUtils","MAWMsgType","MessageBackupDirectiveGenerator","MessageBackupDirectiveTypes","QPLUserFlow","WAAsMessageApplication","WAByteArray","WAConsumerApplication.pb","WAGlobals","WAJids","WALogger","WAMsgApplication.pb","WATimeUtils","decodeProtobuf","encodeProtobuf","gkx","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] no result or failed for incoming stanza ",""]);i=function(){return a};return a}function j(a){if(a==null)return null;var b;if(a.unstoredDbReaction!=null)return d("MAWMsgType").MSG_TYPE.REACTION;else if(a.unstoredDbEditActionMsg!=null)return d("MAWMsgType").MSG_TYPE.EDIT_ACTION;else if(a.unstoredDbMedia!=null){var e;b=a.unstoredDbMedia.mediaType;e=(e=a.unstoredDbMsg)==null?void 0:e.ephemeralSetting}else if(a.unstoredXMA!=null){var f;b=d("MAWMsgType").MSG_TYPE.XMA;e=(f=(f=a.unstoredDbMsg)==null?void 0:f.ephemeralSetting)!=null?f:(f=a.unstoredXMA.unstoredAssociatedMsg)==null?void 0:f.ephemeralSetting}else if(a.unstoredDbMsg!=null)b=a.unstoredDbMsg.type,e=a.unstoredDbMsg.ephemeralSetting;else return null;f=c("gkx")("10192");a=f?d("MAWMsgType").isProtobufUploadSupportedMsgType(b):d("MAWMsgType").isEBSupportedMsgType(b);return a&&!(e!=null&&e.ephemeralExpirationInSec>0)?b:null}function k(a){var b,c=a.stanza.message.decrypted.id;if(((b=a.decodedMsg)==null?void 0:b.unstoredDbReaction)!=null)return{author:a.decodedMsg.unstoredDbReaction.reactToAuthor,chat:c.chat,externalId:a.decodedMsg.unstoredDbReaction.reactToExternalId};else if(((b=a.decodedMsg)==null?void 0:b.unstoredDbEditActionMsg)!=null)return{author:c.author,chat:c.chat,externalId:a.decodedMsg.unstoredDbEditActionMsg.originalMsgExternalId};return c}function l(a){var b;return d("WAAsMessageApplication").castToMessageApplicationBytes(d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,{metadata:a.metadata,payload:{subProtocol:(b={},b[a.subprotocolType]={payload:d("WAByteArray").uint8ArrayToBuffer(a.subprotocol),version:1},b)}}).readByteArray())}function m(a){if(a.subprotocolType!=="consumerMessage")return null;a=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAConsumerApplication.pb").ConsumerApplicationSpec,a.subprotocol);if(a==null)return null;a=(a=a.payload)==null?void 0:a.content;if(a==null)return null;a=a.editMessage;return a==null||a.timestampMs==null?null:d("WATimeUtils").castLongIntToMillisTime(a.timestampMs)}function n(a){var b=a.stanza.message.decrypted.id,e=a.stanza.message.details.ts;a=c("EncryptedBackupsGetAttachmentContextForReceivedMsg")(a);var f=c("EncryptedBackupsConvertToLegacyAttachmentContext")(a),g=[];f.length>0&&f.forEach(function(a){var f=a.mediaObjectId;a=a.mediaType;g.push({deliveryObjectId:f,mediaType:a,messageId:b.externalId,productType:"msgr",threadId:d("WAJids").threadIdForChatJid(b.chat),threadJid:b.chat,traceId:c("LSRequestId").generate(),ts:e})});return{attachmentContext:a,legacyUploadAttachmentArray:g}}function a(a,b,e,f){var g=c("qpl")._(521477113,"2698"),o=j(a.decodedMsg);if(o==null){d("WALogger").WARN(i(),a.stanza.message.decrypted.id);c("QPLUserFlow").addPoint(c("qpl")._(521477113,"2698"),d("EBAPIQPLPoints").EBUploadQueueQPLPoints.UNKNOWN_MESSAGE_TYPE,{instanceKey:f});return null}var p=a.stanza.message.decrypted.msg;if((p==null?void 0:p.version)!=="v3"||p.type!=="subprotocol"){c("QPLUserFlow").addPoint(g,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.UKNOWN_MESSAGE_VERSION_OR_PROTOCOL,{instanceKey:f});return null}var q=a.stanza.message.decrypted.id,r=q.author,s=q.externalId,t=k(a),u=l(p);r=(h||(h=d("I64"))).of_string(d("WAJids").authorToUserId(r,d("WAJids").extractUserId(d("WAGlobals").getMyUserJid())));var v=a.stanza.message.details.reportingMeta,w=a.stanza.message.details.ts;c("QPLUserFlow").addPoint(g,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.GENERATE_BACKUP_DIRECTIVE_START,{instanceKey:f});var x=p.backupDirective!=null?d("MessageBackupDirectiveTypes").getMessageBackupDirectiveFromMessageTransportBackupDirective(p.backupDirective):null,y=c("gkx")("10192");y&&x!=null?y=x:y=d("MessageBackupDirectiveGenerator").createMessageBackupDirective(t,r,o,o===d("MAWMsgType").MSG_TYPE.EDIT_ACTION?m(p):null);c("QPLUserFlow").addPoint(g,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.GENERATE_BACKUP_DIRECTIVE_END,{instanceKey:f});c("QPLUserFlow").addPoint(g,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.GET_ATTACHMENT_CONTEXT_START,{instanceKey:f});x=n(a);p=x.attachmentContext;a=x.legacyUploadAttachmentArray;p.length>0&&c("QPLUserFlow").addPoint(c("qpl")._(521477113,"2698"),d("EBAPIQPLPoints").EBUploadQueueQPLPoints.ADDED_ATTACHMENT_CONTEXT,{data:{"int":{attachmentCount:p.length}},instanceKey:f});a.length>0&&c("QPLUserFlow").addPoint(c("qpl")._(521477113,"2698"),d("EBAPIQPLPoints").EBUploadQueueQPLPoints.ADDED_ATTACHMENT_CONTEXT_LEGACY,{data:{"int":{legacyAttachmentCount:a.length}},instanceKey:f});c("QPLUserFlow").addPoint(g,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.GET_ATTACHMENT_CONTEXT_END,{instanceKey:f});x=p.map(function(a){return d("EBGenerateMessageTags").generateEBMessageTags(a.mediaType)}).filter(Boolean);g=!c("MAWEBSwitch").isEnabled();c("QPLUserFlow").addAnnotations(c("qpl")._(521477113,"2698"),{bool:{isRetroactiveUpload:g},"int":{attachmentCount:p.length,backupDirectiveType:y.actionType,legacyAttachmentCount:a.length}},{instanceKey:f});return{attachmentContext:p,backupDirective:y,dbMsgType:o,instanceKey:f,isRetroactiveUpload:g,legacyAttachmentContext:a,messageApplication:u,msgId:q,originalMsgProtocolId:t,reportingMeta:v,senderId:r,serverTs:w,sortOrderMs:(p=e)!=null?p:d("WATimeUtils").castToMillisTime(d("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder({externalId:s,serverTs:w,ts:w})),tags:x,triggerSource:(y=b)!=null?y:"unknown"}}g["default"]=a}),98);
__d("EBUploadReceivedMessages",["EBAPIQPLPoints","EncryptedBackupsCreateUploadMessage","EncryptedBackupsUploadQueue","MAWEBSwitch","MWEBODSEntityName.enum","MWEBODSUtils","QPLUserFlow","WAHashStringToNumber","WALogger","WAResultOrError","asyncToGeneratorRuntime","justknobx","qpl","requireDeferred","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] error generating backup directive for received message, ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] no result or failed for incoming stanza ",""]);i=function(){return a};return a}var j=c("requireDeferred")("ArmadilloReceiveWriteDbSuccessFalcoEvent").__setRef("EBUploadReceivedMessages"),k=c("justknobx")._("3874");function a(a){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.incomingMessages,e=a.msgResults;try{if(b.length===0)return d("WAResultOrError").makeResult();d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.receive.process",b.length);a=b.map(function(a){var b=d("WAHashStringToNumber").hashStringToNumber(c("uuidv4")());c("QPLUserFlow").start(c("qpl")._(521477113,"2698"),{annotations:{bool:{received:!0}},instanceKey:b,timeoutInMs:c("justknobx")._("308")});try{var f=a.stanza.message.decrypted.id;f=e.get(f);if(f==null||!f.success){d("WALogger").EXPECTED_ERROR(i(),a.stanza.message.decrypted.id);c("QPLUserFlow").endFailure(c("qpl")._(521477113,"2698"),d("EBAPIQPLPoints").EBUploadQueueQPLPoints.MESSAGE_RESULT_FAILURE_OR_NULL,{instanceKey:b});return null}var g=c("EncryptedBackupsCreateUploadMessage")(a,"upload-received-messages",void 0,b);g==null?c("QPLUserFlow").endFailure(c("qpl")._(521477113,"2698"),d("EBAPIQPLPoints").EBUploadQueueQPLPoints.UPLOAD_PAYLOAD_CREATION_FAILURE,{instanceKey:b}):c("QPLUserFlow").addPoint(c("qpl")._(521477113,"2698"),d("EBAPIQPLPoints").EBUploadQueueQPLPoints.UPLOAD_PAYLOAD_CREATED,{instanceKey:b});k&&(g==null?void 0:g.msgId)!=null&&j.onReady(function(a){var b,d={is_protobuf_only:!1,is_supplemental_upload:g.msgId.externalId!==g.originalMsgProtocolId.externalId,msg_type:(b=g.dbMsgType)!=null?b:"unknown",trigger_source:"receive"};a.log(function(){return{encrypted_backup_enable:c("MAWEBSwitch").isEnabled(),message_id:g.msgId.externalId,process_context:JSON.stringify(d)}})});return g}catch(a){d("WALogger").ERROR(h(),a);c("QPLUserFlow").endFailure(c("qpl")._(521477113,"2698"),d("EBAPIQPLPoints").EBUploadQueueQPLPoints.RUNTIME_ERROR,{annotations:{string:{error:a.toString()}},instanceKey:b});return null}}).filter(Boolean);if(a.length===0)return d("WAResultOrError").makeResult();d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.receive.enqueue",a.length);yield d("EncryptedBackupsUploadQueue").putMsgsToEbUpload(a);return d("WAResultOrError").makeResult()}catch(a){return d("WAResultOrError").makeError("runtime-exception",a)}});return l.apply(this,arguments)}g.uploadReceivedMessages=a}),98);
__d("EBUploadReceivedMessagesRevokeUtils",["EBAPIQPLPoints","EncryptedBackupsCreateUploadMessage","MAWGetMsgForProtocolMsgIdTxn","MAWMessageSortOrderUtils","QPLUserFlow","WALogger","WATimeUtils","asyncToGeneratorRuntime","gkx","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] EBUploadReceivedMessagesProtobufOnly not uploading placeholder message - Original message not found for revoked message ",""]);h=function(){return a};return a}var i=c("requireDeferred")("EBAPI").__setRef("EBUploadReceivedMessagesRevokeUtils");function a(a,b){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e;if(((e=a.decodedMsg)==null?void 0:(e=e.unstoredDbMsg)==null?void 0:e.type)!=="Revoked"||!c("gkx")("8488"))return null;var f=a.stanza.message.decrypted.id,g=(yield d("MAWGetMsgForProtocolMsgIdTxn").getMsgForProtocolMsgIdTxn({author:f.author,chat:f.chat,externalId:a.decodedMsg.unstoredDbMsg.revokedExternalId}));if(!g.success){d("WALogger").WARN(h(),f.externalId);c("QPLUserFlow").endFailure(c("qpl")._(521477113,"2698"),d("EBAPIQPLPoints").EBUploadQueueQPLPoints.MESSAGE_RESULT_FAILURE_OR_NULL,{instanceKey:b});return null}var j=d("WATimeUtils").castToMillisTime((e=g.value.sortOrderMs)!=null?e:d("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder({externalId:g.value.externalId,serverTs:g.value.serverTs,ts:g.value.ts}));c("gkx")("6929")&&(yield i.load().then(function(a){return a.uploadDeletedMessage({instanceKey:b,msgId:{author:f.author,chat:f.chat,externalId:g.value.externalId},sender:f.author,serverTs:(a=g.value.serverTs)!=null?a:g.value.ts,sortOrderMs:j})}));return c("EncryptedBackupsCreateUploadMessage")(a,"upload-received-messages",j,b)});return j.apply(this,arguments)}g.createRevokeUploadMsg=a}),98);
__d("EBUploadReceivedMessagesProtobufOnly",["EBAPIQPLPoints","EBUploadReceivedMessagesRevokeUtils","EncryptedBackupsCreateUploadMessage","EncryptedBackupsUploadQueue","MAWEBSwitch","Promise","QPLUserFlow","WAHashStringToNumber","WAResultOrError","asyncToGeneratorRuntime","justknobx","qpl","requireDeferred","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h,i=c("requireDeferred")("ArmadilloReceiveWriteDbSuccessFalcoEvent").__setRef("EBUploadReceivedMessagesProtobufOnly"),j=c("justknobx")._("3874");function a(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.uploadArray;try{if(a.length===0)return d("WAResultOrError").makeResult();a=a.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=d("WAHashStringToNumber").hashStringToNumber(c("uuidv4")());c("QPLUserFlow").start(c("qpl")._(521477113,"2698"),{annotations:{bool:{protobufOnly:!0,received:!0}},instanceKey:b,timeoutInMs:c("justknobx")._("308")});try{var e,f=((e=a.decodedMsg)==null?void 0:(e=e.unstoredDbMsg)==null?void 0:e.type)==="Revoked"?yield d("EBUploadReceivedMessagesRevokeUtils").createRevokeUploadMsg(a,b):c("EncryptedBackupsCreateUploadMessage")(a,"upload-received-messages",void 0,b);f==null?c("QPLUserFlow").endFailure(c("qpl")._(521477113,"2698"),d("EBAPIQPLPoints").EBUploadQueueQPLPoints.UPLOAD_PAYLOAD_CREATION_FAILURE,{instanceKey:b}):c("QPLUserFlow").addPoint(c("qpl")._(521477113,"2698"),d("EBAPIQPLPoints").EBUploadQueueQPLPoints.UPLOAD_PAYLOAD_CREATED,{instanceKey:b});j&&(f==null?void 0:f.msgId)!=null&&i.onReady(function(a){var b,d={is_protobuf_only:!0,is_supplemental_upload:f.msgId.externalId!==f.originalMsgProtocolId.externalId,msg_type:(b=f.dbMsgType)!=null?b:"unknown",trigger_source:"receive"};a.log(function(){return{encrypted_backup_enable:c("MAWEBSwitch").isEnabled(),message_id:f.msgId.externalId,process_context:JSON.stringify(d)}})});return f}catch(a){c("QPLUserFlow").endFailure(c("qpl")._(521477113,"2698"),d("EBAPIQPLPoints").EBUploadQueueQPLPoints.UPLOAD_PAYLOAD_CREATION_FAILURE,{annotations:{string:{error:a.message}},instanceKey:b});return null}});return function(b){return a.apply(this,arguments)}}());a=(yield (h||(h=b("Promise"))).all(a));a=a.filter(Boolean);if(a.length===0)return d("WAResultOrError").makeResult();yield d("EncryptedBackupsUploadQueue").putMsgsToEbUpload(a);return d("WAResultOrError").makeResult()}catch(a){return d("WAResultOrError").makeError("runtime-exception",a)}});return k.apply(this,arguments)}g.uploadReceivedMessagesProtobufOnly=a}),98);
__d("MAWGetAllMediaIdsForXMAMsgApi",["MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({xma:d("MAWTransactionMode").READONLY},"getAllMediaIdsForXMAMsg",function(a){return function(b){var c=new Map();b=b.map(function(b){return d("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(a,b).then(function(a){var d,e=(d=c.get(b))!=null?d:new Set();a!=null&&(a.faviconMediaId!=null&&e.add(a.faviconMediaId),a.headerMediaId!=null&&e.add(a.headerMediaId),a.previewMediaIds!=null&&a.previewMediaIds.forEach(function(a){return e.add(a)}));c.set(b,e)})});return d("MAWDexieTable").dexieAll(b).then(function(a){return c})}});g.getAllMediaIdsForXMAMsg=a}),98);
__d("EncryptedBackupsGetAttachmentContextForSentMsgXMA",["EncryptedBackupsUploadEntity","MAWDbMediaTxns","MAWGetAllMediaIdsForXMAMsgApi","MAWIndexedDb","MAWTransactionMode","WAMediaUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY},"bulkGetRetroactiveMedia",function(a){return function(){for(var b=arguments.length,c=new Array(b),e=0;e<b;e++)c[e]=arguments[e];return d("MAWDbMediaTxns").bulkGetMedias.apply(void 0,[a].concat(c))}});function a(a,b){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=(yield d("MAWGetAllMediaIdsForXMAMsgApi").getAllMediaIdsForXMAMsg([a]).then(function(b){b=b.get(a);return b!=null?h(Array.from(b)):[]}));return c.filter(Boolean).flatMap(function(a){var c=b.msgId!=null?a==null?void 0:a.mediaEntries.get(b.msgId):null;c=c!=null?d("WAMediaUtils").decodeMediaEntryData(c):null;var e=[];(c==null?void 0:c.objectId)!=null&&a.mediaType!=null&&e.push({mediaObjectId:c.objectId,mediaType:d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA});c=c==null?void 0:(a=c.downloadableThumbnail)==null?void 0:a.objectId;c!=null&&e.push({isPreview:!0,mediaObjectId:d("WAMediaUtils").stringToDeliveryObjectId(c),mediaType:d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW});return e})});return i.apply(this,arguments)}g["default"]=a}),98);
__d("EncryptedBackupsGetAttachmentContextForSentMsg",["EncryptedBackupsCastToAttachmentContextMediaType","EncryptedBackupsGetAttachmentContextForSentMsgXMA","EncryptedBackupsUploadEntity","WAMediaUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.dbMsg,e=a.isXMAMsg,f=a.media;a=a.protocolMsgIdFromArgs;if(e===!0){e=(yield c("EncryptedBackupsGetAttachmentContextForSentMsgXMA")(a,b));return e.filter(Boolean)}a=[];e=b.msgId!=null?f==null?void 0:f.mediaEntries.get(b.msgId):null;b=e!=null?d("WAMediaUtils").decodeMediaEntryData(e):null;if(f==null||b==null)return[];if(b.objectId!=null&&f.mediaType!=null){a.push({mediaObjectId:b.objectId,mediaType:c("EncryptedBackupsCastToAttachmentContextMediaType")(f.mediaType)});f=(e=b.downloadableThumbnail)==null?void 0:e.objectId;f!=null&&a.push({mediaObjectId:d("WAMediaUtils").stringToDeliveryObjectId(f),mediaType:d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW})}return a});return h.apply(this,arguments)}g["default"]=a}),98);
__d("EncryptedBackupsGetAttachmentContextForSentMsgV2",["EncryptedBackupsCastToAttachmentContextMediaType","EncryptedBackupsUploadEntity","WAMediaUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e){var f=new Map(),g=[],h=a.msgId;if(b!=null){a=h!=null?b.mediaEntries.get(h):null;a=a!=null?d("WAMediaUtils").decodeMediaEntryData(a):null;b=c("EncryptedBackupsCastToAttachmentContextMediaType")(b.mediaType);if((a==null?void 0:a.objectId)!=null&&b!=null){var i=a.objectId;f.set(i,b)}b=a==null?void 0:(i=a.downloadableThumbnail)==null?void 0:i.objectId;b!=null&&f.set(b,d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW)}if(e!=null){if(e.favicon!=null){a=e.favicon.objectId;a!=null&&f.set(a,d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)}if(e.header!=null){i=e.header.objectId;i!=null&&f.set(i,d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)}e.previews!=null&&e.previews.length>0&&e.previews.forEach(function(a){a=a.mediaEntries;a=h!=null?a.get(h):null;a=a!=null?d("WAMediaUtils").decodeMediaEntryData(a):null;if((a==null?void 0:a.objectId)!=null){a=a.objectId;f.set(a,d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)}})}f.forEach(function(a,b){g.push({mediaObjectId:b,mediaType:a})});return g}g["default"]=a}),98);
__d("EBUploadSentMessage",["EBAPIQPLPoints","EBEnableUnifiedAttachment","EBGenerateMessageTags","EBUnifyLegacyMediaUpload","EncryptedBackupsConvertToLegacyAttachmentContext","EncryptedBackupsGetAttachmentContextForSentMsg","EncryptedBackupsGetAttachmentContextForSentMsgV2","EncryptedBackupsUploadQueue","I64","LSRequestId","MAWEBSwitch","MAWMessageSortOrderUtils","MAWMsgType","MWEBODSEntityName.enum","MWEBODSUtils","MessageBackupDirectiveGenerator","QPLUserFlow","WAFrankingTypes","WAGenReportingMeta","WAGetSafeQPLError","WAGlobals","WAHashStringToNumber","WAJids","WALogger","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime","gkx","justknobx","qpl","requireDeferred","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg adding message "," attachments to EB upload queue"]);i=function(){return a};return a}var j=c("requireDeferred")("ArmadilloReceiveWriteDbSuccessFalcoEvent").__setRef("EBUploadSentMessage"),k=c("requireDeferred")("EBAPI").__setRef("EBUploadSentMessage"),l=c("justknobx")._("3874");function m(a){if(a.reactToExternalId!=null)return d("MAWMsgType").MSG_TYPE.REACTION;else if(a.editMsgHistoryId!=null)return d("MAWMsgType").MSG_TYPE.EDIT_ACTION;else if(a.type==null)return null;else return d("MAWMsgType").isProtobufUploadSupportedMsgType(a.type)&&!(a.ephemeralSetting!=null&&a.ephemeralSetting.ephemeralExpirationInSec>0)?a.type:null}function a(a){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.dbMsg,e=a.isXMAMsg;e=e===void 0?!1:e;var f=a.media,g=a.messageApplication,n=a.messageApplicationBytes,o=a.protocolMsgId,p=a.serverTs,q=a.triggerSource;q=q===void 0?"upload-sent-message":q;a=a.xmaPayload;var r=d("WAHashStringToNumber").hashStringToNumber(c("uuidv4")()),s=c("qpl")._(521477113,"2698");d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.sent.process",1);try{if(d("WAJids").isAuthorSystem(b.author))return d("WAResultOrError").makeResult();c("QPLUserFlow").start(s,{annotations:{bool:{received:!1}},instanceKey:r,timeoutInMs:c("justknobx")._("308")});var t=m(b);if(t==null){c("QPLUserFlow").endFailure(s,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.UNSUPPORTED_MESSAGE_TYPE,{instanceKey:r});return d("WAResultOrError").makeError("Unsupported EB upload message type")}c("QPLUserFlow").addPoint(s,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.GENERATE_BACKUP_DIRECTIVE_START,{instanceKey:r});var u=d("MessageBackupDirectiveGenerator").createMessageBackupDirectiveFromDbMsg(b);c("QPLUserFlow").addPoint(s,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.GENERATE_BACKUP_DIRECTIVE_END,{instanceKey:r});if(u==null){c("QPLUserFlow").endFailure(s,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.UNABLE_TO_CREATE_BACKUP_DIRECTIVE,{instanceKey:r});return d("WAResultOrError").makeError("Unable to create backup directive")}c("QPLUserFlow").addPoint(s,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.GET_ATTACHMENT_CONTEXT_START,{instanceKey:r});var v=[];d("EBUnifyLegacyMediaUpload").getEnableUnifyLegacyMediaUpload()||d("EBEnableUnifiedAttachment").getEbEnableUnifiedAttachment()?v=c("EncryptedBackupsGetAttachmentContextForSentMsgV2")(b,f,a):v=(yield c("EncryptedBackupsGetAttachmentContextForSentMsg")({dbMsg:b,isXMAMsg:e,media:f,protocolMsgIdFromArgs:o}));c("QPLUserFlow").addPoint(s,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.GET_ATTACHMENT_CONTEXT_END,{instanceKey:r});a=c("EncryptedBackupsConvertToLegacyAttachmentContext")(v);var w=[];a.length>0&&a.forEach(function(a){var e=a.mediaObjectId;a=a.mediaType;w.push({deliveryObjectId:e,mediaType:a,messageId:o.externalId,productType:"msgr",threadId:d("WAJids").threadIdForChatJid(o.chat),threadJid:b.threadJid,traceId:c("LSRequestId").generate(),ts:p})});v.length>0&&c("QPLUserFlow").addPoint(c("qpl")._(521477113,"2698"),d("EBAPIQPLPoints").EBUploadQueueQPLPoints.ADDED_ATTACHMENT_CONTEXT,{instanceKey:r});w.length>0&&c("QPLUserFlow").addPoint(c("qpl")._(521477113,"2698"),d("EBAPIQPLPoints").EBUploadQueueQPLPoints.ADDED_ATTACHMENT_CONTEXT_LEGACY,{instanceKey:r});e=v.map(function(a){return d("EBGenerateMessageTags").generateEBMessageTags(a.mediaType)}).filter(Boolean);d("WALogger").LOG(i(),(f=v)==null?void 0:f.length);c("QPLUserFlow").addPoint(s,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.GENERATE_REPORTING_META_START,{instanceKey:r});a=g==null?void 0:g.metadata;f=(yield d("WAGenReportingMeta").genReportingMeta(n,(a==null?void 0:a.frankingKey)?d("WAFrankingTypes").castToFrankingKey(new Uint8Array(a==null?void 0:a.frankingKey)):null,a==null?void 0:a.frankingVersion));c("QPLUserFlow").addPoint(s,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.GENERATE_REPORTING_META_END,{instanceKey:r});g=!c("MAWEBSwitch").isEnabled();c("QPLUserFlow").addAnnotations(c("qpl")._(521477113,"2698"),{bool:{isRetroactiveUpload:g},"int":{attachmentCount:v.length,backupDirectiveType:u.actionType,legacyAttachmentCount:w.length}},{instanceKey:r});d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.sent.enqueue",1);var x=d("WATimeUtils").castToMillisTime(d("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder({externalId:o.externalId,originalTs:b.originalTs,revokedExternalId:b.revokedExternalId,serverTs:p,ts:p})),y={attachmentContext:v,backupDirective:u,dbMsgType:t,instanceKey:r,isRetroactiveUpload:g,legacyAttachmentContext:w,messageApplication:n,msgId:o,originalMsgProtocolId:u.originalMsgProtocolId.externalId!==o.externalId?u.originalMsgProtocolId:o,reportingMeta:f,senderId:(h||(h=d("I64"))).of_string(d("WAJids").authorToUserId(o.author,d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()))),serverTs:p,sortOrderMs:x,tags:e,triggerSource:q};l&&(y==null?void 0:y.msgId)!=null&&j.onReady(function(a){var b,d={is_protobuf_only:!1,is_supplemental_upload:y.msgId.externalId!==y.originalMsgProtocolId.externalId,msg_type:(b=y.dbMsgType)!=null?b:"unknown",trigger_source:"send"};a.log(function(){return{encrypted_backup_enable:c("MAWEBSwitch").isEnabled(),message_id:y.msgId.externalId,process_context:JSON.stringify(d)}})});yield d("EncryptedBackupsUploadQueue").putMsgsToEbUpload([y]);c("gkx")("6929")&&b.type===d("MAWMsgType").MSG_TYPE.REVOKED&&b.originalMsgExternalId==null&&b.reactToExternalId==null&&(c("QPLUserFlow").addPoint(s,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.UPLOAD_DELETED_MESSAGE,{instanceKey:r}),yield k.load().then(function(a){return a.uploadDeletedMessage({instanceKey:r,msgId:{author:o.author,chat:b.threadJid,externalId:b.revokedExternalId},sender:b.author,serverTs:(a=(a=b.originalTs)!=null?a:b.serverTs)!=null?a:b.ts,sortOrderMs:x})}));return d("WAResultOrError").makeResult()}catch(a){c("QPLUserFlow").endFailure(s,d("EBAPIQPLPoints").EBUploadQueueQPLPoints.RUNTIME_ERROR,{annotations:{string:{errorDescription:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}},instanceKey:r});return d("WAResultOrError").makeError("runtime-error",a)}});return n.apply(this,arguments)}g.uploadSentMessage=a}),98);
__d("EchoSerializationFailureFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5722");b=d("FalcoLoggerInternal").create("echo_serialization_failure",a);e=b;g["default"]=e}),98);
__d("EchoSerializationSuccessFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5723");b=d("FalcoLoggerInternal").create("echo_serialization_success",a);e=b;g["default"]=e}),98);
__d("EncryptedBackupsDYIFileUtils",["FBLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h="media";f="messages.zip";function i(){if(navigator.storage!=null&&navigator.storage.getDirectory!=null)return navigator.storage.getDirectory();throw c("FBLogger")("labyrinth_web").mustfixThrow("Storage management API is not supported. Please try one of the supported browsers.")}function a(){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield i());return a.getDirectoryHandle(h,{create:!0})});return j.apply(this,arguments)}function d(a,b,c){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,d){a=(yield a.getFileHandle(b,{create:!0}));try{b=(yield a.createSyncAccessHandle());b.write(d);b.flush();b.close()}catch(e){if(e instanceof Error){if(e instanceof TypeError)try{b=(yield a.createWritable());yield b.write(d);yield b.close();return}catch(a){if(a instanceof Error){if(a instanceof TypeError)throw c("FBLogger")("labyrinth_web").mustfixThrow("Write operation is not supported. Please try one of the supported browsers.");throw c("FBLogger")("labyrinth_web").mustfixThrow("Failed to write using writable: %e",a.message)}throw a}throw c("FBLogger")("labyrinth_web").mustfixThrow("Failed to write using sync access handle: %s",e.message)}throw e}});return k.apply(this,arguments)}function e(a,b){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=(yield a.getFileHandle(b));try{var d=(yield a.createSyncAccessHandle()),e=new ArrayBuffer(d.getSize());d.read(e);d.close();return new Blob([e])}catch(d){if(d instanceof Error){if(d instanceof TypeError)return a.getFile();throw c("FBLogger")("labyrinth_web").mustfixThrow("Failed to read file %s, %s",b,d.message)}throw d}});return l.apply(this,arguments)}g.DyiMediaFolder=h;g.DyiArchiveFilename=f;g.getRootFolderHandle=i;g.getMediaFolderHandle=a;g.writeFile=d;g.readFile=e}),98);
__d("MAWThreadKeyUtils",["I64"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return(h||(h=d("I64"))).to_string(a)}function b(a){return a}function c(a){return(h||(h=d("I64"))).of_string(a)}function e(a){return a}g.stringThreadKeyFromThreadKey=a;g.stringThreadKeyFromString=b;g.stringThreadKeyToI64=c;g.stringThreadKeyToString=e}),98);
__d("EncryptedBackupsDYIGenerateThreadMetadata",["CurrentUser","EncryptedBackupsDYISingleton","I64","IGDWebUtils","LSMessagingThreadTypeUtil","MAWThreadKeyUtils","Promise","ReQL","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot find thread id for thread key ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot find thread id for thread key ",""]);k=function(){return a};return a}function l(){return d("IGDWebUtils").isOnInstagramWeb()?(i||(i=d("I64"))).of_string(c("CurrentUser").getEIMU()):(i||(i=d("I64"))).of_string(c("CurrentUser").getAccountID())}function m(a,b){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.threads).getKeyRange(d("MAWThreadKeyUtils").stringThreadKeyToI64(b)))}function n(a,b){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.contacts).getKeyRange(b))}function a(a,b){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.contacts).filter(function(a){return b.has((i||(i=d("I64"))).to_string(a.id))}))}function o(a,b){var c;return(c=d("ReQL")).toArrayAsync(c.leftJoin(c.fromTableAscending(a.tables.participants,["contactId"]).getKeyRange(b),c.fromTableAscending(a.tables.contacts,["name"])))}function p(a){return d("LSMessagingThreadTypeUtil").isOneToOne(a)||d("LSMessagingThreadTypeUtil").isOpenOneToOne(a)}function q(a,b,c){if(c!=null&&c.trim()!=="")return c+"_"+b;switch(a.length){case 0:return"Thread_"+b;case 1:return a[0]+"_"+b;case 2:return a[0]+"and"+a[1]+"_"+b;case 3:return""+a[0]+a[1]+"and"+a[2]+"_"+b;case 4:return""+a[0]+a[1]+a[2]+"and1other_"+b;default:return""+a[0]+a[1]+a[2]+"and"+(a.length-3)+"others_"+b}}function r(a,b,c,d,e,f){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g){var h=[],j=[f];f=(yield m(c,a));if(f!=null)if(p(f.threadType)){var l=b.getThreadIdForThreadKey(a);if(l==null){b.getLogger().WARN(k(),a);return}l=(yield n(c,(i||(i=d("I64"))).of_string(l)));(l==null?void 0:l.id)!=null&&(l==null?void 0:l.name)!=null&&b.setContactNameForContactId((i||(i=d("I64"))).to_string(l.id),l.name);l=(l==null?void 0:l.name)||"Unknown User";h.push(l);j.push(l);b.setThreadMetaDataByThreadKey(a,j,q(h,g,f.threadName))}else{l=(yield o(c,f.threadKey));l.forEach(function(a){var c=a[0];a=a[1];(c==null?void 0:c.contactId)!=null&&(a==null?void 0:a.name)!=null&&b.setContactNameForContactId((i||(i=d("I64"))).to_string(c.contactId),a.name);if(!(i||(i=d("I64"))).equal(c.contactId,e)){c=(a==null?void 0:a.name)||"Unknown User";h.push(c);j.push(c)}});b.setThreadMetaDataByThreadKey(a,j,q(h,g,f.threadName))}else b.setThreadMetaDataByThreadKey(a,j,q(h,g))});return s.apply(this,arguments)}function e(a){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c,e=d("EncryptedBackupsDYISingleton").getSingleton(),f=e.getLogger(),g=(yield e.getDB()),k=(yield n(g,l())),m=(c=k==null?void 0:k.id)!=null?c:(i||(i=d("I64"))).zero,o=(c=k==null?void 0:k.name)!=null?c:"Me";e.setContactNameForContactId((i||(i=d("I64"))).to_string(m),o);return a.reduce(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){yield a;a=e.getThreadIdForThreadKey(b);a==null&&void f.WARN(j(),b);return r(b,e,g,m,o,c)});return function(b,c,d){return a.apply(this,arguments)}}(),(h||(h=b("Promise"))).resolve())});return t.apply(this,arguments)}g.getAllUnmappedContacts=a;g.EncryptedBackupsDYIGenerateThreadMetadata=e}),98);
__d("EncryptedBackupsDYIZipUtils",["EncryptedBackupsDYIFileUtils","Promise","asyncToGeneratorRuntime","jszip"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Generic stream error"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error during end event"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Closed the writing stream"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Finished ZIP file generation. Saving the results"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error during data event"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Writing "," (","%)"]);n=function(){return a};return a}function a(a,b,c,d){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g){g("stream_file_start");var o=new(c("jszip"))();for(a of a){var q=a.threadName+".json";o.file(q,JSON.stringify(a,null,2))}e.forEach(function(a){return p(o,a)});var r=o.generateInternalStream({compression:"DEFLATE",compressionOptions:{level:6},type:"Uint8Array"});q=(yield d("EncryptedBackupsDYIFileUtils").getRootFolderHandle());a=(yield q.getFileHandle("messages.zip",{create:!0}));var s=(yield a.createWritable({keepExisting:!1,mode:"exclusive"}));return new(h||(h=b("Promise")))(function(a,b){var c=0;r.on("data",function(a,d){r.pause(),c++,c%1e3===0&&void f.LOG(n(),d.currentFile,d.percent),void s.write(a).then(function(){r.resume()},function(a){void f.ERROR(m()),g("stream_file_error"),b(a)})});r.on("end",function(){void f.LOG(l()),g("stream_file_end"),g("write_file_start"),void s.close().then(function(){g("write_file_end"),void f.LOG(k()),a()},function(a){void f.ERROR(j()),g("write_file_error"),b(a)})});r.on("error",function(a){void f.ERROR(i()),g("stream_file_error"),b(a)});r.resume()})});return o.apply(this,arguments)}function p(a,b){var c=b.split("/").pop(),e=d("EncryptedBackupsDYIFileUtils").getMediaFolderHandle().then(function(a){return d("EncryptedBackupsDYIFileUtils").readFile(a,(a=c)!=null?a:b)});a.file(b,e)}g.generateZipFile=a}),98);
__d("EncryptedBackupsDYISingleton",["EncryptedBackupsDYIFileUtils","EncryptedBackupsDYIGenerateThreadMetadata","EncryptedBackupsDYISingletonFactory","EncryptedBackupsDYITypes","EncryptedBackupsDYIZipUtils","FBLogger","I64","LSIntEnum","MAWBridge","MAWQplProxy","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["DYI Exiting Early - Found "," instamadillo threads"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to generate zip file: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Generating zip file"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Generating output"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Fetched remaining contact names, total of "," contacts"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["DYI flow complete - generating output"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Finished processing attachment with plaintext hash ",". "," attachments left"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["DYI flow complete - generating output"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["Finished handling message range queries for thread with thread key ",". "," threads left"]);r=function(){return a};return a}var s=null;function t(){try{return WorkerGlobalScope!==void 0&&self instanceof WorkerGlobalScope}catch(a){return!1}}function a(a,b,e){if(s==null)switch(a){case d("EncryptedBackupsDYITypes").EncryptedBackupsDYIConfig.Armadillo:if(t())throw c("FBLogger")("labyrinth_web").mustfixThrow("EncryptedBackupsDYISingleton for Armadillo can only be initialised in the main thread");s=d("EncryptedBackupsDYISingletonFactory").getMAWEncryptedBackupsDYISingleton(b,e);break;case d("EncryptedBackupsDYITypes").EncryptedBackupsDYIConfig.Instamadillo:if(!t())throw c("FBLogger")("labyrinth_web").mustfixThrow("EncryptedBackupsDYISingleton for Instamadillo can only be initialised in the worker");s=d("EncryptedBackupsDYISingletonFactory").getIGDEncryptedBackupsDYISingleton(b,e);break}}function e(){if(s==null)throw c("FBLogger")("labyrinth_web").mustfixThrow("EncryptedBackupsDYISingleton is not initialised. Please call EncryptedBackupsDYISingleton.initSingleton() first.");return s}var u=function(){var c=a.prototype;c.getDB=function(){return this.$1()};c.getLogger=function(){return this.$4};function a(a,b,c,d){this.$5=new Map(),this.$6=new Set(),this.$7=new Set(),this.$8=new Map(),this.$9=new Map(),this.$10=new Map(),this.$11=new Map(),this.$12=new Map(),this.$1=a,this.$2=b,this.$3=c,this.$4=d}c.getAllMediaUrls=function(){return Array.from(this.$5.values())};c.$13=function(a){return this.$5.get(a)};c.setMediaUrlByPlainTextHash=function(a,b){if(this.$5.has(a))return;this.$5.set(a,b)};c.addThreadKeyToThreadsRestoreInProgress=function(a){this.$6.add(a)};c.isThreadRestoreInProgressForThreadKey=function(a){return this.$6.has(a)};c.deleteThreadKeyFromThreadsRestoreInProgress=function(a){this.$6["delete"](a),void this.$4.LOG(r(),a,this.$6.size),this.$14()&&(void this.$4.LOG(q()),void this.$15())};c.isThreadsRestoreComplete=function(){return this.$6.size===0};c.addPlaintextHashToAttachmentDownloadsInProgress=function(a){this.$7.add(a)};c.deletePlaintextHashFromAttachmentDownloadsInProgress=function(a){this.$7["delete"](a),void this.$4.LOG(p(),a,this.$7.size),this.$14()&&(void this.$4.LOG(o()),void this.$15())};c.isAttachmentDownloadInProgressForPlaintextHash=function(a){return this.$7.has(a)};c.isAttachmentDownloadCompleteForPlaintextHash=function(a){return!!this.$5.get(a)};c.isAttachmentDownloadComplete=function(){return this.$7.size===0};c.setMessagesByThreadKey=function(a,b,c){a=this.getMessagesByThreadKey(a);a.set(b,c)};c.getMessagesByThreadKey=function(a){this.$16(a)||this.$8.set(a,new Map());return this.$8.get(a)};c.$16=function(a){return this.$8.has(a)};c.getThreadIdForThreadKey=function(a){return this.$10.get(a)};c.getThreadKeyForThreadId=function(a){return this.$11.get(a)};c.setThreadMapping=function(a,b){this.$10.set(a,b),this.$11.set(b,a)};c.setThreadMetaDataByThreadKey=function(a,b,c){this.$9.set(a,{participants:b,threadName:c})};c.getThreadMetadataMap=function(){return this.$9};c.setContactNameForContactId=function(a,b){this.$12.set(a,b)};c.getContactNameForContactId=function(a){return this.$12.get(a)};c.getContactNameMap=function(){return this.$12};c.getOutput=function(){var a=this;return Array.from(this.getThreadMetadataMap(),function(b){var c=b[0];b=b[1];var d=a.$16(c);d=d?Array.from(a.getMessagesByThreadKey(c),function(b){b[0];b=b[1];return babelHelpers["extends"]({},b,{media:Array.from(b.media,function(b){b=a.$13(b);return{uri:b!=null?"./"+b:"Failed to download media"}})})}):[];d=d.map(function(b){var c=b.senderId,d=babelHelpers.objectWithoutPropertiesLoose(b,["senderId"]);if(c!=null&&d.senderName==="Unknown User"){c=a.getContactNameForContactId(c);if(c!=null)return babelHelpers["extends"]({},d,{senderName:c})}return b});c=d.sort(function(a,b){return typeof a.timestamp==="number"&&typeof b.timestamp==="number"?a.timestamp-b.timestamp:0});return babelHelpers["extends"]({},b,{messages:c})})};c.$14=function(){return this.isAttachmentDownloadComplete()&&this.isThreadsRestoreComplete()};c.$17=function(a){switch(a){case 0:return d("EncryptedBackupsDYITypes").EncryptedBackupsDYIState.InProgress;case 1:return d("EncryptedBackupsDYITypes").EncryptedBackupsDYIState.Completed;case 2:return d("EncryptedBackupsDYITypes").EncryptedBackupsDYIState.Failed;case-1:default:return d("EncryptedBackupsDYITypes").EncryptedBackupsDYIState.NotStarted}};c.updateDYIStatus=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=(yield this.getDB());yield c.runInTransaction(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){yield b.encrypted_backups_dyi_backup_restore_status.put({currentStatus:(h||(h=d("LSIntEnum"))).ofNumber(a),pk:(i||(i=d("I64"))).zero})});return function(a){return c.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":499");d("MAWBridge").getBridge().fireAndForget("event","updateDYIStatus",{qplEvent:this.$2,qplInstanceKeyE2E:(c=this.$3)!=null?c:void 0,status:this.$17(a)})});function c(b){return a.apply(this,arguments)}return c}();c.$18=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this,b=new Set();this.getContactNameMap().forEach(function(a,c){a==="Unknown User"&&b.add(c)});var c=(yield this.getDB());c=(yield d("EncryptedBackupsDYIGenerateThreadMetadata").getAllUnmappedContacts(c,b));c.forEach(function(b){var c=(i||(i=d("I64"))).to_string(b.id);a.setContactNameForContactId(c,b.name)});void this.$4.LOG(n(),this.getContactNameMap().size.toString())});function c(){return a.apply(this,arguments)}return c}();c.$15=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this;this.logDYIQPLPoint("complete_dyi_flow_start");yield this.$18();void this.$4.LOG(m());var b=this.getOutput(),c=Array.from(this.$5.values());void this.$4.LOG(l());try{yield d("EncryptedBackupsDYIZipUtils").generateZipFile(b,c,this.$4,function(b,c){a.logDYIQPLPoint(b,c)}),this.logDYIQPLPoint("complete_dyi_flow_end"),yield this.updateDYIStatus(1)}catch(a){void this.$4.ERROR(k(),a),this.logDYIQPLPoint("complete_dyi_flow_error"),yield this.updateDYIStatus(2)}finally{void this.clear()}});function c(){return a.apply(this,arguments)}return c}();c.exitDYIEarly=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){b!=null&&void this.$4.LOG(j(),b),this.logDYIQPLPoint("dyi_exit_early",{"int":{dyi_threads:b}}),yield this.updateDYIStatus(a?2:1),void this.clear()});function c(b,c){return a.apply(this,arguments)}return c}();c.clear=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){this.$5=new Map();this.$6=new Set();this.$7=new Set();this.$8=new Map();this.$9=new Map();var a=(yield d("EncryptedBackupsDYIFileUtils").getRootFolderHandle());yield a.removeEntry(d("EncryptedBackupsDYIFileUtils").DyiMediaFolder,{recursive:!0})});function c(){return a.apply(this,arguments)}return c}();c.logDYIQPLPoint=function(a,b){this.$3!=null&&d("MAWQplProxy").sendQplPointThroughBridge(this.$2,a,{annotations:b,instanceKey:this.$3})};return a}();g.initSingleton=a;g.getSingleton=e;g.EncryptedBackupsDYISingleton=u}),98);
__d("EncryptedBackupsDYISingletonFactory",["EncryptedBackupsDYISingleton","WATagsLogger","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return new(d("EncryptedBackupsDYISingleton").EncryptedBackupsDYISingleton)(a,c("qpl")._(521478596,"1329"),b,d("WATagsLogger").TAGS(["labyrinth_web","labyrinth_dyi",b==null?"":b.toString()]))}function b(a,b){return new(d("EncryptedBackupsDYISingleton").EncryptedBackupsDYISingleton)(a,c("qpl")._(521479842,"2163"),b,d("WATagsLogger").TAGS(["igd_labyrinth_web","igd_dyi",b==null?"":b.toString()]))}g.getMAWEncryptedBackupsDYISingleton=a;g.getIGDEncryptedBackupsDYISingleton=b}),98);
__d("EncryptedBackupsDYIHandleMessageRestore",["EncryptedBackupsDYISingleton","I64","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Issuing next range query for thread with thread key ",", server generated next reference timestamp: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["nextTimestampMs was not supplied for thread with thread key ","."]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["handling message range query for thread with thread key ",", hasMoreBefore: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot find thread key for thread id: ",""]);l=function(){return a};return a}function a(a,b,c,d,e,f,g){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g,m){var o=d("EncryptedBackupsDYISingleton").getSingleton(),p=o.getLogger();o=o.getThreadKeyForThreadId(b);if(o==null){p.WARN(l(),b);return}void p.LOG(k(),b,e);c.length>0&&(yield g(o,b,c));if(!e||f==null){e&&f==null&&void p.ERROR(j(),b);n(o);return}g=(h||(h=d("I64"))).to_string(f);void p.LOG(i(),b,g);void m(a,g,b)});return m.apply(this,arguments)}function n(a){var b=d("EncryptedBackupsDYISingleton").getSingleton();b.deleteThreadKeyFromThreadsRestoreInProgress(a)}g.handleMessageRangeQueryRestore=a}),98);
__d("EncryptedBackupsDYIMediaDownloadHandlers",["EncryptedBackupsDYIFileUtils","EncryptedBackupsDYISingleton","FBLogger","Promise","WAResultOrError","asyncToGeneratorRuntime","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){f=(yield d("EncryptedBackupsDYIFileUtils").getMediaFolderHandle());b=b.split("/")[1];b=c("uuidv4")()+"."+b;yield d("EncryptedBackupsDYIFileUtils").writeFile(f,b,e);f=d("EncryptedBackupsDYISingleton").getSingleton();f.setMediaUrlByPlainTextHash(a,d("EncryptedBackupsDYIFileUtils").DyiMediaFolder+"/"+b);f.deletePlaintextHashFromAttachmentDownloadsInProgress(a);return d("WAResultOrError").makeResult()});return function(b,c,d,e){return a.apply(this,arguments)}}();e=function(){c("FBLogger")("labyrinth_web").debug("[DYIMediaPreviewHandler] Skipping previews for DYI");return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult())};g.DYIMediaDownloadHandler=a;g.DYIMediaPreviewHandler=e}),98);
__d("MebWAMediaDownloader",["MAWBridge","MAWHandleMediaPreviewBeforeDownloadApi","MAWHandleMediaPreviewDownloadApi","MAWHandleMediaPreviewDownloadAsFailedApi","MAWUpdateMediaEntryForMsgApi","WAAPI","WAIsMediaExpiredError","WALogger","WAStartMediaDownloadQplFlow","WATimeUtils","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] downloading media from MI directly"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][WAMediaDownloader] Cannot download media - missing mediaKeyTimestamp"]);i=function(){return a};return a}a=function(){function a(a,b,c){this.mediaDownloadMetadata=a,this.downloadCallbacks=b,this.waApiDownloadCall=c}var e=a.prototype;e.handle=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a,b=this.mediaDownloadMetadata.mediaEntry.mediaKeyTimestamp;if(b==null){d("WALogger").ERROR(i());return this.handleError()}b=!d("WATimeUtils").happenedWithin(b,29*d("WATimeUtils").DAY_SECONDS);a=(a=this.mediaDownloadMetadata.isUrlRenewed)!=null?a:!1;if(!a&&(b||c("gkx")("23960"))){d("WALogger").LOG(h());return this.handleUrlExpired()}a=this.mediaDownloadMetadata;b=a.hash;var e=a.mediaEntry;a=a.protocolMsgId;b=(yield this.waApiDownloadCall(b,e,a));if(b.success)return this.downloadCallbacks.onDownloadSuccess({mimeType:b.value.mimeType,plaintext:b.value.plaintext});if(d("WAIsMediaExpiredError").isMediaExpiredError(b.error))return this.handleUrlExpired();else return this.handleError()});function e(){return a.apply(this,arguments)}return e}();e.handleUrlExpired=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a;yield this.downloadCallbacks.onUrlExpired();return(a=this.mediaDownloadHandler)==null?void 0:a.handle()});function c(){return a.apply(this,arguments)}return c}();e.handleError=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a;yield this.downloadCallbacks.onDownloadError();return(a=this.mediaDownloadHandler)==null?void 0:a.handle()});function c(){return a.apply(this,arguments)}return c}();e.getDownloadMetadata=function(){return this.mediaDownloadMetadata};e.setNextHandler=function(a){this.mediaDownloadHandler=a};return a}();e=function(a,b,e){var f=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"MebWAMediaDownloader",msgType:null,protocolMsgId:e,triggerUIView:null});return c("WAAPI").downloadMedia({downloadMediaMetric:f,handleMediaPreviewBeforeDownload:d("MAWHandleMediaPreviewBeforeDownloadApi").handleMediaPreviewBeforeDownload,handleMediaPreviewDownload:d("MAWHandleMediaPreviewDownloadApi").handleMediaPreviewDownload,handleMediaPreviewDownloadFailed:d("MAWHandleMediaPreviewDownloadAsFailedApi").handleMediaPreviewDownloadFailed,hash:a,mediaEntry:b,protocolMsgId:e,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg})};f=function(a,b,c){return d("MAWBridge").getBridge().sendAndReceive("backend","dyiDownloadMedia",{hash:a,mediaEntry:b,protocolMsgId:c})};g.MebWAMediaDownloader=a;g.MebWADownloadMediaFromWorker=e;g.MebWADownloadMediaThroughTheBridge=f}),98);
__d("EncryptedBackupsDYIMessageProcessingUtils",["EncryptedBackupsDYIMediaDownloadHandlers","EncryptedBackupsDYISingleton","MebWAMediaDownloader","Promise","WAJids","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Failed to resign CDN URL: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Media CDN URL has expired and should be renewed"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Successfully downloaded media"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Failed to download media"]);l=function(){return a};return a}function a(a,b){return{isUnsent:!1,media:new Set(),reactions:[],senderName:m(a),text:"",timestamp:(a=b)!=null?a:0,type:""}}function m(a){var b=d("EncryptedBackupsDYISingleton").getSingleton(),c="Unknown User";if(a!=null){b=b.getContactNameForContactId(a);b!=null&&(c=b)}return c}function c(a,c,e,f,g,m,n,o,p,q,r){var s=d("EncryptedBackupsDYISingleton").getSingleton(),t=s.getLogger(),u={author:d("WAJids").toMsgrUserJid(n),chat:d("WAJids").toMsgrUserJid(g),externalId:o},v={hash:p,isUrlRenewed:!1,mediaEntry:f,protocolMsgId:u,sortOrderMs:q};n={onDownloadError:function(){void t.ERROR(l(),v.hash);s.deletePlaintextHashFromAttachmentDownloadsInProgress(v.hash);return(h||(h=b("Promise"))).resolve()},onDownloadSuccess:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){void t.LOG(k(),v.hash);var b=a.mimeType;a=a.plaintext;yield d("EncryptedBackupsDYIMediaDownloadHandlers").DYIMediaDownloadHandler(v.hash,b,a,u)});function c(b){return a.apply(this,arguments)}return c}(),onUrlExpired:function(){void t.LOG(j(),v.hash);return(h||(h=b("Promise"))).resolve()}};var w=new(d("MebWAMediaDownloader").MebWAMediaDownloader)(v,n,a),x=f.serverMediaType;f=f.objectId;if(x!=null&&f!=null&&typeof q==="number"){c={backupEntFbid:c,deliveryObjectId:f,hash:p,mediaType:x,messageId:o,productType:e,sortOrder:q,threadId:g,threadKey:m};f={onResignCdnUrlFailure:function(a){void t.ERROR(i(),v.hash,a.message);s.deletePlaintextHashFromAttachmentDownloadsInProgress(v.hash);return(h||(h=b("Promise"))).resolve()},onResignCdnUrlSuccess:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){});function c(){return a.apply(this,arguments)}return c}()};p=r(c,f);w.setNextHandler(p);p.setNextHandler(new(d("MebWAMediaDownloader").MebWAMediaDownloader)(v,n,a))}void w.handle()}g.buildBaseDyiMessage=a;g.getSenderName=m;g.startMediaDownloadChain=c}),98);
__d("LSCreateDataTrace",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[],d=[];return b.sequence([function(d){return c[0]=b.i64.of_float(Date.now()),b.db.table(153).add({traceId:a[0],initTimestampMs:c[0],traceType:a[4],shouldFlush:!1,contextOne:a[1],contextTwo:a[2],contextThree:a[3]})},function(a){return b.resolve(d)}])}a.__sproc_name__="LSDataTraceCreateDataTraceStoredProcedure";a.__tables__=["data_trace_meta"];e.exports=a}),null);
__d("LSCreateDataTraceID.nop",["LSRequestId","LSResult","Promise"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(a,d){return(h||(h=b("Promise"))).resolve(c("LSResult")(c("LSRequestId").generate()))};a.__nop_name__="LSCreateDataTraceID";g["default"]=a}),98);
__d("LSFindBackup",["LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(a){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsFindBackupStoredProcedure] Beginning execution."),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?(f=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,20]),void 0],d[1]=f[0],d[2]=f[1],d[3]=f[2],d[4]=f[3],d[5]=f[4],d[6]=f[5],d[7]=f[6],d[8]=f[7],d[9]=f[8],d[10]=f[9],d[11]=f[10],d[12]=f[11],d[13]=f[12],d[14]=f[13],d[15]=f[14],d[16]=f[15],d[17]=f[16],f):(e=a.item,c.sequence([function(a){return d[31]=e.backupTenancy,d[30]=e.encryptionVersion,d[26]=void 0,c.i64.neq(d[26],void 0)?c.resolve(d[27]=d[26]):c.sequence([function(a){return d[32]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[33]=a[0],a})},function(a){return d[33]?d[42]=(d[32].push(c.i64.cast([0,0])),d[32]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[34]=a[0],a})},function(a){return d[34]?d[42]=(d[32].push(c.i64.cast([0,2])),d[32]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[35]=a[0],a})},function(a){return d[35]?d[42]=(d[32].push(c.i64.cast([0,3])),d[32]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[36]=a[0],a})},function(a){return d[36]?d[42]=(d[32].push(c.i64.cast([0,4])),d[32]):0,d[37]=c.createArray(),d[38]=c.i64.of_int32(d[32].length),c.i64.gt(d[38],c.i64.cast([0,0]))?c.loopAsync(d[38],function(a){return d[42]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[32],d[42]).then(function(a){return a=a,d[43]=a[0],d[44]=a[1],a})},function(a){return d[45]=(d[37].push(d[43]),d[37])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[42]=c.createArray(),d[43]=c.i64.of_int32(d[37].length),c.i64.gt(d[43],c.i64.cast([0,0]))?c.loopAsync(d[43],function(a){return d[45]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[37],d[45]).then(function(a){return a=a,d[46]=a[0],d[47]=a[1],a})},function(a){return d[48]=(d[42].push(c.i64.to_string(d[46])),d[42])}])}):c.resolve()},function(a){return d[44]=d[42].join(","),d[39]=d[44]}])},function(a){return d[37].some(function(a){return c.i64.eq(d[30],a)})?d[40]=d[30]:d[40]=void 0,c.i64.neq(d[40],void 0)?d[41]=d[40]:d[41]=void 0,d[27]=d[41]}])},function(a){return c.i64.neq(d[27],void 0)?d[28]=d[27]:d[28]=c.i64.cast([0,0]),c.i64.neq(d[31],void 0)?d[29]=d[31]:d[29]=c.i64.cast([0,1]),a=[e.backupId,e.deviceId,e.mailboxRootKeyBlob,e.ocmfClientStateBlob,void 0,void 0,d[28],d[29],e.epochAuthPublicKeyBlob,e.epochAuthPrivateKeyBlob,e.devicePublicKeyBlob,e.devicePrivateKeyBlob,e.epochStoragePublicKeyBlob,e.epochStoragePrivateKeyBlob,e.obliviousValidationTokenBlob,e.authorityLevel,void 0],d[1]=a[0],d[2]=a[1],d[3]=a[2],d[4]=a[3],d[5]=a[4],d[6]=a[5],d[7]=a[6],d[8]=a[7],d[9]=a[8],d[10]=a[9],d[11]=a[10],d[12]=a[11],d[13]=a[12],d[14]=a[13],d[15]=a[14],d[16]=a[15],d[17]=a[16],a}]))})},function(a){return c.i64.neq(d[1],void 0)?d[19]=c.i64.to_string(d[1]):d[19]=void 0,d[20]=c.i64.of_float(Date.now()),d[21]=c.i64.random(),d[23]="Finishing execution. Execution time: ",d[24]=c.i64.to_string(c.i64.sub(d[20],d[0])),d[25]=" ms",d[22]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsFindBackupStoredProcedure] ",d[22],d[23],d[22],d[24],d[22],d[25]].join("")),c.i64.eq(c.i64.mod_(d[21],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[26]=",",d[27]=c.createArray(),void 0!==void 0?d[28]=(d[27].push(void 0),d[27]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFindBackupStoredProcedure",[d[23],d[26],d[24],d[26],d[25]].join(""),d[27],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[19]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsFindBackupStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];e.exports=a}),null);
__d("LSIssueAttachmentRestoreTask",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSBase64Encode.nop","LSBinaryToHex.nop","LSCreateDataTrace","LSCreateDataTraceID.nop","LSCreateDerivedKeys.nop","LSFindBackup","LSFlushDataTrace.nop","LSGetBlobFromInt64BE.nop","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueNewTask","LSLogMebClientEvent.nop","LSOcmfClientMap.nop","LSOpeEncrypt.nop","LSTruncateSortKey.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] Beginning execution."),a[7]!==void 0?c.resolve(d[1]=a[7]):c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?(f=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,20]),void 0],d[27]=f[0],d[28]=f[1],d[29]=f[2],d[30]=f[3],d[31]=f[4],d[32]=f[5],d[33]=f[6],d[34]=f[7],d[35]=f[8],d[36]=f[9],d[37]=f[10],d[38]=f[11],d[39]=f[12],d[40]=f[13],d[41]=f[14],d[42]=f[15],d[43]=f[16],f):(e=a.item,c.sequence([function(a){return d[52]=e.backupTenancy,d[51]=e.encryptionVersion,d[47]=void 0,c.i64.neq(d[47],void 0)?c.resolve(d[48]=d[47]):c.sequence([function(a){return d[53]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[54]=a[0],a})},function(a){return d[54]?d[63]=(d[53].push(c.i64.cast([0,0])),d[53]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[55]=a[0],a})},function(a){return d[55]?d[63]=(d[53].push(c.i64.cast([0,2])),d[53]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[56]=a[0],a})},function(a){return d[56]?d[63]=(d[53].push(c.i64.cast([0,3])),d[53]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[57]=a[0],a})},function(a){return d[57]?d[63]=(d[53].push(c.i64.cast([0,4])),d[53]):0,d[58]=c.createArray(),d[59]=c.i64.of_int32(d[53].length),c.i64.gt(d[59],c.i64.cast([0,0]))?c.loopAsync(d[59],function(a){return d[63]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[53],d[63]).then(function(a){return a=a,d[64]=a[0],d[65]=a[1],a})},function(a){return d[66]=(d[58].push(d[64]),d[58])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[63]=c.createArray(),d[64]=c.i64.of_int32(d[58].length),c.i64.gt(d[64],c.i64.cast([0,0]))?c.loopAsync(d[64],function(a){return d[66]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[58],d[66]).then(function(a){return a=a,d[67]=a[0],d[68]=a[1],a})},function(a){return d[69]=(d[63].push(c.i64.to_string(d[67])),d[63])}])}):c.resolve()},function(a){return d[65]=d[63].join(","),d[60]=d[65]}])},function(a){return d[58].some(function(a){return c.i64.eq(d[51],a)})?d[61]=d[51]:d[61]=void 0,c.i64.neq(d[61],void 0)?d[62]=d[61]:d[62]=void 0,d[48]=d[62]}])},function(a){return c.i64.neq(d[48],void 0)?d[49]=d[48]:d[49]=c.i64.cast([0,0]),c.i64.neq(d[52],void 0)?d[50]=d[52]:d[50]=c.i64.cast([0,1]),a=[e.backupId,e.deviceId,e.mailboxRootKeyBlob,e.ocmfClientStateBlob,void 0,void 0,d[49],d[50],e.epochAuthPublicKeyBlob,e.epochAuthPrivateKeyBlob,e.devicePublicKeyBlob,e.devicePrivateKeyBlob,e.epochStoragePublicKeyBlob,e.epochStoragePrivateKeyBlob,e.obliviousValidationTokenBlob,e.authorityLevel,void 0],d[27]=a[0],d[28]=a[1],d[29]=a[2],d[30]=a[3],d[31]=a[4],d[32]=a[5],d[33]=a[6],d[34]=a[7],d[35]=a[8],d[36]=a[9],d[37]=a[10],d[38]=a[11],d[39]=a[12],d[40]=a[13],d[41]=a[14],d[42]=a[15],d[43]=a[16],a}]))})},function(a){return c.i64.eq(d[42],c.i64.cast([0,80]))&&c.i64.eq(d[34],c.i64.cast([0,2]))?d[45]=c.i64.or_(c.i64.cast([0,82]),c.i64.cast([0,128])):d[45]=c.i64.cast([0,82]),c.sequence([function(a){return c.nativeOperation(b("LSCreateDataTraceID.nop")).then(function(a){return a=a,d[47]=a[0],a})},function(a){return c.sequence([function(a){return d[51]="EncryptedBackups MCD Trace ID",d[52]=c.i64.to_string(d[45]),d[50]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBTraceUtils] ",d[50],d[51],d[50],d[52]].join("")),c.resolve()},function(a){return c.storedProcedure(b("LSCreateDataTrace"),d[47],void 0,void 0,"media_restore",d[45])}])},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[48]=a[0],a})},function(a){return d[48]?d[49]=!0:d[49]=!1,d[49]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[50]=c.createArray(),void 0!==void 0?d[51]=(d[50].push(void 0),d[50]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[50],c.i64.cast([0,3]))):c.resolve()},function(a){return d[46]=d[47]}])},function(a){return d[1]=d[46]}])},function(a){return c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,1829]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[27]?d[28]=!0:d[28]=!1,d[28]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[29]=c.createArray(),void 0!==void 0?d[30]=(d[29].push(void 0),d[29]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[29],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?(f=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,20]),void 0],d[2]=f[0],d[3]=f[1],d[4]=f[2],d[5]=f[3],d[6]=f[4],d[7]=f[5],d[8]=f[6],d[9]=f[7],d[10]=f[8],d[11]=f[9],d[12]=f[10],d[13]=f[11],d[14]=f[12],d[15]=f[13],d[16]=f[14],d[17]=f[15],d[18]=f[16],f):(e=a.item,c.sequence([function(a){return d[32]=e.backupTenancy,d[31]=e.encryptionVersion,d[27]=void 0,c.i64.neq(d[27],void 0)?c.resolve(d[28]=d[27]):c.sequence([function(a){return d[33]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[34]=a[0],a})},function(a){return d[34]?d[43]=(d[33].push(c.i64.cast([0,0])),d[33]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[35]=a[0],a})},function(a){return d[35]?d[43]=(d[33].push(c.i64.cast([0,2])),d[33]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[36]=a[0],a})},function(a){return d[36]?d[43]=(d[33].push(c.i64.cast([0,3])),d[33]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[37]=a[0],a})},function(a){return d[37]?d[43]=(d[33].push(c.i64.cast([0,4])),d[33]):0,d[38]=c.createArray(),d[39]=c.i64.of_int32(d[33].length),c.i64.gt(d[39],c.i64.cast([0,0]))?c.loopAsync(d[39],function(a){return d[43]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[33],d[43]).then(function(a){return a=a,d[44]=a[0],d[45]=a[1],a})},function(a){return d[46]=(d[38].push(d[44]),d[38])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[43]=c.createArray(),d[44]=c.i64.of_int32(d[38].length),c.i64.gt(d[44],c.i64.cast([0,0]))?c.loopAsync(d[44],function(a){return d[46]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[38],d[46]).then(function(a){return a=a,d[47]=a[0],d[48]=a[1],a})},function(a){return d[49]=(d[43].push(c.i64.to_string(d[47])),d[43])}])}):c.resolve()},function(a){return d[45]=d[43].join(","),d[40]=d[45]}])},function(a){return d[38].some(function(a){return c.i64.eq(d[31],a)})?d[41]=d[31]:d[41]=void 0,c.i64.neq(d[41],void 0)?d[42]=d[41]:d[42]=void 0,d[28]=d[42]}])},function(a){return c.i64.neq(d[28],void 0)?d[29]=d[28]:d[29]=c.i64.cast([0,0]),c.i64.neq(d[32],void 0)?d[30]=d[32]:d[30]=c.i64.cast([0,1]),a=[e.backupId,e.deviceId,e.mailboxRootKeyBlob,e.ocmfClientStateBlob,void 0,void 0,d[29],d[30],e.epochAuthPublicKeyBlob,e.epochAuthPrivateKeyBlob,e.devicePublicKeyBlob,e.devicePrivateKeyBlob,e.epochStoragePublicKeyBlob,e.epochStoragePrivateKeyBlob,e.obliviousValidationTokenBlob,e.authorityLevel,void 0],d[2]=a[0],d[3]=a[1],d[4]=a[2],d[5]=a[3],d[6]=a[4],d[7]=a[5],d[8]=a[6],d[9]=a[7],d[10]=a[8],d[11]=a[9],d[12]=a[10],d[13]=a[11],d[14]=a[12],d[15]=a[13],d[16]=a[14],d[17]=a[15],d[18]=a[16],a}]))})},function(a){return c.storedProcedure(b("LSFindBackup")).then(function(a){return a=a,d[20]=a[0],a})},function(e){return c.blobs.neq(d[5],void 0)?c.i64.neq(d[3],void 0)?d[20]!==void 0?c.blobs.neq(d[4],void 0)?c.sequence([function(e){return d[27]=c.createArray(),d[34]=(d[27].push(d[20]),d[27]),d[34]=(d[27].push(a[1]),d[27]),d[28]=c.toJSON(d[27]),d[29]=c.createArray(),d[34]=(d[29].push(c.i64.cast([0,32])),d[29]),c.nativeOperation(b("LSGetBlobFromString.nop"),["thread_ope_key","_",a[5]].join("")).then(function(a){return a=a,d[30]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),d[30],void 0,d[4],d[29]).then(function(a){return a=a,d[31]=a[0],a})},function(a){return d[31]?d[32]=!1:d[32]=!0,d[32]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] Got null keys while deriving message list OPE key. Returning null blobish"),d[34]=c.createArray(),void 0!==void 0?d[35]=(d[34].push(void 0),d[34]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","Got null keys while deriving message list OPE key. Returning null blobish",d[34],c.i64.cast([0,3]))},function(a){return d[33]=void 0}]):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[31],c.i64.cast([0,0])).then(function(a){return a=a,d[34]=a[0],d[35]=a[1],a})},function(a){return d[33]=d[34]}])},function(e){return c.blobs.neq(d[33],void 0)?c.sequence([function(e){return c.i64.neq(a[9],void 0)?d[34]=a[9]:d[34]=c.i64.cast([-1,4294967295]),c.nativeOperation(b("LSGetBlobFromInt64BE.nop"),a[6]).then(function(a){return a=a,d[35]=a[0],a})},function(a){return c.nativeOperation(b("LSTruncateSortKey.nop"),d[35]).then(function(a){return a=a,d[36]=a[0],a})},function(a){return c.nativeOperation(b("LSOpeEncrypt.nop"),d[33],d[36],c.i64.cast([0,16])).then(function(a){return a=a,d[37]=a[0],a})},function(a){return c.nativeOperation(b("LSBinaryToHex.nop"),d[37]).then(function(a){return a=a,d[38]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[28]).then(function(a){return a=a,d[39]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2NvcGU="),d[39]).then(function(a){return a=a,d[40]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[40]).then(function(a){return a=a,d[41]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[41]).then(function(a){return a=a,d[42]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[20]).then(function(a){return a=a,d[43]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWFpbGJveF9pZF9zY29wZQ=="),d[43]).then(function(a){return a=a,d[44]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[44]).then(function(a){return a=a,d[45]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[45]).then(function(a){return a=a,d[46]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[47]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWVzc2FnZV9pZF9zY29wZQ=="),d[47]).then(function(a){return a=a,d[48]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[48]).then(function(a){return a=a,d[49]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[49]).then(function(a){return a=a,d[50]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[51]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[51]).then(function(a){return a=a,d[52]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[52]).then(function(a){return a=a,d[53]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[53]).then(function(a){return a=a,d[54]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[5]).then(function(a){return a=a,d[55]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("dGhyZWFkX2lkX3Njb3Bl"),d[55]).then(function(a){return a=a,d[56]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[56]).then(function(a){return a=a,d[57]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[57]).then(function(a){return a=a,d[58]=a[0],a})},function(e){return d[59]=new c.Map(),d[59].set("attachment_index_key",d[42]==null?"":d[42]),d[59].set("backup_ent_fbid",a[0]),d[59].set("delivery_object_id",a[1]),d[59].set("device_id",d[3]),d[59].set("mailbox_partial_id",d[46]==null?"":d[46]),d[59].set("media_type",a[3]),d[59].set("message_partial_id",d[50]==null?"":d[50]),d[59].set("product_type",a[2]),d[59].set("salt_partial_id",d[54]==null?"":d[54]),d[59].set("sort_key",d[38]==null?"":d[38]),d[59].set("thread_partial_id",d[58]==null?"":d[58]),d[59].set("trace_id",d[1]),d[59].set("source",d[34]),d[60]=new c.Map(),d[60].set("otid",a[4]),d[60].set("server_thread_key",a[8]),d[60].set("timestamp",c.i64.to_string(a[6])),c.nativeOperation(b("LSBase64Encode.nop"),d[5]).then(function(a){return a=a,d[61]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[4]).then(function(a){return a=a,d[62]=a[0],a})},function(e){return d[63]=new c.Map(),d[63].set("ocmf_client_state_blob",d[61]==null?"":d[61]),d[63].set("mailbox_root_key",d[62]==null?"":d[62]),d[64]=c.createArray(),d[75]=(d[64].push(a[4]),d[64]),d[75]=(d[64].push(a[1]),d[64]),d[65]=c.toJSON(d[64]),d[59].set("raw_identifiers",d[60]),d[59].set("backup_id",d[20]),d[59].set("thread_id",a[5]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[65]).then(function(a){return a=a,d[66]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[66]).then(function(a){return a=a,d[67]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[67]).then(function(a){return a=a,d[68]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[68]).then(function(a){return a=a,d[69]=a[0],a})},function(a){return d[59].set("salt_partial_access_token",d[69]==null?"":d[69]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[28]).then(function(a){return a=a,d[70]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2FsdF9zY29wZQ=="),d[70]).then(function(a){return a=a,d[71]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[71]).then(function(a){return a=a,d[72]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[72]).then(function(a){return a=a,d[73]=a[0],a})},function(a){return d[59].set("salt_partial_attachment_index_key",d[73]==null?"":d[73]),d[59].set("raw_tokens",d[63]),d[74]=c.toJSON(d[59]),c.storedProcedure(b("LSIssueNewTask"),"encrypted_backups_attachment_restore",c.i64.cast([0,50020]),d[74],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))}]):(d[34]="OPE key is null for IssueAttachmentRestoreTask",d[34]!==void 0?c.sequence([function(a){return d[36]=["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",d[34]].join(""),function(a){c.logger(a).mustfix(a)}(d[36]),d[35]=c.createArray(),d[1]!==void 0?d[37]=(d[35].push(d[1]),d[35]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure",d[34],d[35],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),d[36],void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[39]=a[0],a})},function(a){return d[39]?d[40]=!0:d[40]=!1,d[40]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[41]=c.createArray(),void 0!==void 0?d[42]=(d[41].push(void 0),d[41]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[41],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[37]=a[0],a})},function(a){return d[37]?d[38]=!0:d[38]=!1,d[38]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[39]=c.createArray(),void 0!==void 0?d[40]=(d[39].push(void 0),d[39]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[39],c.i64.cast([0,3]))):c.resolve()}])}]):c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",""].join(""),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[37]=a[0],a})},function(a){return d[37]?d[38]=!0:d[38]=!1,d[38]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[39]=c.createArray(),void 0!==void 0?d[40]=(d[39].push(void 0),d[39]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[39],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[35]=a[0],a})},function(a){return d[35]?d[36]=!0:d[36]=!1,d[36]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[37]=c.createArray(),void 0!==void 0?d[38]=(d[37].push(void 0),d[37]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[37],c.i64.cast([0,3]))):c.resolve()}]))}]):(d[27]="Missing mailbox_root_key for IssueAttachmentRestoreTask",d[27]!==void 0?c.sequence([function(a){return d[29]=["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",d[27]].join(""),function(a){c.logger(a).mustfix(a)}(d[29]),d[28]=c.createArray(),d[1]!==void 0?d[30]=(d[28].push(d[1]),d[28]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure",d[27],d[28],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),d[29],void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[32]=a[0],a})},function(a){return d[32]?d[33]=!0:d[33]=!1,d[33]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[34]=c.createArray(),void 0!==void 0?d[35]=(d[34].push(void 0),d[34]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[34],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[30]=a[0],a})},function(a){return d[30]?d[31]=!0:d[31]=!1,d[31]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[32]=c.createArray(),void 0!==void 0?d[33]=(d[32].push(void 0),d[32]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[32],c.i64.cast([0,3]))):c.resolve()}])}]):c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",""].join(""),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[30]=a[0],a})},function(a){return d[30]?d[31]=!0:d[31]=!1,d[31]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[32]=c.createArray(),void 0!==void 0?d[33]=(d[32].push(void 0),d[32]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[32],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[28]=a[0],a})},function(a){return d[28]?d[29]=!0:d[29]=!1,d[29]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[30]=c.createArray(),void 0!==void 0?d[31]=(d[30].push(void 0),d[30]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[30],c.i64.cast([0,3]))):c.resolve()}])):(d[27]="Missing backup_id for IssueAttachmentRestoreTask",d[27]!==void 0?c.sequence([function(a){return d[29]=["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",d[27]].join(""),function(a){c.logger(a).mustfix(a)}(d[29]),d[28]=c.createArray(),d[1]!==void 0?d[30]=(d[28].push(d[1]),d[28]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure",d[27],d[28],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),d[29],void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[32]=a[0],a})},function(a){return d[32]?d[33]=!0:d[33]=!1,d[33]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[34]=c.createArray(),void 0!==void 0?d[35]=(d[34].push(void 0),d[34]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[34],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[30]=a[0],a})},function(a){return d[30]?d[31]=!0:d[31]=!1,d[31]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[32]=c.createArray(),void 0!==void 0?d[33]=(d[32].push(void 0),d[32]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[32],c.i64.cast([0,3]))):c.resolve()}])}]):c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",""].join(""),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[30]=a[0],a})},function(a){return d[30]?d[31]=!0:d[31]=!1,d[31]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[32]=c.createArray(),void 0!==void 0?d[33]=(d[32].push(void 0),d[32]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[32],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[28]=a[0],a})},function(a){return d[28]?d[29]=!0:d[29]=!1,d[29]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[30]=c.createArray(),void 0!==void 0?d[31]=(d[30].push(void 0),d[30]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[30],c.i64.cast([0,3]))):c.resolve()}])):(d[27]="Missing device_id for IssueAttachmentRestoreTask",d[27]!==void 0?c.sequence([function(a){return d[29]=["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",d[27]].join(""),function(a){c.logger(a).mustfix(a)}(d[29]),d[28]=c.createArray(),d[1]!==void 0?d[30]=(d[28].push(d[1]),d[28]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure",d[27],d[28],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),d[29],void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[32]=a[0],a})},function(a){return d[32]?d[33]=!0:d[33]=!1,d[33]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[34]=c.createArray(),void 0!==void 0?d[35]=(d[34].push(void 0),d[34]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[34],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[30]=a[0],a})},function(a){return d[30]?d[31]=!0:d[31]=!1,d[31]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[32]=c.createArray(),void 0!==void 0?d[33]=(d[32].push(void 0),d[32]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[32],c.i64.cast([0,3]))):c.resolve()}])}]):c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",""].join(""),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[30]=a[0],a})},function(a){return d[30]?d[31]=!0:d[31]=!1,d[31]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[32]=c.createArray(),void 0!==void 0?d[33]=(d[32].push(void 0),d[32]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[32],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[28]=a[0],a})},function(a){return d[28]?d[29]=!0:d[29]=!1,d[29]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[30]=c.createArray(),void 0!==void 0?d[31]=(d[30].push(void 0),d[30]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[30],c.i64.cast([0,3]))):c.resolve()}])):(d[27]="Missing ocmf_client_state_blob for IssueAttachmentRestoreTask",d[27]!==void 0?c.sequence([function(a){return d[29]=["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",d[27]].join(""),function(a){c.logger(a).mustfix(a)}(d[29]),d[28]=c.createArray(),d[1]!==void 0?d[30]=(d[28].push(d[1]),d[28]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure",d[27],d[28],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),d[29],void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[32]=a[0],a})},function(a){return d[32]?d[33]=!0:d[33]=!1,d[33]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[34]=c.createArray(),void 0!==void 0?d[35]=(d[34].push(void 0),d[34]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[34],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[30]=a[0],a})},function(a){return d[30]?d[31]=!0:d[31]=!1,d[31]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[32]=c.createArray(),void 0!==void 0?d[33]=(d[32].push(void 0),d[32]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[32],c.i64.cast([0,3]))):c.resolve()}])}]):c.sequence([function(a){return d[1]!==void 0?c.sequence([function(a){return d[1]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[1],c.i64.cast([0,85]),c.i64.cast([0,2]),["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ","",""].join(""),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[30]=a[0],a})},function(a){return d[30]?d[31]=!0:d[31]=!1,d[31]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[32]=c.createArray(),void 0!==void 0?d[33]=(d[32].push(void 0),d[32]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[32],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[1]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),d[1]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[28]=a[0],a})},function(a){return d[28]?d[29]=!0:d[29]=!1,d[29]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[30]=c.createArray(),void 0!==void 0?d[31]=(d[30].push(void 0),d[30]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[30],c.i64.cast([0,3]))):c.resolve()}]))},function(a){return d[21]=c.i64.of_float(Date.now()),d[22]=c.i64.random(),d[24]="Finishing execution. Execution time: ",d[25]=c.i64.to_string(c.i64.sub(d[21],d[0])),d[26]=" ms",d[23]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure] ",d[23],d[24],d[23],d[25],d[23],d[26]].join("")),c.i64.eq(c.i64.mod_(d[22],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[27]=",",d[28]=c.createArray(),void 0!==void 0?d[29]=(d[28].push(void 0),d[28]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure",[d[24],d[27],d[25],d[27],d[26]].join(""),d[28],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsIssueAttachmentRestoreTaskStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];e.exports=a}),null);
__d("LSIssueAttachmentRestoreTaskStoredProcedure",["LSIssueAttachmentRestoreTask","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSIssueAttachmentRestoreTask"),e.backupEntFbid,e.deliveryObjectId,e.productType,e.mediaType,e.messageId,e.threadId,e.sortOrder,e.traceId,e.serverThreadKey,e.source);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MebMIMediaDownloader",["FBLogger","WADirectPath","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){function a(a,c){this.mediaDownloadMetadata=a;this.callbacks={onResignCdnUrlFailure:(a=c==null?void 0:c.onResignCdnUrlFailure)!=null?a:b("asyncToGeneratorRuntime").asyncToGenerator(function*(){}),onResignCdnUrlSuccess:(a=c==null?void 0:c.onResignCdnUrlSuccess)!=null?a:b("asyncToGeneratorRuntime").asyncToGenerator(function*(){})}}var e=a.prototype;e.getDownloadMetadata=function(){return this.mediaDownloadMetadata};e.handle=function(){throw c("FBLogger")("labyrinth_web").mustfixThrow("[MebMIMediaDownloader] Please don't use the base class. Instead use either MAWMIMediaDownloader or IGDMIMediaDownloader, depending on the platform.")};e["continue"]=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;yield this.callbacks.onResignCdnUrlSuccess();b=(b=this.waMediaDownloader)==null?void 0:b.getDownloadMetadata();if(b!=null){var c=b.mediaEntry;c.directPath=d("WADirectPath").unsafeCastToDirectPath(a);b.isUrlRenewed=!0;yield (c=this.waMediaDownloader)==null?void 0:c.handle()}});function a(b){return a.apply(this,arguments)}return a}();e.handleError=function(a){return this.callbacks.onResignCdnUrlFailure(a)};e.setNextHandler=function(a){this.waMediaDownloader=a};return a}();g["default"]=a}),98);
__d("MAWMIMediaDownloader",["FBLogger","I64","LSDatabaseSingleton","LSFactory","LSIntEnum","LSIssueAttachmentRestoreTaskStoredProcedure","LSMEBTaskCreationSource","MAWCastToMsgrServerMediaType","MAWLoggerUtils","MAWThreadKeyUtils","MebMIMediaDownloader","MediaDownloadMediator","Promise","WALogger","WAMediaUtils","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);l=function(){return a};return a}a=function(a){babelHelpers.inheritsLoose(e,a);function e(){return a.apply(this,arguments)||this}var g=e.prototype;g.handle=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this,e=(yield (k||(k=d("LSDatabaseSingleton"))).LSDatabaseSingleton);d("MediaDownloadMediator").mapDeliveryObjectIdToMediaDownloader(d("WAMediaUtils").stringToDeliveryObjectId(this.mediaDownloadMetadata.deliveryObjectId),this);var g=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(this.mediaDownloadMetadata.mediaType);if(g==null)throw c("FBLogger")("labyrinth_web").mustfixThrow("Unsupported media type");var m=d("MAWThreadKeyUtils").stringThreadKeyToString(this.mediaDownloadMetadata.threadKey),n=new(h||(h=b("Promise")))(function(a,b){window.setTimeout(function(){b(c("err")("[labyrinth_web][MIMediaDownloader] MI Media download timed out"))},2*60*1e3)}),o=d("MAWLoggerUtils").getInstanceKey();return h.race([e.runInTransaction(function(b){return c("LSIssueAttachmentRestoreTaskStoredProcedure")(c("LSFactory")(b),{backupEntFbid:(i||(i=d("I64"))).of_string(a.mediaDownloadMetadata.backupEntFbid),deliveryObjectId:a.mediaDownloadMetadata.deliveryObjectId,mediaType:g,messageId:a.mediaDownloadMetadata.messageId,productType:a.mediaDownloadMetadata.productType,serverThreadKey:m,sortOrder:i.of_float(a.mediaDownloadMetadata.sortOrder),source:(j||(j=d("LSIntEnum"))).ofNumber(c("LSMEBTaskCreationSource").MSGR_DYI),threadId:a.mediaDownloadMetadata.threadId,traceId:o.toString()})},"readwrite",void 0,void 0,f.id+":68"),n])["catch"](function(b){d("WALogger").ERROR(l(),b.message);return a.handleError(b)})});function e(){return a.apply(this,arguments)}return e}();return e}(c("MebMIMediaDownloader"));g.MAWMIMediaDownloader=a}),98);
__d("MAWEncryptedBackupsDYIProcessProtobufMessages",["CurrentUser","EncryptedBackupsDYIMessageProcessingUtils","EncryptedBackupsDYISingleton","MAWFrontendMediaUtils","MAWGroupPollsDualEncryptionUtils","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoProtobufsRestoreApi","MAWJids","MAWMIMediaDownloader","MAWMsgType","MebWAMediaDownloader","Promise","WAHashUtils","WAJids","WALongInt","WAMediaUtils","WAStanzaUtils","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Polls] Decryption failure when trying to decrypt poll vote update: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Polls] senderTimestampMs is null. Cannot determine the latest poll vote"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Polls] Decryption failure when trying to decrypt poll add option update: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Polls] Poll creation message key is incomplete. Skipping"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Group poll creation message is missing group poll info"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Explicitly dropping "," message type"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Bump message is not supported in DYI"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] XMA message doesn't have xmaData"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["Documents are not supported in DYI"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error processing protobuf: ts or messageId or senderId is null"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error processing protobuf: metadata or message type is null"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error processing protobuf. Dropping the message: ",""]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error converting protobuf to DYI format. Dropping the message"]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error converting protobuf to DYI format. Dropping the message"]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["Decoded protobuf is empty"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing "," protobuf messages for thread ",""]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Media message is missing encrypted hash"]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Media message is missing media key"]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Starting DYI media download for attachemnt with hash ",""]);A=function(){return a};return a}function B(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Media message is missing media data"]);B=function(){return a};return a}function a(a,b,c){return C.apply(this,arguments)}function C(){C=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){var f=d("EncryptedBackupsDYISingleton").getSingleton(),g=f.getLogger();void g.LOG(x(),e.length,b);var h=d("MAWJids").toUserJid(c("CurrentUser").getAccountID()),i=!0,j=!1,k;try{for(var l=babelHelpers.asyncIterator(e),e,e;e=(yield l.next()),i=e.done,e=(yield e.value),!i;i=!0){e=e;try{e=d("MAWHandleEchoProtobufsRestoreApi").decodeDecryptedMessageProtobuf(e,h,void 0,new Set(),new Set(),new Map(),new Map(),new Map(),!0);if(e==null){void g.WARN(w());return}if(e!=null&&e.metadata!=null&&e.metadata.messageId!=null){var m=d("WAStanzaUtils").toStanzaId(e.metadata.messageId);e=(yield D(a,b,e));if(e==null){void g.WARN(v());return}f.setMessagesByThreadKey(a,m,e)}else{void g.WARN(u());return}}catch(a){void g.ERROR(t(),a);return}}}catch(a){j=!0,k=a}finally{try{!i&&l["return"]!=null&&(yield l["return"]())}finally{if(j)throw k}}});return C.apply(this,arguments)}function D(a,b,c){return E.apply(this,arguments)}function E(){E=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e=d("EncryptedBackupsDYISingleton").getSingleton(),f=e.getLogger(),g=c.metadata,h=c.msgType,i=c.sortOrderMs;if(g==null||h==null){void f.WARN(s());return}h=g.messageId;var j=g.senderId;g=g.timestampMs;if(g==null||typeof g!=="number"||h==null||j==null){void f.WARN(r());return}h=d("WATimeUtils").castMilliSecondsToUnixTime(g);g=d("EncryptedBackupsDYIMessageProcessingUtils").buildBaseDyiMessage(j,i);j=(j=c.decodedPayload)==null?void 0:j.text;if(c.editMsgData.length>0){var k=h;c.editMsgData.forEach(function(a){var b;if(a.ts>k&&((b=a.editMsgContent.message)==null?void 0:b.text)!=null){k=a.ts;j=(b=a.editMsgContent.message)==null?void 0:b.text}})}c.reactionData.length>0&&(g.reactions=c.reactionData.map(function(a){var b=a.reaction;a=a.senderId;return{actor:(a=e.getContactNameForContactId(a))!=null?a:"unknown",reaction:(a=b.text)!=null?a:"unknown"}}));switch(c.msgType){case d("MAWMsgType").MSG_TYPE.TEXT:g.type="text";g.text=j||"";break;case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.PTT:g.type="media";g.text=j||"";g=H(a,b,c,i,g);break;case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:void f.WARN(q());return;case d("MAWMsgType").MSG_TYPE.XMA:g.type="link";if(c.xmaData==null){void f.WARN(p());return}g.text=((h=c.xmaData)==null?void 0:h.ctas.map(function(a){return a.nativeUrl}).filter(Boolean).join("\n"))||"";break;case d("MAWMsgType").MSG_TYPE.REVOKED:g.type="placeholder";g.isUnsent=!0;g.text="User unsent a message";break;case d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:g.type="poll";g.text=(yield F(c));break;case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:void f.WARN(o());return;default:void f.LOG(n(),c.msgType);return}return g});return E.apply(this,arguments)}function F(a){return G.apply(this,arguments)}function G(){G=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=d("EncryptedBackupsDYISingleton").getSingleton().getLogger(),e=a.groupPollInfo;if(e==null){void c.WARN(m());return""}var f=new Map(),g=new Map();yield (h||(h=b("Promise"))).all(e.options.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield d("MAWGroupPollsDualEncryptionUtils").getHashForOptionName(a));f.set(b,{optionName:a,voterUserJids:[]})});return function(b){return a.apply(this,arguments)}}()));if(a.groupPollUpdateData!=null){var n=!0,o=!1,p;try{for(var q=babelHelpers.asyncIterator(a.groupPollUpdateData),r,r;r=(yield q.next()),n=r.done,r=(yield r.value),!n;n=!0){var s,t;r=r;if(((s=r.pollCreationMessageKey)==null?void 0:s.id)==null||((s=r.pollCreationMessageKey)==null?void 0:s.remoteJid)==null){c.ERROR(l());continue}s=r.pollCreationMessageKey;var u=s.id;s=s.remoteJid;s=d("WAJids").unsafeCoerceToUserJid(s);t={pollCreationMessageKey:e.encKey,pollCreationSenderJid:d("WAJids").toMsgrUserJid(((t=a.metadata)==null?void 0:t.senderId)||""),pollCreationStanzaId:d("WAStanzaUtils").toStanzaId(u),pollUpdateSenderJid:s,pollUpdateStanzaId:r.externalId};if(r.addOption!=null){u=(yield d("MAWGroupPollsDualEncryptionUtils").decryptGroupPollAddOption(r.addOption,t));if(u.success){var v=u.value,w=!0,x=!1,y;try{for(var z=babelHelpers.asyncIterator(v.pollOption),v,v;v=(yield z.next()),w=v.done,v=(yield v.value),!w;w=!0){v=v;if(v.optionName==null)continue;v=v.optionName;var A=(yield d("MAWGroupPollsDualEncryptionUtils").getHashForOptionName(v));f.has(A)||f.set(A,{optionName:v,voterUserJids:[]})}}catch(a){x=!0,y=a}finally{try{!w&&z["return"]!=null&&(yield z["return"]())}finally{if(x)throw y}}}else c.ERROR(k(),u.error)}if(r.vote!=null){A=(yield d("MAWGroupPollsDualEncryptionUtils").decryptGroupPollVote(r.vote,t));if(A.success){v=A.value;if(v.senderTimestampMs==null){c.WARN(j());continue}w=v.selectedOptions;x=v.senderTimestampMs;u=g.get(s);(u==null||u.senderTimestampMs<d("WALongInt").numberOrThrowIfTooLarge(x))&&g.set(s,{senderTimestampMs:d("WALongInt").numberOrThrowIfTooLarge(x),votes:w.map(d("MAWGroupPollsDualEncryptionUtils").getBase64EncodedHash)})}else c.ERROR(i(),A.error)}}}catch(a){o=!0,p=a}finally{try{!n&&q["return"]!=null&&(yield q["return"]())}finally{if(o)throw p}}}for(r of g){t=r[0];v=r[1];for(u of v.votes){s=f.get(u);s==null?f.set(u,{optionName:"Unknown",voterUserJids:[t]}):f.set(u,babelHelpers["extends"]({},s,{voterUserJids:[].concat(s.voterUserJids,[t])}))}}return"Question: "+e.name+"; Options: "+Array.from(f).map(function(a){a[0];a=a[1];var b=a.optionName;a=a.voterUserJids;return b+" ("+a.length+" votes"+(a.length>0?": "+a.map(function(a){return d("EncryptedBackupsDYIMessageProcessingUtils").getSenderName(d("WAJids").userIdFromJid(d("WAJids").unsafeCoerceToUserJid(a)))}).join(", "):"")+")"}).join("; ")});return G.apply(this,arguments)}function H(a,b,c,e,f){var g,h=d("EncryptedBackupsDYISingleton").getSingleton(),i=h.getLogger();if(c.mediaMetadata==null){void i.WARN(B());return f}var j=c.mediaMetadata,k=j.attachmentObjectId,l=j.backupEntFbid,m=j.directPath,n=j.encryptedHash,o=j.filename,p=j.mediaContentType,q=j.mediaKey,r=j.mediaKeyTimestamp,s=j.plaintextHash;j=j.size;g=(g=(g=c.metadata)==null?void 0:g.senderId)!=null?g:"0";c=d("WAStanzaUtils").toStanzaId(c.externalId);s=d("WAHashUtils").stringToPlaintextHash(s);p=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(p||"");p=p.serverMediaType;f.media.add(s);if(!h.isAttachmentDownloadInProgressForPlaintextHash(s)&&!h.isAttachmentDownloadCompleteForPlaintextHash(s)){void i.LOG(A(),d("WAHashUtils").sanitisePlaintextHash(s));h.addPlaintextHashToAttachmentDownloadsInProgress(s);if(q==null){i.ERROR(z());return f}if(n==null){i.ERROR(y());return f}h=d("MAWHandleEchoMediaMsgsRestoreV2").constructMediaEntry(s,n,q,m,r,p,o,l,k,null,j);i=d("WAMediaUtils").decodeMediaEntryData(h);void d("EncryptedBackupsDYIMessageProcessingUtils").startMediaDownloadChain(d("MebWAMediaDownloader").MebWADownloadMediaThroughTheBridge,"-8","msgr",i,b,a,g,c,s,e,function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return babelHelpers.construct(d("MAWMIMediaDownloader").MAWMIMediaDownloader,b)})}return f}g.processEBProtobufMessagesForDYI=a}),98);
__d("MAWEncryptedBackupsDYIHandleMessageRestore",["EncryptedBackupsDYIHandleMessageRestore","I64","LSDatabaseSingleton","LSFactory","LSIntEnum","LSIssueMessageRangeQueryTaskStoredProcedure","LSMEBTaskCreationSource","MAWEBRestoreTrackingUtils","MAWEncryptedBackupsDYIProcessProtobufMessages","asyncToGeneratorRuntime","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=(h||d("LSIntEnum")).ofNumber(c("LSMEBTaskCreationSource").MSGR_DYI),l=c("justknobx")._("467"),m=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){d("MAWEBRestoreTrackingUtils").markEBRestoreDYI(c("LSMEBTaskCreationSource").MSGR_DYI),yield a.runInTransaction(function(a){return c("LSIssueMessageRangeQueryTaskStoredProcedure")(c("LSFactory")(a),{isPointQuery:!1,newerNumMessages:(i||(i=d("I64"))).zero,numMessages:i.of_int32(l),source:k,startSortKey:b,threadId:e})},"readwrite",void 0,void 0,f.id+":39")});return function(b,c,d){return a.apply(this,arguments)}}();function a(a,b,c,d){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){var f=(yield (j||(j=d("LSDatabaseSingleton"))).LSDatabaseSingleton);yield d("EncryptedBackupsDYIHandleMessageRestore").handleMessageRangeQueryRestore(f,a,b,c,e,d("MAWEncryptedBackupsDYIProcessProtobufMessages").processEBProtobufMessagesForDYI,m)});return n.apply(this,arguments)}g.taskCreationSource=k;g.MESSENGER_DYI_BATCH_SIZE=l;g.handleMAWProtobufMessageRangeQueryRestore=a}),98);
__d("LSProtobufRestoreHandler",["CurrentUser","LSIntEnum","LSMEBTaskCreationSource","LSVec","MAWAsyncEBPendingQueryPromise","MAWEBRestoreTrackingUtils","MAWEBUnstoredDbMsgUtils","MAWEncryptedBackupUtils","MAWEncryptedBackupsDYIHandleMessageRestore","MAWJids","MAWJobDefinitions","MAWRestoreProtobufsFromEncryptedBackupsDeferred","Promise","WATagsLogger","asyncToGeneratorRuntime","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - Failed to restore protobufs, with error: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Restoring Messenger DYI batch"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - no messages but hasMoreBefore is true"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - Failed to decode protobufs, with error: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - no decoded messages but hasMoreBefore is true, messages count after decryption: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Protobuf restore native op called with invalid/null protobuf payload"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - ",""]);p=function(){return a};return a}function a(a,b,c,d,e,f,g,h,i,j,k,l,m,n){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,q,s,t,u,v,w,x,y,z,A){var B=null;y!=null&&(B=r(y));d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore",(y=v)!=null?y:"no_request_id"]).LOG(p(),(y=v)!=null?y:"no_request_id");d("MAWEBRestoreTrackingUtils").markEBRestoreProtobuf(z);if(f!=null)y=f;else if(e!=null)y=d("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(e);else{d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore",(f=v)!=null?f:"no_request_id"]).ERROR(o());d("MAWEBRestoreTrackingUtils").markEBRestoreFail(v,!1,"invalid_protobuf_payload");return(i||(i=b("Promise"))).resolve()}d("MAWEncryptedBackupUtils").logIfDuplicateMessagesFoundInRestore(y,"protobuf_restore");if(v!=null)try{d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_start",traceId:v,type:"protobuf"});f=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());f=d("MAWEBUnstoredDbMsgUtils").getUnstoredDbMsgFromProtobuf(y,a,void 0,f);if(g===!0&&f.length===0){var C;d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"hasMoreBefore_decodedMessages_inconsistency",traceId:v,type:"protobuf"});e=e!=null?c("LSVec").toArray(e).length:0;d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore",(C=v)!=null?C:"no_request_id"]).ERROR(n(),e)}d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryIfPresent(v,{echoMessages:B,hasMoreAfter:s,hasMoreBefore:g,isPointQuery:u,messages:f,nextMessageTimestampMsBefore:q,protobufMessages:y,referenceTimestamp:w,requestId:v,restoreType:"protobuf",threadId:a})}catch(a){d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore",(C=v)!=null?C:"no_request_id"]).ERROR(m(),a.message);d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(v,a)}if(g===!0&&y.length===0){v!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"hasMoreBefore_messages_inconsistency",traceId:v,type:"protobuf"});d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore",(e=v)!=null?e:"no_request_id"]).ERROR(l())}f=z!=null&&(h||(h=d("LSIntEnum"))).unwrapIntEnum(z)===c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB;if(f){v!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"search_restore_end",traceId:v,type:"protobuf"});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(v);return(i||(i=b("Promise"))).resolve()}C=z!=null&&(h||(h=d("LSIntEnum"))).unwrapIntEnum(z)===c("LSMEBTaskCreationSource").MSGR_DYI;if(C){d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore",(e=v)!=null?e:"no_request_id"]).LOG(k());yield d("MAWEncryptedBackupsDYIHandleMessageRestore").handleMAWProtobufMessageRangeQueryRestore(a,y,g,q);v!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"dyi_restore_end",traceId:v,type:"protobuf"});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(v);return(i||(i=b("Promise"))).resolve()}c("promiseDone")(d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(a),y,g,q,s,t,u,v,w,x,B,z,void 0,(f=A)!=null?f:void 0),function(){v!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_end",traceId:v,type:"protobuf"})},function(a){var b;d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore",(b=v)!=null?b:"no_request_id"]).ERROR(j(),a.message);b={string:{error:a.message}};v!=null&&d("MAWEBRestoreTrackingUtils").markEBRestoreFail(v,!1,"native_op_reject",b)});return(i||(i=b("Promise"))).resolve()});return q.apply(this,arguments)}function r(a){return c("LSVec").toArray(a).map(function(a){return d("MAWJobDefinitions").toEncodedEchoMessage(a)})}g.handleProtobufRestoreHelper=a;g.convertLSEchoMessageVecToArray=r}),98);
__d("LSEBUnifiedRestoreUtils",["CurrentUser","LSIntEnum","LSMEBTaskCreationSource","LSProtobufRestoreHandler","LSVec","MAWAsyncEBPendingQueryPromise","MAWBridgeSafeActionsWorkerAndUI","MAWEBRestoreTrackingUtils","MAWEBUnstoredDbMsgUtils","MAWEncryptedBackupUtils","MAWEncryptedBackupsDYIHandleMessageRestore","MAWJids","MAWJobDefinitions","MAWRestoreProtobufsFromEncryptedBackupsDeferred","Promise","WATagsLogger","asyncToGeneratorRuntime","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["eb restore nativeop - Failed to restore protobufs, with error: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Restoring Messenger DYI batch"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["eb restore nativeop - no messages but hasMoreBefore is true"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["eb restore native op - Failed to decode protobufs, with error: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["eb restore nativeop - no decoded messages but hasMoreBefore is true, messages count after decryption: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Restore called with null payload for both echo messages and protobufs"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["starting eb restore - ",""]);p=function(){return a};return a}function a(a,b,c,d,e,f,g,h,i,j,k,l,m,n){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,q,r,s,t,u,v,w,x,y,z){var A;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(A=t)!=null?A:"no_request_id"]).LOG(p(),(A=t)!=null?A:"no_request_id");if(e==null&&w==null){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(A=t)!=null?A:"no_request_id"]).ERROR(o());d("MAWEBRestoreTrackingUtils").markEBRestoreFail(t,!1,"invalid_restore_payload");return(i||(i=b("Promise"))).resolve()}var B=e!=null?z!=null?"mixed":"protobuf":"echo";A=[];e!=null&&A.push.apply(A,d("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(e));if(z||e===null){z=null;w!=null&&(z=d("LSProtobufRestoreHandler").convertLSEchoMessageVecToArray(w));if(z!=null){w=(yield d("MAWBridgeSafeActionsWorkerAndUI").sendAndReceiveBackendWorkerAndUIShared("convertEchoMessagesToEBProtobufs",{chatJid:y,encodedEchoMessages:z}));A.push.apply(A,w)}}d("MAWEncryptedBackupUtils").logIfDuplicateMessagesFoundInRestore(A,"protobuf_restore");if(t!=null)try{d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_start_unified",traceId:t,type:B});z=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());w=d("MAWEBUnstoredDbMsgUtils").getUnstoredDbMsgFromProtobuf(A,a,void 0,z);if(f===!0&&w.length===0){d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"hasMoreBefore_decodedMessages_inconsistency",traceId:t,type:B});z=e!=null?c("LSVec").toArray(e).length:0;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(e=t)!=null?e:"no_request_id"]).ERROR(n(),z)}d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryIfPresent(t,{echoMessages:void 0,hasMoreAfter:q,hasMoreBefore:f,isPointQuery:s,messages:w,nextMessageTimestampMsBefore:g,protobufMessages:A,referenceTimestamp:u,requestId:t,restoreType:"protobuf",threadId:a})}catch(a){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(e=t)!=null?e:"no_request_id"]).ERROR(m(),a.message)}if(f===!0&&A.length===0){t!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"hasMoreBefore_messages_inconsistency",traceId:t,type:B});d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(z=t)!=null?z:"no_request_id"]).ERROR(l())}w=x!=null&&(h||(h=d("LSIntEnum"))).unwrapIntEnum(x)===c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB;if(w){t!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"search_restore_end",traceId:t,type:B});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(t);return(i||(i=b("Promise"))).resolve()}e=x!=null&&(h||(h=d("LSIntEnum"))).unwrapIntEnum(x)===c("LSMEBTaskCreationSource").MSGR_DYI;if(e){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(z=t)!=null?z:"no_request_id"]).LOG(k());yield d("MAWEncryptedBackupsDYIHandleMessageRestore").handleMAWProtobufMessageRangeQueryRestore(a,A,f,g);t!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"dyi_restore_end",traceId:t,type:B});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(t);return(i||(i=b("Promise"))).resolve()}c("promiseDone")(d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(a),A,f,g,q,r,s,t,u,v,void 0,x,void 0,y),function(){t!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_end_unified",traceId:t,type:B})},function(a){var b;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(b=t)!=null?b:"no_request_id"]).ERROR(j(),a.message);b={string:{error:a.message}};t!=null&&d("MAWEBRestoreTrackingUtils").markEBRestoreFail(t,!1,"native_op_reject_unified",b)});return(i||(i=b("Promise"))).resolve()});return q.apply(this,arguments)}g.echoProtobufConsolidatedRestoreHelper=a}),98);
__d("LSEncryptedBackupsClientRestoreState",[],(function(a,b,c,d,e,f){a=Object.freeze({RESTORE_IN_PROGRESS:1,RESTORE_COMPLETE:2});f["default"]=a}),66);
__d("LSRestoreProtobufs.nop",["LSProtobufRestoreHandler","MAWThreadIdToChatJidMapping","WAJids","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g,h,i,j,k,l,m,n,o,p){b=null;p!=null&&(b=d("WAJids").validateChatJid(p));b==null&&(b=(yield d("MAWThreadIdToChatJidMapping").genChatJidFromThreadId(a,c,"LSRestoreProtobufs.nop")));return d("LSProtobufRestoreHandler").handleProtobufRestoreHelper(c,e,void 0,f,g,h,i,j,k,l,m,n,o,b)});function c(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){return a.apply(this,arguments)}return c}();a.__nop_name__="LSRestoreProtobufs";g["default"]=a}),98);
__d("MAWBridgeTraceRecordCheckpointHandler",["I64","LSAppendDataTraceAddonStoredProcedure","LSFactory","LSFlushDataTrace.nop"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){var e=b.checkPointId,f=b.dataTraceId,g=b.errorMessage,i=b.tags;return c("LSAppendDataTraceAddonStoredProcedure")(c("LSFactory")(a),{checkPointId:e,dataTraceId:f,errorMessage:g,syncChannel:(h||(h=d("I64"))).neg_one,tags:i}).then(function(){if(b.shouldFlush)return c("LSFlushDataTrace.nop")(a,0,f)})}g.call=a}),98);
__d("MAWRestoreProtobufsFromEncryptedBackupsNOP",["ExecutionEnvironment","I64","LSDataTraceCheckPoint","LSIntEnum","LSMEBTaskCreationSource","MAWBridgeTraceRecordCheckpointHandler","MAWJobDefinitions","MAWJobManager","MAWMediaGalleryM2Utils","Promise","Random","WAJobOrchestratorTypes","asyncToGeneratorRuntime","cr:9466","err","ifRequireable","justknobx","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;function a(a,b,c,d,e,f,g,h,i,j,k,m,n,o,p,q){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,h,i,l,n,o,p,q,r,s,t,u,v){u===void 0&&(u=d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION);try{i=q!=null?Number(q):void 0;n=b("cr:9466")!=null?c("justknobx")._("2620"):0;r=d("Random").coinflip(n);n=b("cr:9466")!=null&&r?b("cr:9466").getMessageMetadataFromDeanonAPI(f,g.length,i):(k||(k=b("Promise"))).resolve();return n.then(function(a){return m(e,f,s,g,h,l,o,p,q,t==null?void 0:t,a,u,v)})}catch(e){if(p!=null)return d("MAWBridgeTraceRecordCheckpointHandler").call(a,{checkPointId:(j||(j=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").FLOW_END_FOR_FAILURE),dataTraceId:p,errorMessage:e,shouldFlush:!0,syncChannel:-1,tags:void 0}).then(function(){return(k||(k=b("Promise"))).reject(e)})}return(k||(k=b("Promise"))).resolve()});return l.apply(this,arguments)}function m(a,e,f,g,l,m,n,o,p,q,r,s,t){s===void 0&&(s=d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION);var u;if((h||(h=c("ExecutionEnvironment"))).isInWorker)u=d("MAWJobManager").getJobManager();else{var v;c("ifRequireable")("MAWTimedJob",function(a){a=a.TimedUIJobStarters;v=a},function(){throw c("err")("MAWTimedJob is not requireable in MAWRestoreProtobufsFromEncryptedBackupsNOP")});u=c("nullthrows")(v,"ifRequireable is not sync")}if(o!=null&&q!=null&&(j||(j=d("LSIntEnum"))).unwrapIntEnum(q)===c("LSMEBTaskCreationSource").MESSENGER_MESSAGE_LIST_PAGINATION&&!(h||(h=c("ExecutionEnvironment"))).isInWorker){var w;return u.waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.restoreProtobufsFromEncryptedBackups(f,a,e,g,l,m,n,void 0,(w=o)!=null?w:void 0,(w=p)!=null?w:void 0,void 0,{priority:s},q,r,void 0,(w=t)!=null?w:void 0))}if((j||(j=d("LSIntEnum"))).unwrapIntEnum(q||(i||(i=d("I64"))).zero)===c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE&&d("MAWMediaGalleryM2Utils").shouldSkipSyncToLSDB()&&!(h||(h=c("ExecutionEnvironment"))).isInWorker){return u.waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.restoreProtobufsFromEncryptedBackups(f,a,e,g,l,m,n,void 0,(s=o)!=null?s:void 0,(w=p)!=null?w:void 0,void 0,{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION},q,r,void 0,(s=t)!=null?s:void 0))}return(k||(k=b("Promise"))).resolve(u.fireAndForget(d("MAWJobDefinitions").jobSerializers.restoreProtobufsFromEncryptedBackups(f,a,e,g,l,m,n,void 0,(w=o)!=null?w:void 0,(s=p)!=null?s:void 0,void 0,{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION},q,r,void 0,(u=t)!=null?u:void 0)))}g.call=a}),98);